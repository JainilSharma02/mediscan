<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MediScan AI ‚Äî Smart Medicine Intelligence</title>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SUPABASE INTEGRATION
     Replace SUPABASE_URL and SUPABASE_ANON_KEY below
     with your project values from:
     https://supabase.com/dashboard ‚Üí Settings ‚Üí API
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚îÄ‚îÄ CONFIGURE YOUR SUPABASE PROJECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPABASE_URL  = 'https://bputeunkeimbjuyxfynr.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwdXRldW5rZWltYmp1eXhmeW5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNzM5NzMsImV4cCI6MjA4Nzc0OTk3M30.BxWNkko3acIeFHCzKtkxUpeUOmPq9y6rZI843qB7QTg';
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const _sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// ‚îÄ‚îÄ Convenience helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/** Fetch the logged-in user's profile row */
async function sbGetProfile(userId) {
  const { data, error } = await _sb
    .from('profiles')
    .select('*')
    .eq('id', userId)
    .single();
  if(error) console.warn('sbGetProfile:', error.message);
  return data || null;
}

/** Upsert (create or update) a profile row */
async function sbUpsertProfile(profile) {
  const { error } = await _sb
    .from('profiles')
    .upsert(profile, { onConflict: 'id' });
  if(error) console.warn('sbUpsertProfile:', error.message);
}

/** Load scans for the current user */
async function sbLoadScans(userId) {
  const { data, error } = await _sb
    .from('scans')
    .select('*')
    .eq('user_id', userId)
    .order('created_at', { ascending: false });
  if(error) console.warn('sbLoadScans:', error.message);
  return data || [];
}

/** Insert a new scan record */
async function sbInsertScan(userId, medicine, source) {
  const { data, error } = await _sb
    .from('scans')
    .insert({ user_id: userId, medicine, source })
    .select()
    .single();
  if(error) console.warn('sbInsertScan:', error.message);
  return data || null;
}

/** Load saved medicines for the current user */
async function sbLoadSaved(userId) {
  const { data, error } = await _sb
    .from('saved_medicines')
    .select('*')
    .eq('user_id', userId)
    .order('created_at', { ascending: false });
  if(error) console.warn('sbLoadSaved:', error.message);
  return data || [];
}

/** Save (bookmark) a medicine */
async function sbSaveMedicine(userId, name) {
  const { error } = await _sb
    .from('saved_medicines')
    .upsert({ user_id: userId, name }, { onConflict: 'user_id,name' });
  if(error) console.warn('sbSaveMedicine:', error.message);
}

/** Remove a saved medicine */
async function sbRemoveSaved(userId, name) {
  const { error } = await _sb
    .from('saved_medicines')
    .delete()
    .eq('user_id', userId)
    .eq('name', name);
  if(error) console.warn('sbRemoveSaved:', error.message);
}

/** Insert appointment */
async function sbInsertAppointment(apt) {
  const { data, error } = await _sb
    .from('appointments')
    .insert(apt)
    .select()
    .single();
  if(error) console.warn('sbInsertAppointment:', error.message);
  return data || null;
}

/** Load all users (admin only) */
async function sbListUsers() {
  const { data, error } = await _sb
    .from('profiles')
    .select('*')
    .order('created_at', { ascending: true });
  if(error) console.warn('sbListUsers:', error.message);
  return data || [];
}

/** Convert a Supabase profile row ‚Üí app user object */
function profileToUser(sbUser, profile) {
  return {
    id:         sbUser.id,
    email:      sbUser.email,
    name:       profile?.name       || sbUser.email.split('@')[0],
    phone:      profile?.phone      || '',
    age:        profile?.age        || null,
    dob:        profile?.dob        || '',
    ageGroup:   profile?.age_group  || 'adult',
    gender:     profile?.gender     || '',
    location:   profile?.location   || '',
    lat:        profile?.lat        || null,
    lng:        profile?.lng        || null,
    city:       profile?.city       || '',
    allergies:  profile?.allergies  || '',
    conditions: profile?.conditions || '',
    bloodGroup: profile?.blood_group|| '',
    role:       profile?.role       || 'user',
    created_at: sbUser.created_at   || new Date().toISOString(),
  };
}

/** Convert app user object ‚Üí Supabase profile row */
function userToProfile(user) {
  return {
    id:          user.id,
    name:        user.name,
    phone:       user.phone        || '',
    age:         user.age          || null,
    dob:         user.dob          || null,
    age_group:   user.ageGroup     || 'adult',
    gender:      user.gender       || '',
    location:    user.location     || '',
    lat:         user.lat          || null,
    lng:         user.lng          || null,
    city:        user.city         || '',
    allergies:   user.allergies    || '',
    conditions:  user.conditions   || '',
    blood_group: user.bloodGroup   || '',
    role:        user.role         || 'user',
  };
}
</script>
<style>
  :root {
    --primary: #0066CC;
    --primary-dark: #004A99;
    --primary-light: #E8F2FF;
    --accent: #00B4D8;
    --success: #10B981;
    --warning: #F59E0B;
    --danger: #EF4444;
    --text: #1A202C;
    --text-muted: #64748B;
    --border: #E2E8F0;
    --bg: #F0F6FF;
    --card: #FFFFFF;
    --shadow: 0 4px 24px rgba(0,102,204,0.08);
    --shadow-lg: 0 12px 48px rgba(0,102,204,0.14);
    --radius: 16px;
    --radius-sm: 10px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Segoe UI',system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

  /* ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ */
  nav {
    background: linear-gradient(135deg,#0066CC,#0099FF);
    padding: 0 2rem;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px; position: sticky; top:0; z-index:100;
    box-shadow: 0 2px 20px rgba(0,102,204,0.3);
  }
  .nav-logo { display:flex; align-items:center; gap:.6rem; color:#fff; font-size:1.3rem; font-weight:700; text-decoration:none; }
  .nav-logo svg { width:32px; height:32px; }
  .nav-links { display:flex; gap:.5rem; align-items:center; }
  .nav-links a, .nav-btn {
    color:rgba(255,255,255,0.85); text-decoration:none; padding:.4rem .9rem;
    border-radius:8px; font-size:.88rem; font-weight:500; cursor:pointer;
    border:none; background:none; transition:.2s;
  }
  .nav-links a:hover, .nav-btn:hover { background:rgba(255,255,255,0.15); color:#fff; }
  .nav-btn.primary { background:#fff; color:var(--primary); font-weight:600; }
  .nav-btn.primary:hover { background:#e8f2ff; }
  .nav-avatar { width:36px; height:36px; border-radius:50%; background:rgba(255,255,255,0.25); display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:700; color:#fff; border:2px solid rgba(255,255,255,0.4); }

  /* ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ */
  .page { display:none; min-height:calc(100vh - 64px); }
  .page.active { display:block; }

  /* ‚îÄ‚îÄ‚îÄ HERO ‚îÄ‚îÄ‚îÄ */
  .hero {
    background: linear-gradient(135deg, #004A99 0%, #0066CC 50%, #0099FF 100%);
    color: #fff; text-align:center; padding: 5rem 2rem 4rem;
    position:relative; overflow:hidden;
  }
  .hero > * { position:relative; z-index:2; }
  .hero::before {
    content:''; position:absolute; inset:0; pointer-events:none;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.04'%3E%3Ccircle cx='30' cy='30' r='20'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  }
  .hero-badge { display:inline-flex; align-items:center; gap:.5rem; background:rgba(255,255,255,0.15); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,0.25); border-radius:100px; padding:.4rem 1rem; font-size:.82rem; margin-bottom:1.5rem; }
  .hero h1 { font-size:clamp(2rem,5vw,3.5rem); font-weight:800; line-height:1.1; margin-bottom:1rem; }
  .hero h1 span { color:#7DD3FC; }
  .hero p { font-size:1.1rem; opacity:.85; max-width:560px; margin:0 auto 2rem; line-height:1.7; }
  .hero-btns { display:flex; gap:1rem; justify-content:center; flex-wrap:wrap; position:relative; z-index:2; }
  .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.75rem 1.75rem; border-radius:12px; font-weight:600; font-size:.95rem; cursor:pointer; border:none; transition:.2s; text-decoration:none; }
  .btn-white { background:#fff; color:var(--primary); }
  .btn-white:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.15); }
  .btn-outline-white { background:transparent; color:#fff; border:2px solid rgba(255,255,255,0.5); }
  .btn-outline-white:hover { background:rgba(255,255,255,0.1); }
  .btn-primary { background:var(--primary); color:#fff; }
  .btn-primary:hover { background:var(--primary-dark); transform:translateY(-1px); }
  .btn-accent { background:var(--accent); color:#fff; }
  .btn-success { background:var(--success); color:#fff; }
  .btn-danger { background:var(--danger); color:#fff; }

  .hero-stats { display:flex; gap:3rem; justify-content:center; margin-top:3rem; flex-wrap:wrap; }
  .hero-stat { text-align:center; }
  .hero-stat .num { font-size:2rem; font-weight:800; }
  .hero-stat .lbl { font-size:.8rem; opacity:.7; text-transform:uppercase; letter-spacing:.05em; }

  /* ‚îÄ‚îÄ‚îÄ FEATURES ‚îÄ‚îÄ‚îÄ */
  .section { padding:4rem 2rem; max-width:1200px; margin:0 auto; }
  .section-title { text-align:center; font-size:1.8rem; font-weight:700; margin-bottom:.5rem; }
  .section-sub { text-align:center; color:var(--text-muted); margin-bottom:2.5rem; }
  .feature-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1.5rem; }
  .feature-card {
    background:var(--card); border-radius:var(--radius); padding:1.75rem;
    box-shadow:var(--shadow); border:1px solid var(--border);
    transition:.2s; cursor:pointer;
  }
  .feature-card:hover { transform:translateY(-4px); box-shadow:var(--shadow-lg); }
  .feature-icon { width:52px; height:52px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:1.5rem; margin-bottom:1rem; }
  .feature-card h3 { font-size:1.05rem; font-weight:700; margin-bottom:.4rem; }
  .feature-card p { font-size:.88rem; color:var(--text-muted); line-height:1.6; }

  /* ‚îÄ‚îÄ‚îÄ SCANNER ‚îÄ‚îÄ‚îÄ */
  .scanner-container { max-width:900px; margin:0 auto; padding:2rem; }
  .scan-card { background:var(--card); border-radius:var(--radius); padding:2rem; box-shadow:var(--shadow); border:1px solid var(--border); margin-bottom:1.5rem; }
  .scan-card h2 { font-size:1.3rem; font-weight:700; margin-bottom:1.5rem; display:flex; align-items:center; gap:.6rem; }
  .drop-zone {
    border:2.5px dashed var(--primary); border-radius:var(--radius); padding:3rem 2rem;
    text-align:center; cursor:pointer; transition:.2s; background:var(--primary-light);
    position:relative;
  }
  .drop-zone:hover, .drop-zone.dragging { background:#dbeafe; border-color:var(--primary-dark); }
  .drop-zone input { position:absolute; inset:0; opacity:0; cursor:pointer; }
  .drop-icon { font-size:3rem; margin-bottom:1rem; }
  .drop-zone h3 { font-size:1.1rem; font-weight:600; color:var(--primary); }
  .drop-zone p { color:var(--text-muted); font-size:.88rem; margin-top:.3rem; }
  .or-divider { text-align:center; color:var(--text-muted); margin:1.2rem 0; font-size:.88rem; position:relative; }
  .or-divider::before,.or-divider::after { content:''; position:absolute; top:50%; width:45%; height:1px; background:var(--border); }
  .or-divider::before { left:0; } .or-divider::after { right:0; }
  #cameraFeed { width:100%; border-radius:12px; display:none; background:#000; max-height:300px; object-fit:cover; }
  #cameraFeed.active { display:block; }
  .camera-controls { display:flex; gap:1rem; justify-content:center; margin-top:1rem; }
  #previewImg { max-width:100%; border-radius:12px; display:none; margin:1rem auto; max-height:280px; object-fit:contain; }
  #previewImg.active { display:block; }
  .scan-progress { display:none; }
  .scan-progress.active { display:block; }
  .progress-steps { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .step { display:flex; align-items:center; gap:.4rem; font-size:.83rem; padding:.35rem .8rem; border-radius:100px; background:var(--border); color:var(--text-muted); }
  .step.done { background:#d1fae5; color:#065f46; }
  .step.active { background:var(--primary-light); color:var(--primary); }
  .step.loading { background:#fef3c7; color:#92400e; }
  .progress-bar-wrap { height:6px; background:var(--border); border-radius:100px; margin:1rem 0; overflow:hidden; }
  .progress-bar { height:100%; background:linear-gradient(90deg,var(--primary),var(--accent)); border-radius:100px; transition:width .4s; }

  /* ‚îÄ‚îÄ‚îÄ MEDICINE INFO ‚îÄ‚îÄ‚îÄ */
  .medicine-result { display:none; }
  .medicine-result.active { display:block; }
  .med-header { background:linear-gradient(135deg,#0066CC,#0099FF); color:#fff; border-radius:var(--radius); padding:2rem; margin-bottom:1.5rem; }
  .med-header-top { display:flex; align-items:flex-start; justify-content:space-between; gap:1rem; flex-wrap:wrap; }
  .med-name { font-size:1.8rem; font-weight:800; }
  .med-brand { font-size:.9rem; opacity:.8; margin-top:.2rem; }
  .med-badges { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.8rem; }
  .badge { padding:.25rem .7rem; border-radius:100px; font-size:.75rem; font-weight:600; }
  .badge-rx { background:#fff; color:var(--primary); }
  .badge-otc { background:rgba(255,255,255,0.2); color:#fff; border:1px solid rgba(255,255,255,0.4); }
  .badge-danger { background:#fef2f2; color:#dc2626; border:1px solid #fca5a5; }
  .badge-warning { background:#fffbeb; color:#d97706; border:1px solid #fcd34d; }
  .badge-success { background:#f0fdf4; color:#16a34a; border:1px solid #86efac; }
  .med-quick { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:1rem; margin-top:1.2rem; }
  .med-quick-item { background:rgba(255,255,255,0.15); backdrop-filter:blur(4px); border-radius:12px; padding:.9rem; text-align:center; }
  .med-quick-item .val { font-size:1.3rem; font-weight:700; }
  .med-quick-item .key { font-size:.72rem; opacity:.75; text-transform:uppercase; letter-spacing:.05em; margin-top:.2rem; }
  .info-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:1.5rem; }
  .info-card { background:var(--card); border-radius:var(--radius); padding:1.5rem; box-shadow:var(--shadow); border:1px solid var(--border); }
  .info-card h3 { font-size:1rem; font-weight:700; margin-bottom:1rem; display:flex; align-items:center; gap:.5rem; }
  .info-card h3 .ico { width:30px; height:30px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:.95rem; }
  .tag-list { display:flex; flex-wrap:wrap; gap:.5rem; }
  .tag { padding:.3rem .8rem; border-radius:8px; font-size:.8rem; font-weight:500; }
  .tag-blue { background:var(--primary-light); color:var(--primary); }
  .tag-green { background:#d1fae5; color:#065f46; }
  .tag-red { background:#fee2e2; color:#dc2626; }
  .tag-yellow { background:#fef3c7; color:#92400e; }
  .tag-purple { background:#ede9fe; color:#6d28d9; }
  .alert-box { border-radius:12px; padding:1rem 1.2rem; margin-bottom:1rem; display:flex; gap:.8rem; align-items:flex-start; font-size:.88rem; }
  .alert-danger { background:#fef2f2; border:1px solid #fca5a5; color:#dc2626; }
  .alert-warning { background:#fffbeb; border:1px solid #fcd34d; color:#d97706; }
  .alert-success { background:#f0fdf4; border:1px solid #86efac; color:#16a34a; }
  .alert-info { background:var(--primary-light); border:1px solid #bfdbfe; color:var(--primary); }
  .dosage-table { width:100%; border-collapse:collapse; font-size:.88rem; }
  .dosage-table th { background:var(--bg); padding:.6rem .8rem; text-align:left; font-weight:600; color:var(--text-muted); font-size:.78rem; text-transform:uppercase; letter-spacing:.04em; }
  .dosage-table td { padding:.7rem .8rem; border-bottom:1px solid var(--border); }
  .dosage-table tr:last-child td { border-bottom:none; }
  .person-card { display:flex; align-items:center; gap:.8rem; padding:.8rem; border-radius:10px; border:1px solid var(--border); margin-bottom:.7rem; }
  .person-icon { width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.2rem; flex-shrink:0; }
  .person-info h4 { font-size:.9rem; font-weight:600; }
  .person-info p { font-size:.78rem; color:var(--text-muted); }
  .se-item { display:flex; align-items:flex-start; gap:.7rem; padding:.7rem; border-radius:10px; background:var(--bg); margin-bottom:.5rem; font-size:.86rem; }
  .se-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; margin-top:4px; }
  .se-common .se-dot { background:var(--warning); }
  .se-serious .se-dot { background:var(--danger); }
  .se-rare .se-dot { background:var(--text-muted); }

  /* ‚îÄ‚îÄ‚îÄ HOSPITALS ‚îÄ‚îÄ‚îÄ */
  .map-placeholder { background:linear-gradient(135deg,#e8f2ff,#dbeafe); border-radius:12px; height:280px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--primary); font-size:3rem; margin-bottom:1.5rem; border:1px dashed var(--primary); }
  .map-placeholder p { font-size:.9rem; margin-top:.5rem; color:var(--text-muted); }

  /* ‚îÄ‚îÄ‚îÄ REAL MAP ‚îÄ‚îÄ‚îÄ */
  #googleMapContainer {
    width:100%; height:380px; border-radius:16px; overflow:hidden;
    border:1px solid var(--border); margin-bottom:1.5rem;
    box-shadow:var(--shadow-lg); position:relative; display:none;
  }
  #googleMapEl { width:100%; height:100%; }
  #mapLoadingOverlay {
    position:absolute; inset:0; background:linear-gradient(135deg,#e8f2ff,#dbeafe);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:.8rem; z-index:10;
  }
  #mapLoadingOverlay .spin {
    width:40px; height:40px; border:3px solid #bfdbfe;
    border-top-color:var(--primary); border-radius:50%;
    animation:spin .8s linear infinite;
  }
  @keyframes spin { to { transform:rotate(360deg); } }
  .map-info-bar {
    display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap;
    gap:.6rem; background:#fff; border:1px solid var(--border);
    border-radius:12px; padding:.8rem 1.1rem; margin-bottom:1.2rem;
    font-size:.84rem;
  }
  .map-info-bar .loc-text { font-weight:700; color:var(--primary); display:flex; align-items:center; gap:.4rem; }
  .map-info-bar .map-actions { display:flex; gap:.5rem; flex-wrap:wrap; }

  /* ‚îÄ‚îÄ‚îÄ API KEY PROMPT ‚îÄ‚îÄ‚îÄ */
  #apiKeyPrompt {
    background:linear-gradient(135deg,#fffbeb,#fef3c7);
    border:1.5px solid #fcd34d; border-radius:14px;
    padding:1.2rem 1.4rem; margin-bottom:1.5rem; display:none;
  }
  #apiKeyPrompt.visible { display:block; }
  .location-header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem; margin-bottom:1.5rem; }
  .location-display { display:flex; align-items:center; gap:.5rem; color:var(--text-muted); font-size:.88rem; }
  .hospital-card { background:var(--card); border-radius:var(--radius-sm); padding:1.2rem; box-shadow:var(--shadow); border:1px solid var(--border); margin-bottom:1rem; display:flex; gap:1rem; align-items:flex-start; }
  .hosp-icon { width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.4rem; flex-shrink:0; }
  .hosp-info h3 { font-size:1rem; font-weight:700; margin-bottom:.2rem; }
  .hosp-info .hosp-meta { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.5rem; }
  .hosp-meta-item { font-size:.78rem; color:var(--text-muted); display:flex; align-items:center; gap:.3rem; }
  .hosp-rating { display:flex; align-items:center; gap:.2rem; font-size:.82rem; font-weight:600; color:#f59e0b; }
  .doctor-card { background:var(--card); border-radius:var(--radius-sm); padding:1.2rem; box-shadow:var(--shadow); border:1px solid var(--border); margin-bottom:1rem; display:flex; gap:1rem; align-items:flex-start; }
  .doctor-avatar { width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; font-weight:700; color:#fff; flex-shrink:0; }
  .doc-info h3 { font-size:1rem; font-weight:700; }
  .doc-spec { font-size:.82rem; color:var(--primary); font-weight:600; margin-top:.1rem; }
  .doc-meta { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.5rem; }

  /* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */
  .auth-wrapper { display:flex; min-height:calc(100vh - 64px); }
  .auth-left { flex:1; background:linear-gradient(135deg,#004A99,#0066CC,#0099FF); color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:3rem; }
  .auth-left h2 { font-size:2rem; font-weight:800; margin-bottom:.8rem; }
  .auth-left p { opacity:.8; line-height:1.7; max-width:360px; text-align:center; }
  .auth-features { margin-top:2rem; display:flex; flex-direction:column; gap:.8rem; }
  .auth-feature { display:flex; align-items:center; gap:.8rem; font-size:.9rem; }
  .auth-feature .ico { width:28px; height:28px; background:rgba(255,255,255,0.2); border-radius:8px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .auth-right { flex:1; display:flex; align-items:center; justify-content:center; padding:2rem; background:#fff; }
  .auth-form-box { width:100%; max-width:420px; }
  .auth-form-box h2 { font-size:1.5rem; font-weight:800; margin-bottom:.3rem; }
  .auth-form-box p { color:var(--text-muted); font-size:.9rem; margin-bottom:2rem; }
  .form-group { margin-bottom:1.2rem; }
  .form-group label { display:block; font-size:.85rem; font-weight:600; margin-bottom:.4rem; }
  .form-group input, .form-group select {
    width:100%; padding:.75rem 1rem; border:1.5px solid var(--border); border-radius:10px;
    font-size:.95rem; transition:.2s; background:#fff;
  }
  .form-group input:focus, .form-group select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(0,102,204,0.1); }
  .form-group.has-icon { position:relative; }
  .form-group.has-icon input { padding-left:2.6rem; }
  .form-group.has-icon .fi { position:absolute; left:.85rem; top:50%; transform:translateY(-50%); color:var(--text-muted); font-size:.9rem; }
  .otp-inputs { display:flex; gap:.7rem; justify-content:center; }
  .otp-inputs input { width:52px; height:52px; text-align:center; font-size:1.4rem; font-weight:700; padding:0; }
  .auth-switch { text-align:center; margin-top:1.5rem; font-size:.88rem; color:var(--text-muted); }
  .auth-switch a { color:var(--primary); font-weight:600; cursor:pointer; text-decoration:none; }
  .btn-full { width:100%; justify-content:center; padding:.85rem; font-size:1rem; margin-top:.5rem; }
  .divider { text-align:center; color:var(--text-muted); margin:1rem 0; font-size:.82rem; position:relative; }
  .divider::before,.divider::after { content:''; position:absolute; top:50%; width:45%; height:1px; background:var(--border); }
  .divider::before { left:0; } .divider::after { right:0; }

  /* ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ */
  .dashboard-layout { display:grid; grid-template-columns:260px 1fr; min-height:calc(100vh - 64px); }
  .sidebar { background:var(--card); border-right:1px solid var(--border); padding:1.5rem 1rem; }
  .sidebar-profile { text-align:center; padding:1rem; margin-bottom:1.5rem; }
  .sidebar-avatar { width:72px; height:72px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--accent)); color:#fff; display:flex; align-items:center; justify-content:center; font-size:1.7rem; font-weight:700; margin:0 auto .8rem; }
  .sidebar-name { font-weight:700; font-size:1rem; }
  .sidebar-email { font-size:.78rem; color:var(--text-muted); }
  .sidebar-nav { list-style:none; }
  .sidebar-nav li a { display:flex; align-items:center; gap:.7rem; padding:.7rem .9rem; border-radius:10px; color:var(--text-muted); text-decoration:none; font-size:.9rem; font-weight:500; transition:.15s; cursor:pointer; }
  .sidebar-nav li a:hover { background:var(--bg); color:var(--text); }
  .sidebar-nav li a.active { background:var(--primary-light); color:var(--primary); font-weight:600; }
  .sidebar-nav li a .nav-ico { width:28px; text-align:center; }
  .sidebar-section { font-size:.72rem; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:.08em; margin:1.2rem .9rem .4rem; }
  .dash-main { padding:2rem; overflow-y:auto; background:var(--bg); }
  .dash-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:2rem; flex-wrap:wrap; gap:1rem; }
  .dash-header h1 { font-size:1.5rem; font-weight:800; }
  .stats-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem; margin-bottom:2rem; }
  .stat-card { background:var(--card); border-radius:var(--radius-sm); padding:1.2rem; box-shadow:var(--shadow); border:1px solid var(--border); }
  .stat-card .stat-icon { width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.2rem; margin-bottom:.8rem; }
  .stat-card .stat-val { font-size:1.7rem; font-weight:800; }
  .stat-card .stat-lbl { font-size:.78rem; color:var(--text-muted); margin-top:.2rem; }
  .scan-history-item { background:var(--card); border-radius:var(--radius-sm); padding:1rem 1.2rem; box-shadow:var(--shadow); border:1px solid var(--border); margin-bottom:.8rem; display:flex; align-items:center; gap:1rem; }
  .scan-history-item .shi-icon { width:42px; height:42px; border-radius:10px; background:var(--primary-light); display:flex; align-items:center; justify-content:center; font-size:1.1rem; flex-shrink:0; }
  .shi-info h4 { font-size:.95rem; font-weight:600; }
  .shi-info p { font-size:.78rem; color:var(--text-muted); }
  .shi-action { margin-left:auto; }

  /* ‚îÄ‚îÄ‚îÄ AI CHATBOT ‚îÄ‚îÄ‚îÄ */
  .chatbot-fab {
    position:fixed; bottom:2rem; right:2rem; width:58px; height:58px;
    background:linear-gradient(135deg,var(--primary),var(--accent));
    border-radius:50%; display:flex; align-items:center; justify-content:center;
    cursor:pointer; box-shadow:0 6px 28px rgba(0,102,204,0.4); z-index:999;
    border:none; color:#fff; font-size:1.5rem; transition:.25s; position:fixed;
  }
  .chatbot-fab:hover { transform:scale(1.1); box-shadow:0 8px 32px rgba(0,102,204,0.5); }
  .chat-notif {
    position:absolute; top:-2px; right:-2px; width:16px; height:16px;
    background:#ef4444; border-radius:50%; border:2px solid #fff;
    font-size:.6rem; color:#fff; display:flex; align-items:center; justify-content:center;
    font-weight:700;
  }
  .cb-online-dot {
    width:7px; height:7px; background:#4ade80; border-radius:50%; display:inline-block;
    animation: pulse-green 2s infinite;
  }
  @keyframes pulse-green {
    0%,100% { opacity:1; transform:scale(1); }
    50%      { opacity:.6; transform:scale(1.3); }
  }
  .chatbot-panel {
    position:fixed; bottom:5.5rem; right:2rem; width:380px; max-height:560px;
    background:#fff; border-radius:20px; box-shadow:0 24px 64px rgba(0,0,0,.18);
    z-index:998; display:none; flex-direction:column; border:1px solid var(--border);
    overflow:hidden; transition:opacity .2s, transform .2s;
  }
  .chatbot-panel.open { display:flex; }
  .chatbot-header {
    background:linear-gradient(135deg,var(--primary),var(--accent));
    color:#fff; padding:1rem 1.2rem;
    display:flex; align-items:center; justify-content:space-between;
    flex-shrink:0;
  }
  .chatbot-header h4 { font-size:.95rem; font-weight:700; }
  .chatbot-header .cb-close {
    background:rgba(255,255,255,0.15); border:none; color:#fff;
    font-size:1rem; cursor:pointer; padding:.3rem .5rem; border-radius:8px;
  }
  .chatbot-header .cb-close:hover { background:rgba(255,255,255,0.3); }
  .chatbot-messages {
    flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:.7rem;
    scroll-behavior:smooth;
  }
  .chatbot-messages::-webkit-scrollbar { width:4px; }
  .chatbot-messages::-webkit-scrollbar-track { background:#f1f5f9; }
  .chatbot-messages::-webkit-scrollbar-thumb { background:#bfdbfe; border-radius:4px; }
  .cb-msg {
    max-width:88%; padding:.7rem .95rem; border-radius:16px;
    font-size:.84rem; line-height:1.55; word-break:break-word;
  }
  .cb-msg.bot {
    background:#f0f6ff; color:var(--text);
    border-radius:4px 16px 16px 16px; align-self:flex-start;
    border:1px solid #e2e8f0;
  }
  .cb-msg.user {
    background:linear-gradient(135deg,var(--primary),var(--accent));
    color:#fff; border-radius:16px 4px 16px 16px;
    align-self:flex-end;
  }
  .cb-msg.bot strong { color:var(--primary); }
  .cb-msg.bot code {
    background:#e8f2ff; color:var(--primary); padding:.1rem .35rem;
    border-radius:4px; font-size:.8rem; font-family:monospace;
  }
  .cb-msg.bot ul { margin:.4rem 0 .2rem 1.1rem; padding:0; }
  .cb-msg.bot ul li { margin-bottom:.2rem; }
  .cb-msg.error { background:#fef2f2; color:#dc2626; border:1px solid #fca5a5; }
  .cb-timestamp {
    font-size:.68rem; color:var(--text-muted); margin-top:.25rem;
    align-self:flex-end; padding-right:.2rem;
  }
  /* Quick reply chips */
  .cb-quick-replies {
    display:flex; flex-wrap:wrap; gap:.4rem; padding:.2rem 0 .2rem;
  }
  .cb-chip {
    background:#f0f6ff; border:1.5px solid #bfdbfe; color:var(--primary);
    border-radius:20px; padding:.35rem .75rem; font-size:.75rem; font-weight:600;
    cursor:pointer; white-space:nowrap; transition:.15s;
  }
  .cb-chip:hover { background:var(--primary); color:#fff; border-color:var(--primary); }
  /* Typing indicator */
  .cb-typing {
    display:flex; align-items:center; gap:.6rem;
    padding:.5rem 1rem; flex-shrink:0; border-top:1px solid var(--border);
    background:var(--bg);
  }
  .cb-typing-dots {
    display:flex; gap:.3rem; align-items:center;
    background:#f0f6ff; border-radius:12px; padding:.45rem .75rem;
    border:1px solid #e2e8f0;
  }
  .cb-typing-dots span {
    width:7px; height:7px; background:var(--primary); border-radius:50%;
    animation:typing-bounce .9s infinite;
  }
  .cb-typing-dots span:nth-child(2) { animation-delay:.15s; }
  .cb-typing-dots span:nth-child(3) { animation-delay:.3s; }
  @keyframes typing-bounce {
    0%,60%,100% { transform:translateY(0); opacity:.5; }
    30%          { transform:translateY(-5px); opacity:1; }
  }
  /* Input */
  .chatbot-input {
    display:flex; gap:.5rem; padding:.75rem; border-top:1px solid var(--border);
    background:#fff; flex-shrink:0; align-items:center;
  }
  .chatbot-input input {
    flex:1; border:1.5px solid var(--border); border-radius:12px;
    padding:.6rem 1rem; font-size:.88rem; transition:.2s; background:#f9fafb;
  }
  .chatbot-input input:focus {
    outline:none; border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(0,102,204,0.1); background:#fff;
  }
  .chatbot-input button {
    background:linear-gradient(135deg,var(--primary),var(--accent));
    color:#fff; border:none; border-radius:12px;
    width:40px; height:40px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; transition:.2s; flex-shrink:0;
  }
  .chatbot-input button:hover:not(:disabled) { transform:scale(1.05); }
  .chatbot-input button:disabled { opacity:.4; cursor:not-allowed; }

  /* ‚îÄ‚îÄ‚îÄ AI ALERT ‚îÄ‚îÄ‚îÄ */
  .ai-alert-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:500; display:none; align-items:center; justify-content:center; padding:1rem; }
  .ai-alert-overlay.active { display:flex; }
  .ai-alert-box { background:#fff; border-radius:20px; padding:2rem; max-width:460px; width:100%; box-shadow:0 20px 60px rgba(0,0,0,0.25); }
  .ai-alert-box .ai-alert-icon { font-size:2.5rem; text-align:center; margin-bottom:1rem; }
  .ai-alert-box h3 { font-size:1.2rem; font-weight:800; text-align:center; margin-bottom:.5rem; }
  .ai-alert-box p { text-align:center; color:var(--text-muted); font-size:.9rem; line-height:1.6; }
  .ai-alert-actions { display:flex; gap:.8rem; margin-top:1.5rem; }
  .ai-alert-actions .btn { flex:1; justify-content:center; }

  /* ‚îÄ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ */
  .admin-header { background:linear-gradient(135deg,#1e1b4b,#312e81); color:#fff; padding:1.5rem 2rem; margin-bottom:2rem; border-radius:var(--radius); }
  .admin-table { width:100%; border-collapse:collapse; font-size:.88rem; }
  .admin-table th { background:var(--bg); padding:.75rem 1rem; text-align:left; font-weight:600; font-size:.78rem; text-transform:uppercase; color:var(--text-muted); letter-spacing:.04em; }
  .admin-table td { padding:.75rem 1rem; border-bottom:1px solid var(--border); }
  .admin-table tr:hover td { background:#f8fafc; }
  .admin-form-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
  .admin-form-grid .full { grid-column:1/-1; }

  /* ‚îÄ‚îÄ‚îÄ EMERGENCY ‚îÄ‚îÄ‚îÄ */
  .emergency-banner { background:linear-gradient(135deg,#dc2626,#ef4444); color:#fff; padding:1rem 2rem; text-align:center; font-weight:600; font-size:.95rem; display:flex; align-items:center; justify-content:center; gap:.8rem; }
  .pulse { animation:pulse 1.5s infinite; display:inline-block; width:10px; height:10px; background:#fff; border-radius:50%; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.2)} }

  /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
  .toast-container { position:fixed; top:5rem; right:1.5rem; z-index:9999; display:flex; flex-direction:column; gap:.6rem; }
  .toast { background:#fff; border-radius:12px; padding:1rem 1.2rem; box-shadow:0 8px 30px rgba(0,0,0,0.12); border-left:4px solid var(--primary); font-size:.88rem; display:flex; align-items:center; gap:.7rem; min-width:280px; max-width:360px; animation:slideIn .3s; }
  .toast.success { border-color:var(--success); }
  .toast.error { border-color:var(--danger); }
  .toast.warning { border-color:var(--warning); }
  @keyframes slideIn { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
  @keyframes slideOut { from{transform:translateX(0);opacity:1} to{transform:translateX(100%);opacity:0} }
  .toast.removing { animation:slideOut .3s forwards; }

  /* FOOTER */
  footer { background:#fff; border-top:1px solid var(--border); padding:2rem; text-align:center; color:var(--text-muted); font-size:.85rem; margin-top:4rem; }

  /* ‚îÄ‚îÄ‚îÄ SCAN TABS ‚îÄ‚îÄ‚îÄ */
  .scan-tabs { display:flex; gap:0; margin-bottom:1.5rem; background:var(--bg); border-radius:12px; padding:5px; border:1px solid var(--border); }
  .scan-tab {
    flex:1; padding:.6rem .5rem; border:none; border-radius:9px; cursor:pointer;
    font-size:.82rem; font-weight:600; background:transparent; color:var(--text-muted);
    transition:.2s; display:flex; align-items:center; justify-content:center; gap:.4rem;
  }
  .scan-tab.active { background:#fff; color:var(--primary); box-shadow:0 2px 8px rgba(0,102,204,0.12); }
  .scan-tab-panel { display:none; }
  .scan-tab-panel.active { display:block; }

  /* ‚îÄ‚îÄ‚îÄ DESCRIPTION SCANNER ‚îÄ‚îÄ‚îÄ */
  .desc-scanner-wrap { }
  .desc-input-area {
    width:100%; min-height:130px; padding:1rem; border:2px solid var(--border);
    border-radius:14px; font-size:.95rem; font-family:inherit; resize:vertical;
    transition:.2s; line-height:1.6; color:var(--text);
  }
  .desc-input-area:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(0,102,204,0.1); }
  .desc-examples { display:flex; flex-wrap:wrap; gap:.5rem; margin:1rem 0; }
  .desc-example-chip {
    padding:.35rem .85rem; border-radius:100px; background:var(--primary-light);
    color:var(--primary); font-size:.78rem; font-weight:500; cursor:pointer;
    border:1px solid #bfdbfe; transition:.15s;
  }
  .desc-example-chip:hover { background:#bfdbfe; }
  .desc-filter-row { display:flex; gap:.7rem; flex-wrap:wrap; margin-bottom:1rem; }
  .desc-filter-row select {
    padding:.5rem .9rem; border:1.5px solid var(--border); border-radius:10px;
    font-size:.85rem; background:#fff; color:var(--text); cursor:pointer;
  }
  .desc-filter-row select:focus { outline:none; border-color:var(--primary); }

  /* ‚îÄ‚îÄ‚îÄ MATCH RESULTS ‚îÄ‚îÄ‚îÄ */
  .desc-results { display:none; }
  .desc-results.active { display:block; }
  .match-card {
    background:var(--card); border-radius:14px; border:1px solid var(--border);
    box-shadow:var(--shadow); overflow:hidden; margin-bottom:1rem;
    transition:.2s; cursor:pointer;
  }
  .match-card:hover { transform:translateY(-2px); box-shadow:var(--shadow-lg); }
  .match-card-header { padding:1.2rem 1.4rem; display:flex; align-items:center; justify-content:space-between; gap:1rem; }
  .match-info { flex:1; }
  .match-name { font-size:1.1rem; font-weight:800; color:var(--text); }
  .match-brand { font-size:.8rem; color:var(--text-muted); margin-top:.1rem; }
  .match-score-wrap { display:flex; flex-direction:column; align-items:center; gap:.2rem; }
  .match-score-ring {
    width:56px; height:56px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:1rem; font-weight:800; flex-shrink:0;
    border:3px solid;
  }
  .score-high { border-color:var(--success); color:var(--success); background:#f0fdf4; }
  .score-med  { border-color:var(--warning); color:var(--warning); background:#fffbeb; }
  .score-low  { border-color:var(--text-muted); color:var(--text-muted); background:var(--bg); }
  .match-score-lbl { font-size:.68rem; color:var(--text-muted); font-weight:600; text-transform:uppercase; letter-spacing:.04em; }
  .match-card-body { padding:0 1.4rem 1.2rem; }
  .match-tags { display:flex; flex-wrap:wrap; gap:.4rem; margin-bottom:.8rem; }
  .match-why { font-size:.82rem; color:var(--text-muted); line-height:1.6; background:var(--bg); border-radius:10px; padding:.7rem .9rem; }
  .match-why strong { color:var(--primary); }
  .match-actions { display:flex; gap:.6rem; margin-top:.9rem; }
  .match-actions .btn { font-size:.82rem; padding:.45rem 1rem; }
  .desc-loading { display:none; text-align:center; padding:2.5rem 1rem; }
  .desc-loading.active { display:block; }
  .ai-thinking { display:inline-flex; align-items:center; gap:.7rem; font-size:.95rem; color:var(--primary); font-weight:600; }
  .dot-blink span { width:8px; height:8px; border-radius:50%; background:var(--primary); display:inline-block; animation:blink 1.2s infinite; margin:0 2px; }
  .dot-blink span:nth-child(2) { animation-delay:.2s; }
  .dot-blink span:nth-child(3) { animation-delay:.4s; }
  @keyframes blink { 0%,80%,100%{opacity:.2;transform:scale(.9)} 40%{opacity:1;transform:scale(1)} }
  .no-results-box { text-align:center; padding:2.5rem 1rem; color:var(--text-muted); }
  .no-results-box .nr-icon { font-size:3rem; margin-bottom:.8rem; }
  .symptom-highlight { background:#fef9c3; border-radius:4px; padding:0 3px; font-weight:600; color:#854d0e; }

  /* ‚îÄ‚îÄ‚îÄ BIRTHDAY / AGE ‚îÄ‚îÄ‚îÄ */
  .dob-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:.6rem; }
  .age-preview {
    display:none; margin-top:.6rem; padding:.7rem 1rem;
    background: linear-gradient(135deg,#e0f2fe,#dbeafe);
    border-radius:10px; border:1px solid #bfdbfe;
    font-size:.85rem; align-items:center; gap:.8rem;
  }
  .age-preview.show { display:flex; }
  .age-preview .age-num { font-size:1.6rem; font-weight:800; color:var(--primary); line-height:1; }
  .age-preview .age-info { flex:1; }
  .age-preview .age-group-badge {
    padding:.3rem .75rem; border-radius:100px; font-size:.75rem; font-weight:700;
  }
  .agb-child   { background:#dbeafe; color:#1d4ed8; }
  .agb-adult   { background:#d1fae5; color:#065f46; }
  .agb-elderly { background:#fef3c7; color:#92400e; }

  /* ‚îÄ‚îÄ‚îÄ PERSONALIZED DOSAGE CARD ‚îÄ‚îÄ‚îÄ */
  .my-dose-card {
    background: linear-gradient(135deg,#0066CC,#0099FF);
    border-radius:14px; padding:1.2rem 1.4rem; margin-bottom:1.5rem;
    color:#fff; display:flex; align-items:center; gap:1rem; flex-wrap:wrap;
  }
  .my-dose-icon { font-size:2.4rem; flex-shrink:0; }
  .my-dose-info { flex:1; }
  .my-dose-info h4 { font-size:.82rem; font-weight:600; opacity:.85; text-transform:uppercase; letter-spacing:.05em; }
  .my-dose-info .dose-val { font-size:1.4rem; font-weight:800; margin:.2rem 0; }
  .my-dose-info .dose-sub { font-size:.8rem; opacity:.8; }
  .my-dose-badges { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem; }
  .my-dose-badge { background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3); border-radius:8px; padding:.25rem .7rem; font-size:.75rem; font-weight:600; }
  .dose-row-highlight { background:var(--primary-light) !important; font-weight:700; }
  .dose-row-highlight td { color:var(--primary) !important; }

  /* ‚îÄ‚îÄ‚îÄ AGE GROUP INDICATOR ON MEDICINE ‚îÄ‚îÄ‚îÄ */
  .age-indicator-strip {
    border-radius:12px; padding:.9rem 1.2rem; margin-bottom:1.2rem;
    display:flex; align-items:center; gap:.9rem; font-size:.88rem; flex-wrap:wrap;
  }
  .age-indicator-strip .ais-icon { font-size:1.8rem; flex-shrink:0; }
  .age-indicator-strip strong { display:block; font-size:1rem; margin-bottom:.1rem; }

  /* ‚îÄ‚îÄ‚îÄ DISEASE CHIPS ‚îÄ‚îÄ‚îÄ */
  .disease-chip {
    display:inline-flex; align-items:center; gap:.4rem;
    padding:.45rem .9rem; border-radius:100px; border:1.5px solid;
    font-size:.8rem; font-weight:600; cursor:pointer; transition:.2s;
  }
  .disease-chip:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.1); }
  .disease-chip.selected { color:#fff !important; }

  /* ‚îÄ‚îÄ‚îÄ NEARBY FILTER ‚îÄ‚îÄ‚îÄ */
  .nearby-filter-btn {
    padding:.4rem .9rem; border-radius:100px; border:1.5px solid var(--border);
    background:#fff; color:var(--text-muted); font-size:.8rem; font-weight:600;
    cursor:pointer; transition:.2s;
  }
  .nearby-filter-btn:hover { border-color:var(--primary); color:var(--primary); }
  .nearby-filter-btn.active { background:var(--primary); color:#fff; border-color:var(--primary); }

  /* ‚îÄ‚îÄ‚îÄ ADVANTAGES / DISADVANTAGES ‚îÄ‚îÄ‚îÄ */
  .adv-disadv-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:.5rem; }
  @media(max-width:600px) { .adv-disadv-grid { grid-template-columns:1fr; } }
  .adv-box { border-radius:12px; padding:1rem; }
  .adv-box.pros { background:#f0fdf4; border:1px solid #86efac; }
  .adv-box.cons { background:#fef2f2; border:1px solid #fca5a5; }
  .adv-box h4 { font-size:.88rem; font-weight:700; margin-bottom:.6rem; }
  .adv-box.pros h4 { color:#16a34a; }
  .adv-box.cons h4 { color:#dc2626; }
  .adv-item { display:flex; align-items:flex-start; gap:.5rem; font-size:.82rem; color:var(--text); margin-bottom:.4rem; line-height:1.5; }

  /* ‚îÄ‚îÄ‚îÄ WORD SELECTION TOOLTIP ‚îÄ‚îÄ‚îÄ */
  #selectionTooltip {
    position:fixed; z-index:9999; background:#1e293b; color:#fff;
    padding:.5rem 1rem; border-radius:10px; font-size:.82rem; font-weight:600;
    pointer-events:none; display:none; box-shadow:0 8px 24px rgba(0,0,0,.3);
    transform:translateY(-110%); white-space:nowrap;
  }
  #selectionTooltip button {
    background:var(--primary); color:#fff; border:none; border-radius:6px;
    padding:.25rem .6rem; font-size:.75rem; font-weight:700; cursor:pointer;
    margin-left:.5rem; pointer-events:all;
  }
  #selectionTooltip::after {
    content:''; position:absolute; bottom:-6px; left:50%; transform:translateX(-50%);
    border:6px solid transparent; border-top-color:#1e293b; border-bottom:none;
  }

  /* ‚îÄ‚îÄ‚îÄ DISEASE RESULT CARD ‚îÄ‚îÄ‚îÄ */
  .disease-result-card {
    background:var(--card); border-radius:16px; border:1px solid var(--border);
    box-shadow:var(--shadow-lg); overflow:hidden; margin-top:1rem;
  }
  .disease-result-header {
    padding:1.2rem 1.4rem; display:flex; align-items:center; gap:1rem; flex-wrap:wrap;
  }
  .disease-icon-big { font-size:2.5rem; flex-shrink:0; }
  .disease-result-body { padding:1.2rem 1.4rem; }

  /* ‚îÄ‚îÄ‚îÄ APPOINTMENT TIME SLOTS ‚îÄ‚îÄ‚îÄ */
  .time-slot {
    padding:.4rem .9rem; border-radius:8px; border:1.5px solid var(--border);
    background:#fff; font-size:.8rem; font-weight:600; cursor:pointer;
    color:var(--text-muted); transition:.15s;
  }
  .time-slot:hover { border-color:var(--primary); color:var(--primary); }
  .time-slot.selected { background:var(--primary); color:#fff; border-color:var(--primary); }
  .time-slot.unavailable { background:#f1f5f9; color:#cbd5e1; cursor:not-allowed; text-decoration:line-through; }

  /* ‚îÄ‚îÄ‚îÄ CALL MODAL DETAILS ‚îÄ‚îÄ‚îÄ */
  .call-detail-row { display:flex; align-items:center; gap:.6rem; padding:.4rem 0; font-size:.85rem; }
  .call-detail-row .lbl { color:var(--text-muted); min-width:80px; }
  .call-detail-row .val { font-weight:600; color:var(--text); }

  /* ‚îÄ‚îÄ‚îÄ DETECT BTN SPINNER ‚îÄ‚îÄ‚îÄ */
  .btn-spinner {
    width:14px; height:14px; border:2px solid rgba(255,255,255,0.4);
    border-top-color:#fff; border-radius:50%;
    display:inline-block; animation:spin .7s linear infinite;
  }

  /* ‚îÄ‚îÄ‚îÄ REGISTER LOCATION ‚îÄ‚îÄ‚îÄ */
  .reg-loc-suggestion {
    padding:.7rem 1rem; cursor:pointer; font-size:.85rem; border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:.5rem; transition:.15s;
  }
  .reg-loc-suggestion:last-child { border-bottom:none; }
  .reg-loc-suggestion:hover { background:var(--primary-light); color:var(--primary); }
  .reg-loc-status { display:flex; align-items:center; gap:.6rem; padding:.55rem .9rem; border-radius:10px; font-size:.82rem; font-weight:600; }
  .reg-loc-status.success { background:#f0fdf4; color:#16a34a; border:1px solid #86efac; }
  .reg-loc-status.loading { background:#f0f6ff; color:var(--primary); border:1px solid #bfdbfe; }
  .reg-loc-status.error   { background:#fef2f2; color:#dc2626; border:1px solid #fca5a5; }
  .reg-nearby-card {
    display:flex; align-items:center; gap:.8rem; padding:.7rem .9rem;
    background:#fff; border-radius:10px; border:1px solid var(--border);
    margin-bottom:.5rem; font-size:.83rem;
  }
  .reg-nearby-card:last-child { margin-bottom:0; }
  .reg-nearby-icon { font-size:1.4rem; flex-shrink:0; }
  .reg-nearby-info { flex:1; min-width:0; }
  .reg-nearby-info strong { display:block; font-size:.86rem; font-weight:700; color:var(--text); }
  .reg-nearby-info span { color:var(--text-muted); font-size:.75rem; }
  .reg-nearby-dist { font-size:.78rem; font-weight:700; color:var(--primary); white-space:nowrap; }

  @media(max-width:768px) {
    .dashboard-layout { grid-template-columns:1fr; }
    .sidebar { display:none; }
    .auth-left { display:none; }
    nav { padding:0 1rem; }
    .hero { padding:3rem 1.5rem 2.5rem; }
    .hero-stats { gap:1.5rem; }
    .section { padding:2.5rem 1rem; }
    .chatbot-panel { width:calc(100vw - 1.5rem); right:.75rem; bottom:5rem; }
    .admin-form-grid { grid-template-columns:1fr; }
    .admin-form-grid .full { grid-column:1; }
  }
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<!-- AI ALERT OVERLAY -->
<div class="ai-alert-overlay" id="aiAlertOverlay">
  <div class="ai-alert-box">
    <div class="ai-alert-icon" id="aiAlertIcon">‚ö†Ô∏è</div>
    <h3 id="aiAlertTitle">AI Health Warning</h3>
    <p id="aiAlertMsg">This medicine may interact with your profile.</p>
    <div class="alert-box alert-danger" id="aiAlertDetail" style="margin-top:1rem;display:none;"></div>
    <div class="ai-alert-actions">
      <button class="btn btn-danger" onclick="closeAiAlert(false)">üö´ Cancel</button>
      <button class="btn btn-primary" onclick="closeAiAlert(true)">‚úÖ Proceed Anyway</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CALL MODAL ‚ïê‚ïê‚ïê -->
<div class="ai-alert-overlay" id="callModal" onclick="if(event.target===this)closeCallModal()">
  <div class="ai-alert-box" style="max-width:420px;width:100%">
    <div id="callModalIcon" style="font-size:3rem;margin-bottom:.5rem">üè•</div>
    <h3 id="callModalName" style="font-size:1.2rem;font-weight:800;margin-bottom:.3rem">Hospital Name</h3>
    <p id="callModalType" style="font-size:.82rem;color:var(--text-muted);margin-bottom:1rem"></p>
    <div id="callModalDetails" style="background:#f0f6ff;border-radius:12px;padding:1rem;margin-bottom:1.2rem;text-align:left"></div>
    <div style="display:flex;flex-direction:column;gap:.6rem">
      <a id="callModalBtn" href="#" class="btn btn-primary" style="justify-content:center;font-size:1rem;padding:.85rem;text-decoration:none" onclick="closeCallModal()">
        üìû Tap to Call Now
      </a>
      <button class="btn" style="background:#f1f5f9;width:100%;justify-content:center" onclick="closeCallModal()">‚úï Cancel</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê APPOINTMENT MODAL ‚ïê‚ïê‚ïê -->
<div class="ai-alert-overlay" id="appointModal" onclick="if(event.target===this)closeAppointModal()">
  <div style="background:#fff;border-radius:20px;padding:1.8rem;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.25)">
    <!-- Header -->
    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.4rem">
      <div id="apptAvatar" style="width:52px;height:52px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0;background:#e0f2fe">üè•</div>
      <div>
        <h3 id="apptTitle" style="font-size:1.1rem;font-weight:800">Book Appointment</h3>
        <p id="apptSubtitle" style="font-size:.82rem;color:var(--text-muted)"></p>
      </div>
      <button onclick="closeAppointModal()" style="margin-left:auto;background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--text-muted);flex-shrink:0">‚úï</button>
    </div>

    <!-- Available slots -->
    <div id="apptSlots" style="margin-bottom:1.2rem"></div>

    <!-- Form -->
    <div style="display:flex;flex-direction:column;gap:.9rem">
      <div class="form-group" style="margin:0">
        <label style="font-size:.82rem;font-weight:600;display:block;margin-bottom:.35rem">üë§ Your Full Name</label>
        <input type="text" id="apptPatientName" placeholder="Enter your full name"
          style="width:100%;padding:.7rem 1rem;border:1.5px solid var(--border);border-radius:10px;font-size:.9rem"
          onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <div class="form-group" style="margin:0">
        <label style="font-size:.82rem;font-weight:600;display:block;margin-bottom:.35rem">üìû Contact Number</label>
        <input type="tel" id="apptPhone" placeholder="+91 98765 43210"
          style="width:100%;padding:.7rem 1rem;border:1.5px solid var(--border);border-radius:10px;font-size:.9rem"
          onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <div class="form-group" style="margin:0">
        <label style="font-size:.82rem;font-weight:600;display:block;margin-bottom:.35rem">üìÖ Preferred Date</label>
        <input type="date" id="apptDate"
          style="width:100%;padding:.7rem 1rem;border:1.5px solid var(--border);border-radius:10px;font-size:.9rem"
          onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <div class="form-group" style="margin:0">
        <label style="font-size:.82rem;font-weight:600;display:block;margin-bottom:.35rem">üïê Preferred Time Slot</label>
        <div id="apptTimeSlots" style="display:flex;flex-wrap:wrap;gap:.5rem"></div>
      </div>
      <div class="form-group" style="margin:0">
        <label style="font-size:.82rem;font-weight:600;display:block;margin-bottom:.35rem">ü©∫ Reason for Visit</label>
        <input type="text" id="apptReason" placeholder="e.g. Fever, Diabetes check-up, Joint pain..."
          style="width:100%;padding:.7rem 1rem;border:1.5px solid var(--border);border-radius:10px;font-size:.9rem"
          onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
      </div>
    </div>

    <!-- Actions -->
    <div style="display:flex;gap:.8rem;margin-top:1.4rem">
      <button class="btn btn-primary" style="flex:1;justify-content:center;padding:.85rem" onclick="confirmAppointment()">
        ‚úÖ Confirm Appointment
      </button>
      <button class="btn" style="background:#f1f5f9;padding:.85rem 1.2rem" onclick="closeAppointModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê APPOINTMENT CONFIRMED MODAL ‚ïê‚ïê‚ïê -->
<div class="ai-alert-overlay" id="apptConfirmedModal" onclick="if(event.target===this)this.classList.remove('active')">
  <div class="ai-alert-box" style="max-width:420px;width:100%;text-align:center">
    <div style="font-size:4rem;margin-bottom:.5rem">üéâ</div>
    <h3 style="font-size:1.3rem;font-weight:800;color:#16a34a;margin-bottom:.5rem">Appointment Confirmed!</h3>
    <div id="apptConfirmedDetails" style="background:#f0fdf4;border-radius:12px;padding:1rem;margin:1rem 0;text-align:left;border:1px solid #86efac;font-size:.85rem;line-height:1.8"></div>
    <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:1.2rem">A confirmation has been saved. Please arrive 10 minutes early with a valid ID.</p>
    <button class="btn btn-primary" style="width:100%;justify-content:center" onclick="document.getElementById('apptConfirmedModal').classList.remove('active')">Done ‚úì</button>
  </div>
</div>


<div id="selectionTooltip">
  üîç <span id="selTooltipWord"></span>
  <button onclick="searchSelectedWord()">Search Medicine</button>
  <button onclick="searchSelectedWordDisease()" style="background:#10b981;margin-left:.3rem">Find Disease Info</button>
</div>

<!-- CHATBOT FAB -->
<!-- MEDIBOT CHATBOT -->
<button class="chatbot-fab" onclick="toggleChatbot()" id="chatFab" title="Ask MediBot AI">
  <span id="chatFabIcon">ü§ñ</span>
  <span class="chat-notif" id="chatNotif" style="display:none"></span>
</button>

<div class="chatbot-panel" id="chatbotPanel">
  <!-- Header -->
  <div class="chatbot-header">
    <div style="display:flex;align-items:center;gap:.7rem">
      <div style="width:36px;height:36px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem">ü§ñ</div>
      <div>
        <h4 style="margin:0;font-size:.95rem;font-weight:700">MediBot AI</h4>
        <div style="font-size:.7rem;opacity:.85;display:flex;align-items:center;gap:.35rem">
          <span class="cb-online-dot"></span> Powered by Claude AI
        </div>
      </div>
    </div>
    <div style="display:flex;gap:.4rem;align-items:center">
      <button onclick="clearChat()" style="background:rgba(255,255,255,0.15);border:none;color:#fff;border-radius:8px;padding:.3rem .5rem;cursor:pointer;font-size:.72rem" title="Clear chat">üóëÔ∏è</button>
      <button class="cb-close" onclick="toggleChatbot()">‚úï</button>
    </div>
  </div>

  <!-- Messages -->
  <div class="chatbot-messages" id="chatbotMessages">
    <div class="cb-msg bot" style="background:linear-gradient(135deg,#f0f6ff,#e8f2ff);border:1px solid #bfdbfe">
      üëã Hi! I'm <strong>MediBot</strong>, your AI medicine assistant powered by Claude.<br><br>
      Ask me anything about medicines, dosages, side effects, drug interactions, or health advice!
    </div>
    <!-- Quick reply chips -->
    <div class="cb-quick-replies" id="cbQuickReplies">
      <button class="cb-chip" onclick="sendQuick('What are the side effects of Paracetamol?')">üíä Paracetamol side effects</button>
      <button class="cb-chip" onclick="sendQuick('Is Ibuprofen safe during pregnancy?')">ü§∞ Ibuprofen in pregnancy</button>
      <button class="cb-chip" onclick="sendQuick('What medicines are safe for diabetes?')">ü©∏ Diabetes medicines</button>
      <button class="cb-chip" onclick="sendQuick('How does Metformin work?')">üíâ How Metformin works</button>
      <button class="cb-chip" onclick="sendQuick('What is the difference between Paracetamol and Ibuprofen?')">‚öñÔ∏è Paracetamol vs Ibuprofen</button>
      <button class="cb-chip" onclick="sendQuick('What medicines should I avoid with blood pressure?')">‚ù§Ô∏è BP safe medicines</button>
    </div>
  </div>

  <!-- Typing indicator (hidden by default) -->
  <div class="cb-typing" id="cbTyping" style="display:none">
    <div style="width:36px;height:36px;background:var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0">ü§ñ</div>
    <div class="cb-typing-dots"><span></span><span></span><span></span></div>
  </div>

  <!-- Input -->
  <div class="chatbot-input">
    <input type="text" id="chatInput" placeholder="Ask about any medicine or symptom..."
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"
      oninput="updateSendBtn(this.value)">
    <button id="chatSendBtn" onclick="sendChat()" style="opacity:.5" disabled>
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    </button>
  </div>
</div>

<!-- NAV -->
<nav>
  <a href="#" class="nav-logo" onclick="navigate('home')">
    <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="20" fill="rgba(255,255,255,0.2)"/><path d="M20 8v24M8 20h24" stroke="white" stroke-width="4" stroke-linecap="round"/><circle cx="20" cy="20" r="8" stroke="white" stroke-width="2" fill="none"/></svg>
    MediScan AI
  </a>
  <div class="nav-links" id="navGuest">
    <a href="#" onclick="navigate('home')">Home</a>
    <a href="#" onclick="navigate('scanner')">Scanner</a>
    <a href="#" onclick="navigate('nearby')">Nearby</a>
    <button class="nav-btn" onclick="navigate('login')">Login</button>
    <button class="nav-btn primary" onclick="navigate('register')">Sign Up</button>
  </div>
  <div class="nav-links" id="navUser" style="display:none">
    <a href="#" onclick="navigate('scanner')">üì∑ Scan</a>
    <a href="#" onclick="navigate('nearby')">üè• Nearby</a>
    <a href="#" onclick="navigate('dashboard')">Dashboard</a>
    <div class="nav-avatar" id="userAvatar" onclick="navigate('dashboard')">U</div>
    <button class="nav-btn" onclick="logout()">Logout</button>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page-home">
  <div class="hero">
    <div class="hero-badge">üöÄ AI-Powered Medicine Intelligence Platform</div>
    <h1>Scan Any Medicine.<br><span>Know Everything.</span></h1>
    <p>Upload a medicine strip or bottle photo and instantly get complete information ‚Äî dosage, side effects, nearby doctors, and AI-powered health warnings personalized to you.</p>
    <div class="hero-btns">
      <button class="btn btn-white" onclick="navigate('scanner')">üì∑ Scan Medicine</button>
      <button class="btn btn-outline-white" onclick="navigate('register')">Create Account ‚Üí</button>
    </div>
    <div class="hero-stats">
      <div class="hero-stat"><div class="num">50,000+</div><div class="lbl">Medicines</div></div>
      <div class="hero-stat"><div class="num">99.2%</div><div class="lbl">OCR Accuracy</div></div>
      <div class="hero-stat"><div class="num">10,000+</div><div class="lbl">Hospitals</div></div>
      <div class="hero-stat"><div class="num">AI ü§ñ</div><div class="lbl">Smart Alerts</div></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Everything You Need</div>
    <div class="section-sub">Comprehensive medicine intelligence at your fingertips</div>
    <div class="feature-grid">
      <div class="feature-card" onclick="navigate('scanner')">
        <div class="feature-icon" style="background:#e0f2fe">üì∑</div>
        <h3>AI OCR Scanner</h3>
        <p>Upload or scan medicine strips/bottles. AI extracts text and identifies the medicine with 99%+ accuracy.</p>
      </div>
      <div class="feature-card" onclick="navigate('scanner')">
        <div class="feature-icon" style="background:#d1fae5">üíä</div>
        <h3>Complete Medicine Info</h3>
        <p>Dosage, composition, timing, side effects, precautions ‚Äî all displayed in a clear, easy-to-understand format.</p>
      </div>
      <div class="feature-card" onclick="navigate('nearby')">
        <div class="feature-icon" style="background:#fce7f3">üè•</div>
        <h3>Nearby Hospitals & Doctors</h3>
        <p>Automatically find hospitals and specialized doctors near your location for the condition being treated.</p>
      </div>
      <div class="feature-card" onclick="navigate('scanner')">
        <div class="feature-icon" style="background:#fef3c7">ü§ñ</div>
        <h3>AI Health Warnings</h3>
        <p>Personalized alerts for drug interactions, allergy conflicts, and condition-specific warnings based on your profile.</p>
      </div>
      <div class="feature-card" onclick="navigate('dashboard')">
        <div class="feature-icon" style="background:#ede9fe">üìÅ</div>
        <h3>Scan History & Dashboard</h3>
        <p>Track all your medicine scans, save favourites, and manage your complete medical profile securely.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon" style="background:#fee2e2">üö®</div>
        <h3>Emergency System</h3>
        <p>Instant SOS alerts, emergency contact integration, and quick-access emergency medicine information.</p>
      </div>
    </div>
  </div>

  <div style="background:linear-gradient(135deg,#004A99,#0099FF);padding:3rem 2rem;text-align:center;color:#fff;margin:2rem 0;">
    <h2 style="font-size:1.8rem;font-weight:800;margin-bottom:.8rem;">Ready to scan your medicine?</h2>
    <p style="opacity:.85;margin-bottom:1.5rem;">Join thousands of users making smarter health decisions</p>
    <button class="btn btn-white" onclick="navigate('scanner')">Start Scanning Free ‚Üí</button>
  </div>
  <footer>¬© 2025 MediScan AI ‚Äî Smart Medicine Intelligence Platform | Built with üíô for Better Health</footer>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REGISTER PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-register">
  <div class="auth-wrapper">
    <div class="auth-left">
      <h2>Join MediScan AI</h2>
      <p>Create your account and get personalized medicine intelligence powered by AI.</p>
      <div class="auth-features">
        <div class="auth-feature"><div class="ico">üì∑</div> Unlimited medicine scans</div>
        <div class="auth-feature"><div class="ico">ü§ñ</div> AI-powered health alerts</div>
        <div class="auth-feature"><div class="ico">üéÇ</div> Age auto-detected from birthday</div>
        <div class="auth-feature"><div class="ico">üíä</div> Personalized dosage for your age</div>
        <div class="auth-feature"><div class="ico">üìç</div> Location-based hospital finder</div>
        <div class="auth-feature"><div class="ico">üîí</div> Secure & private</div>
      </div>
    </div>
    <div class="auth-right">
      <div class="auth-form-box">
        <h2>Create Account</h2>
        <p>Already have one? <a onclick="navigate('login')">Sign in here</a></p>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="regName" placeholder="John Doe">
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="regEmail" placeholder="john@example.com">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="regPhone" placeholder="+91 98765 43210">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="regPass" placeholder="Min 8 characters">
        </div>

        <!-- ‚îÄ‚îÄ BIRTHDAY FIELD ‚îÄ‚îÄ -->
        <div class="form-group">
          <label>üéÇ Date of Birth <span style="color:var(--text-muted);font-size:.78rem;font-weight:normal">(optional ‚Äî enables personalised dosage)</span></label>
          <div class="dob-row">
            <select id="regDobDay" onchange="calcAgeFromDOB()">
              <option value="">Day</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
              <option value="21">21</option>
              <option value="22">22</option>
              <option value="23">23</option>
              <option value="24">24</option>
              <option value="25">25</option>
              <option value="26">26</option>
              <option value="27">27</option>
              <option value="28">28</option>
              <option value="29">29</option>
              <option value="30">30</option>
              <option value="31">31</option>
            </select>
            <select id="regDobMonth" onchange="calcAgeFromDOB()">
              <option value="">Month</option>
              <option value="1">January</option><option value="2">February</option>
              <option value="3">March</option><option value="4">April</option>
              <option value="5">May</option><option value="6">June</option>
              <option value="7">July</option><option value="8">August</option>
              <option value="9">September</option><option value="10">October</option>
              <option value="11">November</option><option value="12">December</option>
            </select>
            <select id="regDobYear" onchange="calcAgeFromDOB()">
              <option value="">Year</option>
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
              <option value="2022">2022</option>
              <option value="2021">2021</option>
              <option value="2020">2020</option>
              <option value="2019">2019</option>
              <option value="2018">2018</option>
              <option value="2017">2017</option>
              <option value="2016">2016</option>
              <option value="2015">2015</option>
              <option value="2014">2014</option>
              <option value="2013">2013</option>
              <option value="2012">2012</option>
              <option value="2011">2011</option>
              <option value="2010">2010</option>
              <option value="2009">2009</option>
              <option value="2008">2008</option>
              <option value="2007">2007</option>
              <option value="2006">2006</option>
              <option value="2005">2005</option>
              <option value="2004">2004</option>
              <option value="2003">2003</option>
              <option value="2002">2002</option>
              <option value="2001">2001</option>
              <option value="2000">2000</option>
              <option value="1999">1999</option>
              <option value="1998">1998</option>
              <option value="1997">1997</option>
              <option value="1996">1996</option>
              <option value="1995">1995</option>
              <option value="1994">1994</option>
              <option value="1993">1993</option>
              <option value="1992">1992</option>
              <option value="1991">1991</option>
              <option value="1990">1990</option>
              <option value="1989">1989</option>
              <option value="1988">1988</option>
              <option value="1987">1987</option>
              <option value="1986">1986</option>
              <option value="1985">1985</option>
              <option value="1984">1984</option>
              <option value="1983">1983</option>
              <option value="1982">1982</option>
              <option value="1981">1981</option>
              <option value="1980">1980</option>
              <option value="1979">1979</option>
              <option value="1978">1978</option>
              <option value="1977">1977</option>
              <option value="1976">1976</option>
              <option value="1975">1975</option>
              <option value="1974">1974</option>
              <option value="1973">1973</option>
              <option value="1972">1972</option>
              <option value="1971">1971</option>
              <option value="1970">1970</option>
              <option value="1969">1969</option>
              <option value="1968">1968</option>
              <option value="1967">1967</option>
              <option value="1966">1966</option>
              <option value="1965">1965</option>
              <option value="1964">1964</option>
              <option value="1963">1963</option>
              <option value="1962">1962</option>
              <option value="1961">1961</option>
              <option value="1960">1960</option>
              <option value="1959">1959</option>
              <option value="1958">1958</option>
              <option value="1957">1957</option>
              <option value="1956">1956</option>
              <option value="1955">1955</option>
              <option value="1954">1954</option>
              <option value="1953">1953</option>
              <option value="1952">1952</option>
              <option value="1951">1951</option>
              <option value="1950">1950</option>
              <option value="1949">1949</option>
              <option value="1948">1948</option>
              <option value="1947">1947</option>
              <option value="1946">1946</option>
              <option value="1945">1945</option>
              <option value="1944">1944</option>
              <option value="1943">1943</option>
              <option value="1942">1942</option>
              <option value="1941">1941</option>
              <option value="1940">1940</option>
              <option value="1939">1939</option>
              <option value="1938">1938</option>
              <option value="1937">1937</option>
              <option value="1936">1936</option>
              <option value="1935">1935</option>
              <option value="1934">1934</option>
              <option value="1933">1933</option>
              <option value="1932">1932</option>
              <option value="1931">1931</option>
              <option value="1930">1930</option>
              <option value="1929">1929</option>
              <option value="1928">1928</option>
              <option value="1927">1927</option>
              <option value="1926">1926</option>
              <option value="1925">1925</option>
              <option value="1924">1924</option>
              <option value="1923">1923</option>
              <option value="1922">1922</option>
              <option value="1921">1921</option>
              <option value="1920">1920</option>
              <option value="1919">1919</option>
              <option value="1918">1918</option>
              <option value="1917">1917</option>
              <option value="1916">1916</option>
              <option value="1915">1915</option>
            </select>
          </div>
          <!-- Live Age Preview -->
          <div class="age-preview" id="agePreview">
            <div class="age-num" id="agePreviewNum">--</div>
            <div class="age-info">
              <div style="font-weight:700" id="agePreviewLabel">Years Old</div>
              <div style="color:var(--text-muted);font-size:.78rem" id="agePreviewDob"></div>
            </div>
            <div class="age-group-badge" id="agePreviewBadge">--</div>
          </div>
        </div>
        <!-- Hidden age field auto-filled -->
        <input type="hidden" id="regAge">
        <input type="hidden" id="regDobFull">
        <input type="hidden" id="regAgeGroup">

        <div class="form-group">
          <label>Gender</label>
          <select id="regGender">
            <option value="">Select Gender</option>
            <option value="male">Male üë®</option>
            <option value="female">Female üë©</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Known Allergies <span style="color:var(--text-muted);font-weight:normal">(optional)</span></label>
          <input type="text" id="regAllergies" placeholder="e.g. Penicillin, Sulfa drugs">
        </div>
        <div class="form-group">
          <label>Medical Conditions <span style="color:var(--text-muted);font-weight:normal">(optional)</span></label>
          <input type="text" id="regConditions" placeholder="e.g. Diabetes, Hypertension">
        </div>

        <!-- ‚îÄ‚îÄ LOCATION FIELD ‚îÄ‚îÄ -->
        <div class="form-group">
          <label>üìç Your Location <span style="color:var(--text-muted);font-weight:normal">(for nearby hospitals)</span></label>
          <div style="display:flex;gap:.6rem;align-items:stretch">
            <input type="text" id="regLocation" placeholder="City, State or full address"
              style="flex:1" oninput="regLocationTyping(this.value)">
            <button type="button" class="btn btn-primary" onclick="detectRegLocation()"
              style="padding:.6rem 1rem;font-size:.82rem;flex-shrink:0;white-space:nowrap" id="regGpsBtn">
              üìç Detect
            </button>
          </div>
          <!-- GPS Status -->
          <div id="regLocationStatus" style="display:none;margin-top:.5rem"></div>
          <!-- Location suggestions -->
          <div id="regLocationSuggestions" style="display:none;background:#fff;border:1.5px solid var(--primary);border-radius:10px;margin-top:.3rem;overflow:hidden;box-shadow:var(--shadow)"></div>
          <!-- Nearby hospitals preview -->
          <div id="regNearbyPreview" style="display:none;margin-top:.8rem"></div>
        </div>
        <input type="hidden" id="regLat">
        <input type="hidden" id="regLng">
        <input type="hidden" id="regCity">

        <button class="btn btn-primary btn-full" onclick="register()">üöÄ Create Account</button>
        <div class="divider">or register with</div>
        <div style="display:flex;gap:.8rem;">
          <button class="btn btn-full" style="background:#f1f5f9;color:#1a202c;flex:1" onclick="socialAuth('Google')">üá¨ Google</button>
          <button class="btn btn-full" style="background:#f1f5f9;color:#1a202c;flex:1" onclick="socialAuth('GitHub')">üêô GitHub</button>
        </div>
        <div class="auth-switch">Already have an account? <a onclick="navigate('login')">Sign in</a></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-login">
  <div class="auth-wrapper">
    <div class="auth-left">
      <h2>Welcome Back!</h2>
      <p>Sign in to access your personalized medicine scanner, scan history, and AI health alerts.</p>
      <div class="auth-features">
        <div class="auth-feature"><div class="ico">üîê</div> Secure JWT Authentication</div>
        <div class="auth-feature"><div class="ico">üì±</div> OTP-based login via email/SMS</div>
        <div class="auth-feature"><div class="ico">üõ°Ô∏è</div> Bcrypt password protection</div>
      </div>
    </div>
    <div class="auth-right">
      <div class="auth-form-box" id="loginStep1">
        <h2>Sign In</h2>
        <p>Don't have an account? <a onclick="navigate('register')">Create one</a></p>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="loginEmail" placeholder="john@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPass" placeholder="Your password" onkeydown="if(event.key==='Enter')loginWithPass()">
        </div>
        <button class="btn btn-primary btn-full" onclick="loginWithPass()">üîë Sign In</button>
        <div class="divider">or</div>
        <button class="btn btn-full btn-accent" style="width:100%;justify-content:center;" onclick="requestOTP()">üì± Login with OTP</button>
        <div class="auth-switch">
          <a onclick="navigate('register')">Create new account</a> &nbsp;¬∑&nbsp; 
          <a onclick="navigate('admin')">Admin Panel</a>
        </div>
      </div>
      <div class="auth-form-box" id="loginStep2" style="display:none">
        <h2>Enter OTP</h2>
        <p>We sent a 6-digit code to your email/phone.</p>
        <div style="margin:2rem 0;">
          <div class="otp-inputs">
            <input type="text" class="otp-box" maxlength="1" oninput="otpNext(this,0)">
            <input type="text" class="otp-box" maxlength="1" oninput="otpNext(this,1)">
            <input type="text" class="otp-box" maxlength="1" oninput="otpNext(this,2)">
            <input type="text" class="otp-box" maxlength="1" oninput="otpNext(this,3)">
            <input type="text" class="otp-box" maxlength="1" oninput="otpNext(this,4)">
            <input type="text" class="otp-box" maxlength="1" oninput="otpNext(this,5)">
          </div>
          <p style="text-align:center;font-size:.8rem;color:var(--text-muted);margin-top:.8rem">Demo OTP: <strong>123456</strong></p>
        </div>
        <button class="btn btn-primary btn-full" onclick="verifyOTP()">‚úÖ Verify OTP</button>
        <div class="auth-switch" style="margin-top:1rem"><a onclick="showLoginStep1()">‚Üê Back to login</a></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCANNER PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-scanner">
  <div class="scanner-container">
    <div class="scan-card">

      <!-- PAGE HEADER -->
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:1.4rem">
        <div>
          <h2 style="margin:0;font-size:1.35rem">üî¨ Medicine Scanner</h2>
          <p style="font-size:.83rem;color:var(--text-muted);margin-top:.2rem">Scan image ¬∑ search by name ¬∑ or describe symptoms</p>
        </div>
        <div style="display:flex;gap:.5rem">
          <span class="badge badge-success" style="font-size:.72rem">‚úÖ OCR Ready</span>
          <span class="badge" style="background:var(--primary-light);color:var(--primary);font-size:.72rem">ü§ñ AI Active</span>
        </div>
      </div>

      <!-- SCAN MODE TABS -->
      <div class="scan-tabs" role="tablist">
        <button class="scan-tab active" id="tab-image" onclick="switchScanTab('image')" role="tab">
          üì∑ Image / Camera
        </button>
        <button class="scan-tab" id="tab-name" onclick="switchScanTab('name')" role="tab">
          üîç Search by Name
        </button>
        <button class="scan-tab" id="tab-desc" onclick="switchScanTab('desc')" role="tab">
          üí¨ Describe Symptoms
        </button>
        <button class="scan-tab" id="tab-disease" onclick="switchScanTab('disease')" role="tab">
          ü©∫ Search by Disease
        </button>
      </div>

      <!-- ‚îÄ‚îÄ TAB 1: IMAGE UPLOAD / CAMERA ‚îÄ‚îÄ -->
      <div class="scan-tab-panel active" id="panel-image">
        <div class="drop-zone" id="dropZone"
             ondragover="event.preventDefault();this.classList.add('dragging')"
             ondragleave="this.classList.remove('dragging')"
             ondrop="handleDrop(event)">
          <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
          <div class="drop-icon">üè∑Ô∏è</div>
          <h3>Drop medicine strip / bottle image here</h3>
          <p>Supports JPG, PNG, WEBP ‚Äî AI OCR will extract text automatically</p>
        </div>
        <div class="or-divider">or use live camera</div>
        <div style="text-align:center">
          <video id="cameraFeed" autoplay playsinline></video>
          <div class="camera-controls">
            <button class="btn btn-accent" onclick="startCamera()" id="startCamBtn">üì∑ Open Camera</button>
            <button class="btn btn-primary" onclick="capturePhoto()" id="captureCamBtn" style="display:none">üì∏ Capture Photo</button>
            <button class="btn" style="background:#f1f5f9;display:none" onclick="stopCamera()" id="stopCamBtn">‚úï Stop</button>
          </div>
          <canvas id="snapCanvas" style="display:none"></canvas>
        </div>
        <img id="previewImg" alt="Medicine preview">
        <div style="margin-top:1rem;padding:.8rem 1rem;background:var(--primary-light);border-radius:10px;font-size:.82rem;color:var(--primary)">
          üí° <strong>Tip:</strong> Ensure the medicine name, dosage, and batch number are clearly visible. Good lighting improves OCR accuracy.
        </div>
      </div>

      <!-- ‚îÄ‚îÄ TAB 2: SEARCH BY NAME ‚îÄ‚îÄ -->
      <div class="scan-tab-panel" id="panel-name">
        <div style="margin-bottom:1rem">
          <label style="font-size:.88rem;font-weight:600;display:block;margin-bottom:.5rem">Enter medicine name (generic or brand)</label>
          <div style="display:flex;gap:.7rem">
            <input type="text" id="medSearchInput"
              placeholder="e.g. Paracetamol, Crocin, Ibuprofen, Dolo 650..."
              style="flex:1;padding:.75rem 1rem;border:1.5px solid var(--border);border-radius:10px;font-size:.95rem;transition:.2s"
              onfocus="this.style.borderColor='var(--primary)'"
              onblur="this.style.borderColor='var(--border)'"
              onkeydown="if(event.key==='Enter')searchMedicineByName()">
            <button class="btn btn-primary" onclick="searchMedicineByName()">üîç Search</button>
          </div>
        </div>
        <div>
          <p style="font-size:.8rem;color:var(--text-muted);margin-bottom:.5rem">üíä Popular medicines:</p>
          <div style="display:flex;flex-wrap:wrap;gap:.5rem">
            <span class="desc-example-chip" onclick="quickSearch('Paracetamol')">Paracetamol</span>
            <span class="desc-example-chip" onclick="quickSearch('Ibuprofen')">Ibuprofen</span>
            <span class="desc-example-chip" onclick="quickSearch('Amoxicillin')">Amoxicillin</span>
            <span class="desc-example-chip" onclick="quickSearch('Metformin')">Metformin</span>
            <span class="desc-example-chip" onclick="quickSearch('Aspirin')">Aspirin</span>
            <span class="desc-example-chip" onclick="quickSearch('Omeprazole')">Omeprazole</span>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ TAB 3: DESCRIBE SYMPTOMS / DESCRIPTION ‚îÄ‚îÄ -->
      <div class="scan-tab-panel" id="panel-desc">
        <div class="desc-scanner-wrap">

          <!-- Input area -->
          <div style="margin-bottom:1rem">
            <label style="font-size:.92rem;font-weight:700;display:block;margin-bottom:.5rem">
              üí¨ Describe your symptoms, condition, or medicine details
            </label>
            <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:.8rem;line-height:1.5">
              Type in plain language ‚Äî e.g. symptoms you have, what the medicine looks like, its colour/shape, what disease it treats, or any text you can partially read from the label.
            </p>
            <textarea class="desc-input-area" id="descInput"
              placeholder="Examples:&#10;‚Ä¢ I have fever and body pain, need something safe for children&#10;‚Ä¢ White round tablet, 500mg written on it, for headache&#10;‚Ä¢ Medicine for type 2 diabetes, taken with food twice a day&#10;‚Ä¢ Antibiotic for throat infection, not penicillin (I'm allergic)&#10;‚Ä¢ Tablet to reduce stomach acid before meals"></textarea>
          </div>

          <!-- Filters row -->
          <div class="desc-filter-row">
            <select id="descAgeGroup">
              <option value="">üë• Any Age Group</option>
              <option value="adult">Adults (18+)</option>
              <option value="child">Children (under 12)</option>
              <option value="elderly">Elderly (65+)</option>
            </select>
            <select id="descCondition">
              <option value="">ü©∫ No Special Condition</option>
              <option value="diabetes">Diabetes</option>
              <option value="pregnancy">Pregnancy</option>
              <option value="liver">Liver Issue</option>
              <option value="hypertension">Hypertension</option>
            </select>
            <select id="descCategory">
              <option value="">üíä Any Category</option>
              <option value="pain">Pain / Fever</option>
              <option value="antibiotic">Antibiotic</option>
              <option value="antacid">Acid / Stomach</option>
              <option value="diabetes">Diabetes</option>
              <option value="cardiac">Heart / Cardiac</option>
            </select>
          </div>

          <!-- Quick example chips -->
          <div style="margin-bottom:1rem">
            <p style="font-size:.78rem;color:var(--text-muted);margin-bottom:.5rem">üí° Quick examples ‚Äî click to try:</p>
            <div class="desc-examples">
              <span class="desc-example-chip" onclick="fillDesc('High fever and headache, safe for 8-year-old child')">üå°Ô∏è Child fever & headache</span>
              <span class="desc-example-chip" onclick="fillDesc('Severe joint pain and inflammation, adult patient')">ü¶¥ Joint pain adult</span>
              <span class="desc-example-chip" onclick="fillDesc('Bacterial throat infection, penicillin allergy, need alternative antibiotic')">ü¶† Throat infection, penicillin allergy</span>
              <span class="desc-example-chip" onclick="fillDesc('Type 2 diabetes management, taken with meals, blood sugar control')">ü©∏ Type 2 diabetes</span>
              <span class="desc-example-chip" onclick="fillDesc('Acid reflux and heartburn, need to take before food')">üî• Acid reflux / GERD</span>
              <span class="desc-example-chip" onclick="fillDesc('Heart attack prevention, blood thinning, low dose daily tablet')">‚ù§Ô∏è Heart/blood clot prevention</span>
              <span class="desc-example-chip" onclick="fillDesc('Stomach infection with diarrhea, needs antibiotic, pregnant woman')">ü§∞ Infection in pregnancy</span>
              <span class="desc-example-chip" onclick="fillDesc('White oval tablet I found, 500mg written, treats pain and fever')">üîç White 500mg tablet found</span>
            </div>
          </div>

          <!-- Search button -->
          <div style="display:flex;gap:.8rem;align-items:center;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="searchByDescription()" style="padding:.8rem 2rem;font-size:1rem">
              ü§ñ Analyse with AI
            </button>
            <button class="btn" style="background:#f1f5f9" onclick="clearDescSearch()">üóëÔ∏è Clear</button>
            <span style="font-size:.78rem;color:var(--text-muted)">AI matches symptoms to medicine database</span>
          </div>
        </div>

        <!-- AI Thinking indicator -->
        <div class="desc-loading" id="descLoading">
          <div class="ai-thinking">
            <span style="font-size:2rem">ü§ñ</span>
            <div>
              <div>AI is analysing your description</div>
              <div class="dot-blink" style="margin-top:.4rem"><span></span><span></span><span></span></div>
            </div>
          </div>
          <p style="color:var(--text-muted);font-size:.82rem;margin-top:1rem">Matching symptoms ‚Üí scanning medicine database ‚Üí ranking by relevance...</p>
        </div>

        <!-- Description Match Results -->
        <div class="desc-results" id="descResults">
          <div style="display:flex;align-items:center;justify-content:space-between;margin:1.5rem 0 1rem;flex-wrap:wrap;gap:.5rem">
            <div>
              <h3 style="font-size:1.05rem;font-weight:700" id="descResultTitle">Matched Medicines</h3>
              <p style="font-size:.8rem;color:var(--text-muted)" id="descResultSubtitle"></p>
            </div>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap" id="descResultBadges"></div>
          </div>
          <div id="descMatchList"></div>
          <div class="no-results-box" id="descNoResults" style="display:none">
            <div class="nr-icon">üîç</div>
            <h3>No strong matches found</h3>
            <p>Try adding more details ‚Äî the medicine colour, shape, condition it treats, or any text visible on the label.</p>
            <button class="btn btn-primary" style="margin-top:1rem" onclick="clearDescSearch()">üîÑ Try again</button>
          </div>
        </div>
      </div>
      <!-- ‚îÄ‚îÄ TAB 4: SEARCH BY DISEASE ‚îÄ‚îÄ -->
      <div class="scan-tab-panel" id="panel-disease">
        <div style="margin-bottom:1.2rem">
          <label style="font-size:.92rem;font-weight:700;display:block;margin-bottom:.4rem">ü©∫ What disease or condition do you have?</label>
          <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:.9rem">Select a disease to instantly find required medicines + nearest hospitals</p>
          <div style="display:flex;gap:.7rem;flex-wrap:wrap;margin-bottom:1rem">
            <input type="text" id="diseaseSearchInput" placeholder="Type disease name e.g. Fever, Diabetes, GERD..."
              style="flex:1;min-width:180px;padding:.75rem 1rem;border:1.5px solid var(--border);border-radius:10px;font-size:.9rem;transition:.2s"
              onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'"
              oninput="filterDiseaseChips(this.value)"
              onkeydown="if(event.key==='Enter')searchByDisease()">
            <button class="btn btn-primary" onclick="searchByDisease()">üîç Find</button>
          </div>
          <!-- Disease chips grid -->
          <div id="diseaseChips" style="display:flex;flex-wrap:wrap;gap:.5rem"></div>
        </div>
        <!-- Disease result -->
        <div id="diseaseResult" style="display:none"></div>
      </div>
      <!-- end tab panels -->
    </div>

    <!-- PROGRESS BAR (shared) -->
    <div class="scan-card scan-progress" id="scanProgress">
      <h2>üîÑ Processing</h2>
      <div class="progress-steps" id="progressSteps">
        <div class="step" id="step1">üìÅ Upload</div>
        <div style="color:var(--border)">‚Üí</div>
        <div class="step" id="step2">üîç OCR</div>
        <div style="color:var(--border)">‚Üí</div>
        <div class="step" id="step3">üíä Identify</div>
        <div style="color:var(--border)">‚Üí</div>
        <div class="step" id="step4">üìä Fetch Data</div>
        <div style="color:var(--border)">‚Üí</div>
        <div class="step" id="step5">ü§ñ AI Analysis</div>
      </div>
      <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
      <p id="progressMsg" style="font-size:.85rem;color:var(--text-muted)">Initializing...</p>
    </div>

    <div class="medicine-result" id="medicineResult"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NEARBY PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-nearby">
  <div style="max-width:1140px;margin:0 auto;padding:2rem;">

    <!-- Header -->
    <div class="location-header">
      <div>
        <h1 style="font-size:1.5rem;font-weight:800">üè• Nearby Healthcare ‚Äî Live</h1>
        <div class="location-display" id="locationDisplay">üìç Tap "Detect My Location" to find hospitals near you</div>
      </div>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap">
        <button class="btn btn-primary" id="detectGpsBtn" onclick="startNearbyFlow()">üìç Detect My Location</button>
        <button class="btn" style="background:#f1f5f9" onclick="openGoogleMapsNearby()">üó∫Ô∏è Full Maps</button>
      </div>
    </div>

    <!-- Personalised location banner -->
    <div id="nearbyLocationBanner" style="display:none;align-items:center;gap:.8rem;background:linear-gradient(135deg,#0066cc15,#0099ff10);border:1.5px solid #bfdbfe;border-radius:14px;padding:.9rem 1.2rem;margin-bottom:1rem">
      <span style="font-size:1.5rem">üìç</span>
      <div style="flex:1">
        <div id="nearbyBannerText" style="font-size:.86rem;font-weight:600;color:var(--primary)"></div>
        <div style="font-size:.76rem;color:var(--text-muted);margin-top:.15rem">Sorted by real distance ¬∑ <a onclick="clearUserLocation()" style="color:var(--primary);cursor:pointer;text-decoration:underline">Change location</a></div>
      </div>
      <button onclick="clearUserLocation()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--text-muted)">‚úï</button>
    </div>

    <!-- Map info bar (shown after location detected) -->
    <div class="map-info-bar" id="mapInfoBar" style="display:none">
      <div class="loc-text">
        <span>üìç</span>
        <span id="mapLocationLabel">Locating...</span>
      </div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
        <span id="nearbyGpsStatus" class="badge badge-success" style="font-size:.74rem">üîÑ Loading...</span>
        <span id="nearbyHospCount" class="badge badge-rx" style="font-size:.74rem">üè• Fetching...</span>
        <span id="nearbyDocCount" class="badge" style="background:var(--primary-light);color:var(--primary);font-size:.74rem">üë®‚Äç‚öïÔ∏è Fetching...</span>
      </div>
      <div class="map-actions">
        <button class="btn" style="background:#f0fdf4;color:#16a34a;font-size:.78rem;padding:.35rem .8rem" onclick="refreshNearby()">üîÑ Refresh</button>
        <button class="btn" style="background:#f0f6ff;color:var(--primary);font-size:.78rem;padding:.35rem .8rem" onclick="openGoogleMapsNearby()">üó∫Ô∏è Open Maps</button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ REAL GOOGLE MAP ‚îÄ‚îÄ -->
    <div id="googleMapContainer">
      <div id="mapLoadingOverlay">
        <div class="spin"></div>
        <div style="font-size:.9rem;font-weight:600;color:var(--primary)">Loading live map...</div>
        <div style="font-size:.78rem;color:var(--text-muted)">Fetching hospitals near your location</div>
      </div>
      <div id="googleMapEl"></div>
    </div>

    <!-- Fallback placeholder when map not yet shown -->
    <div id="nearbyPlaceholder" class="map-placeholder" style="cursor:pointer" onclick="startNearbyFlow()">
      <div style="font-size:3rem">üìç</div>
      <p style="font-weight:700;font-size:1rem;color:var(--primary);margin-top:.5rem">Tap to Find Real Hospitals Near You</p>
      <p style="font-size:.82rem;margin-top:.3rem">Uses your GPS + Google Places to show live hospital data</p>
      <button class="btn btn-primary" style="margin-top:1rem;font-size:.9rem" onclick="event.stopPropagation();startNearbyFlow()">üìç Detect Location & Find Hospitals</button>
    </div>

    <!-- Disease Filter Bar -->
    <div style="background:var(--primary-light);border-radius:14px;padding:1rem 1.2rem;margin-bottom:1.5rem;border:1px solid #bfdbfe">
      <div style="font-size:.85rem;font-weight:700;color:var(--primary);margin-bottom:.6rem">ü©∫ Filter by Speciality / Disease</div>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap" id="nearbyDiseaseFilter">
        <button class="nearby-filter-btn active" onclick="filterNearby('all',this)">All</button>
        <button class="nearby-filter-btn" onclick="filterNearby('hospital',this)">üè• Hospitals</button>
        <button class="nearby-filter-btn" onclick="filterNearby('doctor',this)">üë®‚Äç‚öïÔ∏è Doctors</button>
        <button class="nearby-filter-btn" onclick="filterNearby('pharmacy',this)">üíä Pharmacy</button>
        <button class="nearby-filter-btn" onclick="filterNearby('cardiology',this)">‚ù§Ô∏è Cardiology</button>
        <button class="nearby-filter-btn" onclick="filterNearby('neurology',this)">üß† Neurology</button>
        <button class="nearby-filter-btn" onclick="filterNearby('diabetes',this)">ü©∏ Diabetes</button>
        <button class="nearby-filter-btn" onclick="filterNearby('ortho',this)">ü¶¥ Ortho</button>
      </div>
    </div>

    <!-- Tabs -->
    <div style="display:flex;gap:.8rem;margin-bottom:1.5rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="showSection('hospitals')" id="tabHosp">üè• Hospitals</button>
      <button class="btn" style="background:#f1f5f9" onclick="showSection('doctors')" id="tabDoc">üë®‚Äç‚öïÔ∏è Doctors</button>
    </div>

    <div id="sectionHospitals">
      <div style="text-align:center;padding:3rem;color:var(--text-muted)">
        <div style="font-size:2.5rem;margin-bottom:.8rem">üìç</div>
        <p style="font-weight:600">Tap "Detect My Location" to load real hospitals near you</p>
      </div>
    </div>
    <div id="sectionDoctors" style="display:none">
      <div style="text-align:center;padding:3rem;color:var(--text-muted)">
        <div style="font-size:2.5rem;margin-bottom:.8rem">üë®‚Äç‚öïÔ∏è</div>
        <p style="font-weight:600">Tap "Detect My Location" to load real doctors near you</p>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-dashboard">
  <div class="dashboard-layout">
    <div class="sidebar">
      <div class="sidebar-profile">
        <div class="sidebar-avatar" id="sidebarAvatar">U</div>
        <div class="sidebar-name" id="sidebarName">User</div>
        <div class="sidebar-email" id="sidebarEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4b3e382e390b2e332a263b272e65282426">[email&#160;protected]</a></div>
      </div>
      <ul class="sidebar-nav">
        <li><a class="active" onclick="showDashTab('overview')"><span class="nav-ico">üè†</span> Overview</a></li>
        <li><a onclick="showDashTab('history')"><span class="nav-ico">üìã</span> Scan History</a></li>
        <li><a onclick="showDashTab('saved')"><span class="nav-ico">üíæ</span> Saved Medicines</a></li>
        <li><a onclick="showDashTab('profile')"><span class="nav-ico">üë§</span> Medical Profile</a></li>
        <div class="sidebar-section">Quick Actions</div>
        <li><a onclick="navigate('scanner')"><span class="nav-ico">üì∑</span> New Scan</a></li>
        <li><a onclick="navigate('nearby')"><span class="nav-ico">üè•</span> Find Hospitals</a></li>
      </ul>
    </div>
    <div class="dash-main">
      <div id="dashOverview">
        <div class="dash-header">
          <h1>Good day, <span id="dashGreetName">User</span> üëã</h1>
          <button class="btn btn-primary" onclick="navigate('scanner')">üì∑ New Scan</button>
        </div>
        <div class="stats-row">
          <div class="stat-card"><div class="stat-icon" style="background:#e0f2fe">üì∑</div><div class="stat-val" id="statScans">7</div><div class="stat-lbl">Total Scans</div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#d1fae5">üíä</div><div class="stat-val" id="statMeds">4</div><div class="stat-lbl">Saved Medicines</div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#fce7f3">ü§ñ</div><div class="stat-val" id="statAlerts">2</div><div class="stat-lbl">AI Alerts</div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#fef3c7">üè•</div><div class="stat-val">12</div><div class="stat-lbl">Nearby Hospitals</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;flex-wrap:wrap">
          <div class="info-card">
            <h3><div class="ico" style="background:#e0f2fe">üìã</div> Recent Scans</h3>
            <div id="recentScans"></div>
          </div>
          <div class="info-card">
            <h3><div class="ico" style="background:#fef3c7">ü§ñ</div> AI Profile Alerts</h3>
            <div id="aiProfileAlerts"></div>
          </div>
        </div>
      </div>
      <div id="dashHistory" style="display:none">
        <div class="dash-header"><h1>üìã Scan History</h1></div>
        <div id="historyList"></div>
      </div>
      <div id="dashSaved" style="display:none">
        <div class="dash-header"><h1>üíæ Saved Medicines</h1></div>
        <div id="savedList"></div>
      </div>
      <div id="dashProfile" style="display:none">
        <div class="dash-header"><h1>üë§ Medical Profile</h1></div>
        <div class="scan-card">
          <!-- Age Group Banner -->
          <div id="profileAgeBanner" style="margin-bottom:1.5rem"></div>
          <div class="admin-form-grid">
            <div class="form-group"><label>Full Name</label><input type="text" id="profName"></div>
            <div class="form-group"><label>Email</label><input type="email" id="profEmail"></div>
            <div class="form-group"><label>Phone</label><input type="tel" id="profPhone"></div>
            <div class="form-group"><label>Date of Birth</label><input type="date" id="profDob" onchange="updateProfileAge()"></div>
            <div class="form-group"><label>Age <span style="color:var(--primary);font-size:.75rem">(auto from DOB)</span></label><input type="number" id="profAge" readonly style="background:#f8fafc;color:var(--text-muted)"></div>
            <div class="form-group"><label>Gender</label>
              <select id="profGender">
                <option value="">Select</option>
                <option value="male">Male üë®</option>
                <option value="female">Female üë©</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group full"><label>Known Allergies</label><input type="text" id="profAllergies" placeholder="e.g. Penicillin, Aspirin"></div>
            <div class="form-group full"><label>Medical Conditions</label><input type="text" id="profConditions" placeholder="e.g. Diabetes Type 2, Hypertension"></div>
            <div class="form-group"><label>Blood Group</label>
              <select id="profBlood"><option>Select</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>O+</option><option>O-</option><option>AB+</option><option>AB-</option></select>
            </div>
          </div>
          <button class="btn btn-primary" onclick="saveProfile()">üíæ Save Profile</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-admin">
  <div style="max-width:1100px;margin:0 auto;padding:2rem">
    <div class="admin-header">
      <h1 style="font-size:1.5rem;font-weight:800">‚öôÔ∏è Admin Panel ‚Äî MediScan AI</h1>
      <p style="opacity:.8;margin-top:.3rem">Manage medicines, users, and system settings</p>
    </div>
    <div style="display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="showAdminTab('medicines')">üíä Medicines</button>
      <button class="btn" style="background:#f1f5f9" onclick="showAdminTab('users')">üë• Users</button>
      <button class="btn" style="background:#f1f5f9" onclick="showAdminTab('add')">‚ûï Add Medicine</button>
    </div>
    <div id="adminMedicines">
      <div class="scan-card">
        <h2>üíä Medicine Database</h2>
        <div style="overflow-x:auto">
          <table class="admin-table" id="adminMedTable"></table>
        </div>
      </div>
    </div>
    <div id="adminUsers" style="display:none">
      <div class="scan-card">
        <h2>üë• Registered Users</h2>
        <div style="overflow-x:auto">
          <table class="admin-table" id="adminUserTable"></table>
        </div>
      </div>
    </div>
    <div id="adminAdd" style="display:none">
      <div class="scan-card">
        <h2>‚ûï Add New Medicine</h2>
        <div class="admin-form-grid">
          <div class="form-group"><label>Medicine Name</label><input type="text" id="addMedName" placeholder="Paracetamol"></div>
          <div class="form-group"><label>Brand Names</label><input type="text" id="addMedBrand" placeholder="Crocin, Tylenol"></div>
          <div class="form-group"><label>Salt/Composition</label><input type="text" id="addMedSalt" placeholder="Acetaminophen 500mg"></div>
          <div class="form-group"><label>Dosage</label><input type="text" id="addMedDose" placeholder="500mg-1000mg"></div>
          <div class="form-group"><label>Frequency</label><input type="text" id="addMedFreq" placeholder="Every 6-8 hours"></div>
          <div class="form-group"><label>Disease Treated</label><input type="text" id="addMedDisease" placeholder="Pain, Fever"></div>
          <div class="form-group full"><label>Side Effects</label><input type="text" id="addMedSE" placeholder="Nausea, Rash, Liver damage (overdose)"></div>
          <div class="form-group full"><label>Description</label><input type="text" id="addMedDesc" placeholder="Brief medicine description"></div>
        </div>
        <button class="btn btn-success" onclick="addMedicineAdmin()">‚úÖ Add Medicine</button>
      </div>
    </div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
  user: null,
  currentMed: null,
  scans: [],
  saved: [],
};

// ‚îÄ‚îÄ‚îÄ MEDICINE DATABASE ‚îÄ‚îÄ‚îÄ
const MEDICINES = {
  paracetamol: {
    name: "Paracetamol", brand: "Crocin / Tylenol / Dolo 650", type: "OTC",
    salt: "Acetaminophen 500mg / 650mg", category: "Analgesic, Antipyretic",
    dosage: "500mg‚Äì1000mg", frequency: "Every 6‚Äì8 hours", duration: "3‚Äì5 days (acute)",
    timing: "After food recommended", maxDaily: "4000mg / day",
    advantages: [
      "Safe for most people including children, pregnant women, and elderly",
      "Works quickly ‚Äî relieves fever and pain within 30‚Äì60 minutes",
      "Available OTC without prescription at low cost",
      "Does not affect stomach lining (unlike NSAIDs)",
      "No blood-thinning effect ‚Äî safe before surgery",
      "Multiple formulations: tablets, syrup, suppository, IV",
    ],
    disadvantages: [
      "Overdose can cause severe, irreversible liver damage",
      "Hidden in many combination medicines ‚Äî easy to accidentally overdose",
      "Does not reduce inflammation (not suitable for arthritis pain)",
      "No anti-platelet effect for cardiac use",
      "Regular heavy alcohol use raises liver damage risk significantly",
    ],
    ageDoses: {
      infant:  { dose:'10‚Äì15 mg/kg',    freq:'Every 6‚Äì8 hrs', max:'60 mg/kg/day',   note:'Liquid/drops form only. Weight-based dosing essential.',       icon:'üë∂', safe:true  },
      child:   { dose:'10‚Äì15 mg/kg',    freq:'Every 6‚Äì8 hrs', max:'60 mg/kg/day',   note:'Syrup or chewable tablet. Max 5 doses in 24 hrs.',             icon:'üßí', safe:true  },
      teen:    { dose:'500mg‚Äì750mg',    freq:'Every 6‚Äì8 hrs', max:'3000mg/day',     note:'Tablet form. Avoid alcohol. Report unusual skin reactions.',    icon:'üßë', safe:true  },
      adult:   { dose:'500mg‚Äì1000mg',   freq:'Every 6‚Äì8 hrs', max:'4000mg/day',     note:'Standard dose. Avoid with alcohol and liver conditions.',       icon:'üë®', safe:true  },
      elderly: { dose:'500mg‚Äì650mg',    freq:'Every 8 hrs',   max:'3000mg/day',     note:'Reduce dose. Monitor liver & kidney function regularly.',       icon:'üë¥', safe:true  },
    },
    disease: ["Fever", "Headache", "Body Pain", "Mild to Moderate Pain", "Cold & Flu"],
    description: "Paracetamol is one of the most widely used analgesics and antipyretics. It works by inhibiting prostaglandin synthesis in the central nervous system.",
    sideEffects: { common: ["Nausea", "Vomiting", "Stomach pain"], serious: ["Liver damage (overdose)", "Acute kidney injury", "Severe skin reactions (rare)"], rare: ["Thrombocytopenia", "Agranulocytosis"] },
    who: { adults:{ok:true,note:"Safe at recommended doses"}, children:{ok:true,note:"Dose based on weight (10-15mg/kg)"}, pregnant:{ok:true,note:"Considered safe in pregnancy"}, elderly:{ok:true,note:"Use lower doses; monitor liver"}, diabetes:{ok:true,note:"Generally safe"}, liver:{ok:false,note:"‚ö†Ô∏è Use with caution; dose reduction needed"} },
    precautions: ["Do not exceed 4g/day", "Avoid alcohol", "Check other meds for paracetamol content", "Not for liver disease without medical advice"],
    alternatives: ["Ibuprofen", "Aspirin (adults only)", "Diclofenac"],
    speciality: "General Medicine / Internal Medicine", rx: false
  },
  ibuprofen: {
    name: "Ibuprofen", brand: "Brufen / Advil / Nurofen", type: "OTC",
    salt: "Ibuprofen 200mg / 400mg / 600mg", category: "NSAID",
    dosage: "200mg‚Äì800mg", frequency: "Every 4‚Äì8 hours", duration: "5‚Äì7 days",
    timing: "After food (reduces GI side effects)", maxDaily: "3200mg / day",
    advantages: [
      "Anti-inflammatory ‚Äî treats pain AND underlying inflammation",
      "Effective for arthritis, menstrual cramps, dental pain, sprains",
      "Available OTC in standard doses (200‚Äì400mg)",
      "Faster onset than Paracetamol for inflammatory pain",
      "Reduces fever effectively",
    ],
    disadvantages: [
      "Can cause stomach ulcers and GI bleeding especially on empty stomach",
      "Unsafe in pregnancy (especially after 20 weeks ‚Äî fetal kidney risk)",
      "Can raise blood pressure and increase cardiovascular risk with long use",
      "Damages kidneys with prolonged use or in dehydrated patients",
      "Not safe for infants under 6 months",
      "Interacts with blood thinners (Warfarin) ‚Äî increases bleeding risk",
    ],
    ageDoses: {
      infant:  { dose:'NOT RECOMMENDED', freq:'‚Äî',             max:'‚Äî',             note:'‚õî Not safe under 6 months. Use Paracetamol instead.',          icon:'üë∂', safe:false },
      child:   { dose:'5‚Äì10 mg/kg',      freq:'Every 6‚Äì8 hrs', max:'40 mg/kg/day',  note:'Age 6 months+. Weight-based. Always give with food/milk.',      icon:'üßí', safe:true  },
      teen:    { dose:'200mg‚Äì400mg',     freq:'Every 6‚Äì8 hrs', max:'1200mg/day',    note:'With food. Avoid if asthma or GI history.',                     icon:'üßë', safe:true  },
      adult:   { dose:'200mg‚Äì800mg',     freq:'Every 4‚Äì8 hrs', max:'3200mg/day',    note:'With food. Short-term use preferred.',                          icon:'üë®', safe:true  },
      elderly: { dose:'200mg‚Äì400mg',     freq:'Every 8 hrs',   max:'1200mg/day',    note:'‚ö†Ô∏è High GI bleed risk. Use with PPI. Monitor kidneys.',          icon:'üë¥', safe:false },
    },
    disease: ["Pain", "Inflammation", "Fever", "Arthritis", "Menstrual Cramps", "Dental Pain"],
    description: "Ibuprofen is a nonsteroidal anti-inflammatory drug (NSAID) that reduces hormones causing inflammation and pain in the body.",
    sideEffects: { common: ["Nausea", "Heartburn", "Dizziness", "Stomach upset"], serious: ["GI bleeding", "Peptic ulcer", "Cardiovascular events", "Kidney damage"], rare: ["Severe allergic reaction", "Stevens-Johnson syndrome"] },
    who: { adults:{ok:true,note:"Safe with food and at recommended doses"}, children:{ok:true,note:"Age 6+ months, dose by weight"}, pregnant:{ok:false,note:"‚ö†Ô∏è AVOID ‚Äî especially after 20 weeks"}, elderly:{ok:false,note:"‚ö†Ô∏è Use with caution; GI bleed risk"}, diabetes:{ok:true,note:"Monitor kidney function"}, liver:{ok:false,note:"‚ö†Ô∏è Avoid in severe liver disease"} },
    precautions: ["Take with food", "Avoid in pregnancy (3rd trimester)", "Avoid with blood thinners", "Short-term use preferred"],
    alternatives: ["Paracetamol", "Naproxen", "Diclofenac"],
    speciality: "General Medicine / Rheumatology", rx: false
  },
  amoxicillin: {
    name: "Amoxicillin", brand: "Amoxil / Trimox", type: "Rx",
    salt: "Amoxicillin trihydrate 250mg / 500mg", category: "Antibiotic (Penicillin class)",
    dosage: "250mg‚Äì1000mg", frequency: "Every 8 hours (3√ó daily)", duration: "7‚Äì14 days",
    timing: "Can take with or without food", maxDaily: "3000mg / day",
    advantages: [
      "Broad-spectrum ‚Äî effective against wide range of bacteria",
      "Well-tolerated, even by children and pregnant women (Category B)",
      "Excellent oral bioavailability ‚Äî effective in tablet/syrup form",
      "One of the safest and most studied antibiotics in the world",
      "Available in child-friendly liquid formulation",
    ],
    disadvantages: [
      "Causes severe allergic reaction (anaphylaxis) in penicillin-allergic patients",
      "Destroys gut bacteria ‚Äî can cause antibiotic-associated diarrhea",
      "Ineffective against viral infections (cold, flu, COVID)",
      "Antibiotic resistance growing ‚Äî not always first choice anymore",
      "May reduce effectiveness of oral contraceptive pills",
      "Can cause C. difficile infection with prolonged use",
    ],
    ageDoses: {
      infant:  { dose:'25‚Äì50 mg/kg/day', freq:'Divided every 8 hrs', max:'90 mg/kg/day', note:'Suspension form. Prescription mandatory. Doctor-guided dosing.',icon:'üë∂', safe:true  },
      child:   { dose:'25‚Äì50 mg/kg/day', freq:'Every 8 hrs',         max:'90 mg/kg/day', note:'Syrup form preferred. Complete full 7‚Äì14 day course.',         icon:'üßí', safe:true  },
      teen:    { dose:'250mg‚Äì500mg',     freq:'Every 8 hrs',         max:'3000mg/day',   note:'Tablet or capsule. Complete full course. No alcohol.',          icon:'üßë', safe:true  },
      adult:   { dose:'250mg‚Äì1000mg',    freq:'Every 8 hrs',         max:'3000mg/day',   note:'Standard dose. Complete antibiotic course fully.',              icon:'üë®', safe:true  },
      elderly: { dose:'250mg‚Äì500mg',     freq:'Every 8‚Äì12 hrs',      max:'2000mg/day',   note:'Monitor kidney function. Adjust dose if eGFR reduced.',         icon:'üë¥', safe:true  },
    },
    disease: ["Bacterial Infections", "Ear Infection", "UTI", "Bronchitis", "Pneumonia", "Strep Throat"],
    description: "Amoxicillin is a broad-spectrum antibiotic in the penicillin group that fights bacteria in the body. Complete the full course.",
    sideEffects: { common: ["Diarrhea", "Nausea", "Skin rash"], serious: ["Severe allergic reaction (anaphylaxis)", "C. diff infection", "Liver toxicity"], rare: ["Crystalluria", "Serum sickness"] },
    who: { adults:{ok:true,note:"Safe as prescribed"}, children:{ok:true,note:"Dose by weight; syrup formulation available"}, pregnant:{ok:true,note:"Generally considered safe (Category B)"}, elderly:{ok:true,note:"Monitor renal function"}, diabetes:{ok:true,note:"Suspension may contain sugar"}, liver:{ok:true,note:"Caution in severe hepatic impairment"} },
    precautions: ["Penicillin allergy ‚Äî absolute contraindication", "Complete full antibiotic course", "Not for viral infections", "May reduce oral contraceptive efficacy"],
    alternatives: ["Azithromycin", "Clarithromycin", "Doxycycline"],
    speciality: "Infectious Disease / General Practice", rx: true
  },
  metformin: {
    name: "Metformin", brand: "Glucophage / Glycomet", type: "Rx",
    salt: "Metformin Hydrochloride 500mg / 850mg / 1000mg", category: "Antidiabetic (Biguanide)",
    dosage: "500mg‚Äì1000mg", frequency: "2‚Äì3 times daily with meals", duration: "Long-term / Chronic",
    timing: "During or after meals", maxDaily: "2550mg / day",
    advantages: [
      "First-line, most recommended treatment for Type 2 Diabetes worldwide",
      "Does NOT cause hypoglycemia (low blood sugar) when used alone",
      "Can aid modest weight loss (unlike most diabetes drugs)",
      "Cardioprotective ‚Äî reduces heart attack and stroke risk in diabetics",
      "Very affordable and widely available",
      "Also used for PCOS management (off-label)",
    ],
    disadvantages: [
      "Causes GI side effects (nausea, diarrhea) especially when starting",
      "Rare but potentially fatal lactic acidosis ‚Äî especially with kidney disease",
      "Must be stopped before CT scans with contrast dye",
      "Long-term use depletes Vitamin B12",
      "Contraindicated if kidney function is poor (eGFR < 30)",
      "Not for Type 1 Diabetes",
    ],
    ageDoses: {
      infant:  { dose:'NOT INDICATED',   freq:'‚Äî',                   max:'‚Äî',             note:'‚õî Not used in infants. Not approved under age 10.',            icon:'üë∂', safe:false },
      child:   { dose:'500mg‚Äì1000mg/day',freq:'Once or twice daily', max:'2000mg/day',    note:'Age 10+ only for Type 2 DM. Prescribed by paediatrician.',     icon:'üßí', safe:true  },
      teen:    { dose:'500mg‚Äì1500mg/day',freq:'Twice daily',         max:'2000mg/day',    note:'Age 10+ for T2DM/PCOS. Take with meals. Monitor blood sugar.',  icon:'üßë', safe:true  },
      adult:   { dose:'500mg‚Äì1000mg',    freq:'2‚Äì3 times daily',     max:'2550mg/day',    note:'First-line for T2DM. Take with food. Check kidney function.',   icon:'üë®', safe:true  },
      elderly: { dose:'500mg‚Äì850mg',     freq:'Twice daily',         max:'2000mg/day',    note:'‚ö†Ô∏è Avoid if eGFR<45. Monitor B12 and kidney function.',         icon:'üë¥', safe:false },
    },
    disease: ["Type 2 Diabetes", "Insulin Resistance", "PCOS (off-label)", "Pre-diabetes"],
    description: "Metformin is the first-line oral medication for type 2 diabetes management. It lowers blood glucose by decreasing hepatic glucose production.",
    sideEffects: { common: ["Nausea", "Diarrhea", "Stomach upset", "Loss of appetite"], serious: ["Lactic acidosis (rare but serious)", "Vitamin B12 deficiency (long-term)"], rare: ["Megaloblastic anemia", "Hypoglycemia (rare alone)"] },
    who: { adults:{ok:true,note:"First-line for T2DM"}, children:{ok:true,note:"Age 10+ for Type 2 DM"}, pregnant:{ok:false,note:"‚ö†Ô∏è Use with caution; insulin preferred"}, elderly:{ok:false,note:"‚ö†Ô∏è Avoid if eGFR<45"}, diabetes:{ok:true,note:"‚úÖ This IS the diabetes medication"}, liver:{ok:false,note:"‚ö†Ô∏è Contraindicated in liver failure"} },
    precautions: ["Hold before CT/MRI contrast", "Check kidney function regularly", "Stop if dehydration or illness", "Monitor B12 levels long-term"],
    alternatives: ["Glipizide", "Sitagliptin", "Empagliflozin"],
    speciality: "Endocrinology / Diabetology", rx: true
  },
  aspirin: {
    name: "Aspirin", brand: "Disprin / Ecosprin / Bayer Aspirin", type: "OTC",
    salt: "Acetylsalicylic acid 75mg / 150mg / 325mg / 650mg", category: "NSAID / Antiplatelet",
    dosage: "75mg (cardiac) / 325mg‚Äì650mg (pain)", frequency: "Once daily (cardiac) / Every 4‚Äì6 hrs (pain)", duration: "Chronic (cardiac) / Short-term (pain)",
    timing: "After food", maxDaily: "4000mg / day (pain)",
    advantages: [
      "Prevents heart attacks and strokes in high-risk cardiac patients",
      "Anti-platelet action ‚Äî keeps blood from clotting dangerously",
      "Very cheap and widely available",
      "Low-dose (75mg) highly effective for long-term cardiac protection",
      "Used in emergency management of heart attacks",
    ],
    disadvantages: [
      "‚õî Absolutely contraindicated in children under 16 (Reye syndrome ‚Äî brain/liver failure)",
      "Causes stomach ulcers and GI bleeding ‚Äî especially in elderly",
      "Blood thinning increases bleeding risk during surgery",
      "Should not be used in pregnancy especially last trimester",
      "Aspirin-sensitive asthma patients can have severe bronchospasm",
      "Higher doses cause salicylism ‚Äî ringing in ears, confusion",
    ],
    ageDoses: {
      infant:  { dose:'CONTRAINDICATED', freq:'‚Äî',             max:'‚Äî',             note:'‚õî Absolutely contraindicated. Risk of Reye Syndrome.',           icon:'üë∂', safe:false },
      child:   { dose:'CONTRAINDICATED', freq:'‚Äî',             max:'‚Äî',             note:'‚õî Never give to under-16s. Use Paracetamol instead.',            icon:'üßí', safe:false },
      teen:    { dose:'CONTRAINDICATED', freq:'‚Äî',             max:'‚Äî',             note:'‚õî Avoid under 16 years. Reye Syndrome risk. Use alternatives.', icon:'üßë', safe:false },
      adult:   { dose:'75mg (cardiac)\n325‚Äì650mg (pain)', freq:'Once daily / Every 4‚Äì6 hrs', max:'4000mg/day', note:'Standard use. With food. Inform surgeon before procedures.', icon:'üë®', safe:true },
      elderly: { dose:'75mg‚Äì100mg (cardiac)', freq:'Once daily', max:'100mg/day (cardiac)', note:'‚ö†Ô∏è High GI bleed risk. Use with PPI. Avoid high doses.',       icon:'üë¥', safe:false },
    },
    disease: ["Pain", "Fever", "Heart Attack Prevention", "Stroke Prevention", "Blood Clot Prevention"],
    description: "Aspirin is one of the oldest medicines, used as analgesic, anti-inflammatory, antipyretic, and antiplatelet agent for cardiovascular protection.",
    sideEffects: { common: ["Stomach irritation", "Nausea", "Heartburn", "Increased bleeding time"], serious: ["GI bleeding", "Peptic ulcer", "Reye syndrome (children)", "Hemorrhagic stroke"], rare: ["Salicylism (overdose)", "Bronchospasm"] },
    who: { adults:{ok:true,note:"Safe at recommended doses"}, children:{ok:false,note:"‚ö†Ô∏è AVOID under 16 ‚Äî risk of Reye syndrome"}, pregnant:{ok:false,note:"‚ö†Ô∏è Avoid high doses"}, elderly:{ok:false,note:"‚ö†Ô∏è Higher GI bleed risk; use with PPI"}, diabetes:{ok:true,note:"Low-dose often recommended"}, liver:{ok:false,note:"‚ö†Ô∏è Avoid in severe liver disease"} },
    precautions: ["Avoid in children under 16", "Take with antacid or after food", "Blood thinning effect ‚Äî inform surgeon", "Avoid if aspirin allergy or asthma"],
    alternatives: ["Paracetamol (pain/fever)", "Clopidogrel (antiplatelet)", "Ibuprofen"],
    speciality: "Cardiology / General Medicine", rx: false
  },
  omeprazole: {
    name: "Omeprazole", brand: "Prilosec / Omez / Losec", type: "OTC/Rx",
    salt: "Omeprazole 10mg / 20mg / 40mg", category: "Proton Pump Inhibitor (PPI)",
    dosage: "20mg‚Äì40mg", frequency: "Once daily (or twice for severe cases)", duration: "4‚Äì8 weeks",
    timing: "30‚Äì60 minutes BEFORE meals (empty stomach)", maxDaily: "80mg / day",
    advantages: [
      "Highly effective for acid reflux, GERD, and peptic ulcers",
      "Significant symptom relief within 1‚Äì4 days",
      "Protects stomach lining when taking NSAIDs (e.g. Ibuprofen, Aspirin)",
      "Used to eradicate H. pylori (triple therapy) ‚Äî treats root cause of ulcers",
      "Available OTC and as prescription ‚Äî flexible access",
    ],
    disadvantages: [
      "Long-term use depletes Magnesium and Vitamin B12",
      "Increases fracture risk (hip, wrist, spine) with long-term use",
      "May mask symptoms of stomach cancer ‚Äî delay in diagnosis",
      "Rebound acid hypersecretion if stopped abruptly after long use",
      "Increases risk of C. difficile and pneumonia with prolonged use",
      "Interacts with Clopidogrel (cardiac drug) ‚Äî reduces its effectiveness",
    ],
    ageDoses: {
      infant:  { dose:'0.5‚Äì1.5 mg/kg',  freq:'Once daily',    max:'20mg/day',      note:'Only under specialist supervision. Granules for suspension.', icon:'üë∂', safe:true  },
      child:   { dose:'10mg‚Äì20mg',       freq:'Once daily',    max:'20mg/day',      note:'Age 1+. Weight 10‚Äì20kg: 10mg. Above 20kg: 20mg/day.',         icon:'üßí', safe:true  },
      teen:    { dose:'20mg',            freq:'Once daily',    max:'40mg/day',      note:'Standard teen dose. Take 30 min before breakfast.',            icon:'üßë', safe:true  },
      adult:   { dose:'20mg‚Äì40mg',       freq:'Once daily',    max:'80mg/day',      note:'30‚Äì60 min before meals. Long-term: monitor Mg and B12.',       icon:'üë®', safe:true  },
      elderly: { dose:'20mg',            freq:'Once daily',    max:'40mg/day',      note:'Monitor Mg, B12, and bone density on long-term therapy.',      icon:'üë¥', safe:true  },
    },
    disease: ["Acid Reflux / GERD", "Peptic Ulcer", "H. pylori Eradication", "Zollinger-Ellison Syndrome"],
    description: "Omeprazole is a proton pump inhibitor that reduces stomach acid production. Widely used for GERD, ulcers, and acid-related conditions.",
    sideEffects: { common: ["Headache", "Diarrhea", "Nausea", "Abdominal pain"], serious: ["C. diff infection (long-term)", "Hypomagnesemia", "Bone fracture risk (long-term)"], rare: ["Interstitial nephritis", "Acute liver failure"] },
    who: { adults:{ok:true,note:"Widely prescribed and safe"}, children:{ok:true,note:"Pediatric doses available (age 1+)"}, pregnant:{ok:true,note:"Generally considered safe"}, elderly:{ok:true,note:"Monitor Mg and B12 long-term"}, diabetes:{ok:true,note:"Safe; no significant interaction"}, liver:{ok:false,note:"‚ö†Ô∏è Reduce dose in severe hepatic impairment"} },
    precautions: ["Take before meals for best effect", "Long-term use: monitor Mg, B12, bone density", "May mask symptoms of gastric cancer", "Avoid stopping abruptly after long use"],
    alternatives: ["Pantoprazole", "Esomeprazole", "Antacids"],
    speciality: "Gastroenterology / General Medicine", rx: false
  }
};

// ‚îÄ‚îÄ‚îÄ DISEASE DATABASE ‚îÄ‚îÄ‚îÄ
const DISEASES = {
  fever:     { label:'Fever / Pyrexia',              icon:'üå°Ô∏è', color:'#ef4444', medicines:['paracetamol','ibuprofen'], specialists:['General Physician','Infectious Disease'], hospitalType:'General / Emergency' },
  headache:  { label:'Headache / Migraine',           icon:'ü§ï', color:'#f59e0b', medicines:['paracetamol','ibuprofen','aspirin'], specialists:['Neurologist','General Physician'], hospitalType:'Neurology / General' },
  diabetes:  { label:'Diabetes (Type 2)',              icon:'ü©∏', color:'#0ea5e9', medicines:['metformin'], specialists:['Endocrinologist','Diabetologist'], hospitalType:'Endocrinology / Diabetes Clinic' },
  infection: { label:'Bacterial Infection',            icon:'ü¶†', color:'#10b981', medicines:['amoxicillin'], specialists:['Infectious Disease Specialist','General Physician'], hospitalType:'Infectious Disease / General' },
  acidity:   { label:'Acid Reflux / GERD',             icon:'üî•', color:'#f97316', medicines:['omeprazole'], specialists:['Gastroenterologist'], hospitalType:'Gastroenterology' },
  pain:      { label:'Body Pain / Inflammation',       icon:'üí¢', color:'#8b5cf6', medicines:['ibuprofen','paracetamol'], specialists:['Orthopedist','Rheumatologist','General Physician'], hospitalType:'Orthopaedics / General' },
  heart:     { label:'Cardiac / Heart Disease',        icon:'‚ù§Ô∏è', color:'#dc2626', medicines:['aspirin'], specialists:['Cardiologist'], hospitalType:'Cardiology / Cardiac Care' },
  arthritis: { label:'Arthritis / Joint Pain',         icon:'ü¶¥', color:'#d97706', medicines:['ibuprofen'], specialists:['Rheumatologist','Orthopedist'], hospitalType:'Rheumatology / Ortho' },
  cold:      { label:'Cold & Flu',                     icon:'ü§ß', color:'#06b6d4', medicines:['paracetamol','ibuprofen'], specialists:['General Physician','ENT'], hospitalType:'General Medicine' },
  uti:       { label:'Urinary Tract Infection',        icon:'üíß', color:'#0066cc', medicines:['amoxicillin'], specialists:['Urologist','General Physician'], hospitalType:'Urology / General' },
  stomach:   { label:'Stomach Ulcer / Gastritis',      icon:'ü´É', color:'#84cc16', medicines:['omeprazole'], specialists:['Gastroenterologist'], hospitalType:'Gastroenterology' },
  stroke:    { label:'Stroke / Blood Clot Prevention', icon:'üß†', color:'#7c3aed', medicines:['aspirin'], specialists:['Neurologist','Cardiologist'], hospitalType:'Neurology / Cardiology' },
  pcos:      { label:'PCOS / Hormonal Disorder',       icon:'üå∏', color:'#ec4899', medicines:['metformin'], specialists:['Gynaecologist','Endocrinologist'], hospitalType:'Gynaecology / Endocrinology' },
  dental:    { label:'Toothache / Dental Pain',        icon:'ü¶∑', color:'#64748b', medicines:['ibuprofen','paracetamol'], specialists:['Dentist'], hospitalType:'Dental / Oral Surgery' },
  pneumonia: { label:'Pneumonia / Chest Infection',    icon:'ü´Å', color:'#0284c7', medicines:['amoxicillin'], specialists:['Pulmonologist','Infectious Disease'], hospitalType:'Pulmonology / General' },
};

const HOSPITALS = [
  { id:'h1', name:"Apollo Hospitals",  type:"Multi-Speciality", distance:"1.2 km", rating:4.7, beds:500, emergency:true,  icon:"üè•", bg:"#e0f2fe",  speciality:"Cardiology, Oncology, Orthopedics",    phone:"+914023607777",  display_phone:"+91-40-2360-7777",  hours:"24/7",  tags:['cardiology','general','ortho'], lat:17.4239, lng:78.4738, city:'Hyderabad' },
  { id:'h2', name:"AIIMS Delhi",        type:"Government Research Hospital", distance:"2.8 km", rating:4.6, beds:1200, emergency:true, icon:"üèõÔ∏è", bg:"#d1fae5", speciality:"All Specialities",                     phone:"+911126588500", display_phone:"+91-11-2658-8500", hours:"24/7",  tags:['general','neurology','cardiology','infection'], lat:28.5672, lng:77.2100, city:'Delhi' },
  { id:'h3', name:"Fortis Healthcare",  type:"Private Multi-Speciality",    distance:"3.4 km", rating:4.5, beds:380,  emergency:true,  icon:"üî¨", bg:"#fce7f3", speciality:"Neurology, Cardiology, Ortho",         phone:"+911249210021", display_phone:"+91-124-492-1021", hours:"24/7",  tags:['neurology','cardiology','ortho'], lat:28.4726, lng:77.0337, city:'Gurugram' },
  { id:'h4', name:"Narayana Health",    type:"Cardiac & Multi-Speciality",  distance:"4.1 km", rating:4.8, beds:650,  emergency:true,  icon:"‚ù§Ô∏è",  bg:"#fee2e2", speciality:"Cardiology, Pediatrics, Oncology",    phone:"+918071222200", display_phone:"+91-80-7122-2200", hours:"24/7",  tags:['cardiology','general'], lat:12.9167, lng:77.5667, city:'Bangalore' },
  { id:'h5', name:"Max Super Speciality Hospital", type:"Private Hospital", distance:"5.0 km", rating:4.4, beds:290, emergency:false, icon:"‚öïÔ∏è", bg:"#fef3c7", speciality:"General Surgery, Internal Medicine",    phone:"+911126515050", display_phone:"+91-11-2651-5050", hours:"8 AM‚Äì10 PM", tags:['general','gastro'], lat:28.6273, lng:77.3654, city:'Delhi' },
  { id:'h6', name:"Kokilaben Dhirubhai Ambani Hospital", type:"Super-Speciality", distance:"6.2 km", rating:4.8, beds:750, emergency:true, icon:"üè•", bg:"#e0e7ff", speciality:"Oncology, Transplant, Neurology", phone:"+912230999999", display_phone:"+91-22-3099-9999", hours:"24/7", tags:['neurology','cardiology','ortho','infection'], lat:19.1136, lng:72.8369, city:'Mumbai' },
  { id:'h7', name:"Medanta ‚Äì The Medicity", type:"Multi-Speciality",        distance:"7.5 km", rating:4.7, beds:1250, emergency:true, icon:"üåü", bg:"#fdf4ff", speciality:"Cardiac, Transplant, Neuro",             phone:"+911244141414", display_phone:"+91-124-4141-414", hours:"24/7",  tags:['cardiology','neurology','diabetes'], lat:28.4522, lng:77.0310, city:'Gurugram' },
  { id:'h8', name:"Manipal Hospitals",  type:"Multi-Speciality",            distance:"8.1 km", rating:4.5, beds:600,  emergency:true,  icon:"üè•", bg:"#ecfdf5",  speciality:"General, Ortho, Gastro",               phone:"+918025024444", display_phone:"+91-80-2502-4444", hours:"24/7",  tags:['general','ortho','gastro','infection'], lat:12.9591, lng:77.6437, city:'Bangalore' },
];

const DOCTORS = [
  { id:'d1', name:"Dr. Rajesh Kumar",    spec:"Cardiologist",                   hospital:"Apollo Hospitals",   exp:"18 yrs", fee:"‚Çπ800",  rating:4.9, available:"Mon-Sat 10AM-2PM",  phone:"+919876543210", display_phone:"+91-98765-43210", bg:"#0066CC", lat:23.0373, lng:72.5679, distance:"‚Äî", tags:['cardiology','heart','stroke'] },
  { id:'d2', name:"Dr. Priya Sharma",    spec:"General Physician",              hospital:"AIIMS Delhi",         exp:"12 yrs", fee:"‚Çπ500",  rating:4.8, available:"Mon-Fri 9AM-5PM",   phone:"+918765432109", display_phone:"+91-87654-32109", bg:"#10B981", lat:22.3128, lng:73.1794, distance:"‚Äî", tags:['general','fever','cold','infection'] },
  { id:'d3', name:"Dr. Anand Mehta",     spec:"Endocrinologist / Diabetologist",hospital:"Fortis Healthcare",  exp:"15 yrs", fee:"‚Çπ1000", rating:4.7, available:"Tue-Sat 11AM-4PM", phone:"+917654321098", display_phone:"+91-76543-21098", bg:"#F59E0B", lat:19.1136, lng:72.8697, distance:"‚Äî", tags:['diabetes','pcos','general'] },
  { id:'d4', name:"Dr. Sunita Rao",      spec:"Gastroenterologist",             hospital:"Narayana Health",     exp:"20 yrs", fee:"‚Çπ900",  rating:4.9, available:"Mon-Fri 8AM-1PM",   phone:"+916543210987", display_phone:"+91-65432-10987", bg:"#EF4444", lat:12.9716, lng:77.5946, distance:"‚Äî", tags:['gastro','acidity','stomach'] },
  { id:'d5', name:"Dr. Vikram Singh",    spec:"Infectious Disease Specialist",  hospital:"Max Hospital",        exp:"14 yrs", fee:"‚Çπ750",  rating:4.6, available:"Mon-Sat 2PM-7PM",   phone:"+915432109876", display_phone:"+91-54321-09876", bg:"#8B5CF6", lat:28.6692, lng:77.2172, distance:"‚Äî", tags:['infection','pneumonia','uti'] },
  { id:'d6', name:"Dr. Meera Nair",      spec:"Rheumatologist",                 hospital:"Apollo Hospitals",    exp:"11 yrs", fee:"‚Çπ850",  rating:4.7, available:"Wed-Sun 10AM-3PM",  phone:"+914321098765", display_phone:"+91-43210-98765", bg:"#EC4899", lat:23.0373, lng:72.5679, distance:"‚Äî", tags:['ortho','arthritis','pain'] },
  { id:'d7', name:"Dr. Suresh Patel",    spec:"Neurologist",                    hospital:"Kokilaben Hospital",  exp:"22 yrs", fee:"‚Çπ1200", rating:4.9, available:"Mon-Thu 9AM-1PM",   phone:"+913210987654", display_phone:"+91-32109-87654", bg:"#7C3AED", lat:19.1197, lng:72.8262, distance:"‚Äî", tags:['neurology','headache','stroke'] },
  { id:'d8', name:"Dr. Kavitha Reddy",   spec:"General Physician / Internist",  hospital:"Manipal Hospitals",   exp:"9 yrs",  fee:"‚Çπ400",  rating:4.7, available:"Daily 8AM-8PM",      phone:"+912109876543", display_phone:"+91-21098-76543", bg:"#059669", lat:13.0035, lng:77.5560, distance:"‚Äî", tags:['general','fever','cold','pain'] },
  { id:'d9', name:"Dr. Arun Joshi",      spec:"Orthopedic Surgeon",             hospital:"Medanta",             exp:"16 yrs", fee:"‚Çπ1100", rating:4.8, available:"Mon-Sat 10AM-4PM",  phone:"+911098765432", display_phone:"+91-10987-65432", bg:"#D97706", lat:28.4432, lng:77.0430, distance:"‚Äî", tags:['ortho','arthritis','pain'] },
  { id:'d10',name:"Dr. Deepa Menon",     spec:"Gynaecologist / Endocrinologist",hospital:"AIIMS Delhi",         exp:"13 yrs", fee:"‚Çπ700",  rating:4.8, available:"Mon-Fri 10AM-2PM",  phone:"+910987654321", display_phone:"+91-09876-54321", bg:"#DB2777", lat:28.5672, lng:77.2100, distance:"‚Äî", tags:['pcos','diabetes','general'] },
];

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ
function navigate(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const target = document.getElementById('page-'+page);
  if(target) target.classList.add('active');
  window.scrollTo(0,0);
  if(page === 'nearby')    initNearby();
  if(page === 'dashboard') initDashboard();
  if(page === 'admin')     initAdmin();
  if(page === 'scanner') {
    // Reset progress and results but keep last tab
    document.getElementById('scanProgress').classList.remove('active');
    document.getElementById('medicineResult').classList.remove('active');
    document.getElementById('medicineResult').innerHTML = '';
  }
}

// ‚îÄ‚îÄ‚îÄ AGE CALCULATION FROM DOB ‚îÄ‚îÄ‚îÄ
function calcAgeFromDOB() {
  const day   = parseInt(document.getElementById('regDobDay').value);
  const month = parseInt(document.getElementById('regDobMonth').value);
  const year  = parseInt(document.getElementById('regDobYear').value);
  if(!day || !month || !year) return;

  const today = new Date();
  const dob   = new Date(year, month - 1, day);
  if(dob > today) { showToast('Date of birth cannot be in the future', 'error'); return; }

  let age = today.getFullYear() - dob.getFullYear();
  const m = today.getMonth() - dob.getMonth();
  if(m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;

  // Determine age group
  let group, groupLabel, groupClass, groupIcon;
  if(age < 2)       { group='infant';  groupLabel='üë∂ Infant (0‚Äì2 yrs)';    groupClass='agb-child';   groupIcon='üë∂'; }
  else if(age < 12) { group='child';   groupLabel='üßí Child (2‚Äì11 yrs)';    groupClass='agb-child';   groupIcon='üßí'; }
  else if(age < 18) { group='teen';    groupLabel='üßë Teenager (12‚Äì17 yrs)';groupClass='agb-child';   groupIcon='üßë'; }
  else if(age < 60) { group='adult';   groupLabel='üë® Adult (18‚Äì59 yrs)';   groupClass='agb-adult';   groupIcon='üë®'; }
  else              { group='elderly'; groupLabel='üë¥ Elderly (60+ yrs)';   groupClass='agb-elderly'; groupIcon='üë¥'; }

  // Birthday check
  const isBirthday = (today.getDate()===day && today.getMonth()+1===month);
  const dobStr = `${day} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][month-1]} ${year}`;

  // Update preview
  document.getElementById('agePreviewNum').textContent  = age;
  document.getElementById('agePreviewLabel').textContent = isBirthday ? 'üéâ Happy Birthday!' : 'Years Old';
  document.getElementById('agePreviewDob').textContent   = `Born: ${dobStr}`;
  document.getElementById('agePreviewBadge').textContent = groupLabel;
  document.getElementById('agePreviewBadge').className   = `age-group-badge ${groupClass}`;
  document.getElementById('agePreview').classList.add('show');

  // Store in hidden fields
  document.getElementById('regAge').value      = age;
  document.getElementById('regDobFull').value  = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  document.getElementById('regAgeGroup').value = group;
}

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ REGISTER LOCATION DETECTION ‚îÄ‚îÄ‚îÄ
const INDIAN_CITIES = [
  { name:'Mumbai, Maharashtra',      lat:19.0760, lng:72.8777 },
  { name:'Delhi, Delhi',             lat:28.6139, lng:77.2090 },
  { name:'Bangalore, Karnataka',     lat:12.9716, lng:77.5946 },
  { name:'Hyderabad, Telangana',     lat:17.3850, lng:78.4867 },
  { name:'Chennai, Tamil Nadu',      lat:13.0827, lng:80.2707 },
  { name:'Kolkata, West Bengal',     lat:22.5726, lng:88.3639 },
  { name:'Ahmedabad, Gujarat',       lat:23.0225, lng:72.5714 },
  { name:'Pune, Maharashtra',        lat:18.5204, lng:73.8567 },
  { name:'Surat, Gujarat',           lat:21.1702, lng:72.8311 },
  { name:'Vadodara, Gujarat',        lat:22.3072, lng:73.1812 },
  { name:'Jaipur, Rajasthan',        lat:26.9124, lng:75.7873 },
  { name:'Lucknow, Uttar Pradesh',   lat:26.8467, lng:80.9462 },
  { name:'Kanpur, Uttar Pradesh',    lat:26.4499, lng:80.3319 },
  { name:'Nagpur, Maharashtra',      lat:21.1458, lng:79.0882 },
  { name:'Indore, Madhya Pradesh',   lat:22.7196, lng:75.8577 },
  { name:'Bhopal, Madhya Pradesh',   lat:23.2599, lng:77.4126 },
  { name:'Patna, Bihar',             lat:25.5941, lng:85.1376 },
  { name:'Coimbatore, Tamil Nadu',   lat:11.0168, lng:76.9558 },
  { name:'Kochi, Kerala',            lat:9.9312,  lng:76.2673 },
  { name:'Chandigarh, Chandigarh',   lat:30.7333, lng:76.7794 },
  { name:'Guwahati, Assam',          lat:26.1445, lng:91.7362 },
  { name:'Visakhapatnam, AP',        lat:17.6868, lng:83.2185 },
  { name:'Agra, Uttar Pradesh',      lat:27.1767, lng:78.0081 },
  { name:'Varanasi, Uttar Pradesh',  lat:25.3176, lng:82.9739 },
  { name:'Srinagar, J&K',            lat:34.0837, lng:74.7973 },
];

function regLocationTyping(val) {
  const sug = document.getElementById('regLocationSuggestions');
  if(!val || val.length < 2) { sug.style.display='none'; return; }
  const q = val.toLowerCase();
  const matches = INDIAN_CITIES.filter(c => c.name.toLowerCase().includes(q)).slice(0,6);
  if(!matches.length) { sug.style.display='none'; return; }
  sug.style.display = 'block';
  sug.innerHTML = matches.map(c => `
    <div class="reg-loc-suggestion" onclick="selectRegCity('${c.name}',${c.lat},${c.lng})">
      üìç ${c.name}
    </div>`).join('');
}

function selectRegCity(name, lat, lng) {
  document.getElementById('regLocation').value = name;
  document.getElementById('regLat').value  = lat;
  document.getElementById('regLng').value  = lng;
  document.getElementById('regCity').value = name.split(',')[0].trim();
  document.getElementById('regLocationSuggestions').style.display = 'none';
  showRegLocationStatus('success', `üìç ${name}`);
  showRegNearbyPreview(lat, lng);
}

function detectRegLocation() {
  const btn = document.getElementById('regGpsBtn');
  btn.textContent = '‚è≥ Locating...';
  btn.disabled = true;
  showRegLocationStatus('loading', '‚è≥ Detecting your GPS location...');
  document.getElementById('regNearbyPreview').style.display = 'none';

  if(!navigator.geolocation) {
    showRegLocationStatus('error', '‚ùå GPS not supported. Please type your city.');
    btn.textContent = 'üìç Detect'; btn.disabled = false; return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    document.getElementById('regLat').value = lat;
    document.getElementById('regLng').value = lng;

    // Reverse-geocode using nearest city in our list
    let nearest = INDIAN_CITIES[0], minDist = Infinity;
    INDIAN_CITIES.forEach(c => {
      const d = calcDistance(lat, lng, c.lat, c.lng);
      if(d < minDist) { minDist = d; nearest = c; }
    });

    const city = nearest.name.split(',')[0].trim();
    document.getElementById('regLocation').value = nearest.name;
    document.getElementById('regCity').value = city;
    showRegLocationStatus('success', `‚úÖ Location detected: ${nearest.name} (${minDist.toFixed(1)} km away)`);
    showRegNearbyPreview(lat, lng);
    btn.textContent = '‚úÖ Detected'; btn.disabled = false;
  }, err => {
    showRegLocationStatus('error', '‚ùå GPS access denied. Please type your city manually.');
    btn.textContent = 'üìç Detect'; btn.disabled = false;
  }, { timeout:8000 });
}

function showRegLocationStatus(type, msg) {
  const el = document.getElementById('regLocationStatus');
  el.style.display = 'block';
  el.className = `reg-loc-status ${type}`;
  el.textContent = msg;
}

function showRegNearbyPreview(lat, lng) {
  // Sort HOSPITALS by distance from given coords and show top 3
  const ranked = HOSPITALS.map(h => ({
    ...h, dist: calcDistance(lat, lng, h.lat, h.lng)
  })).sort((a,b) => a.dist - b.dist).slice(0, 3);

  const preview = document.getElementById('regNearbyPreview');
  preview.style.display = 'block';
  preview.innerHTML = `
    <div style="background:linear-gradient(135deg,#0066cc12,#0099ff08);border:1.5px solid #bfdbfe;border-radius:14px;padding:1rem 1.1rem">
      <div style="font-size:.84rem;font-weight:800;color:var(--primary);margin-bottom:.7rem;display:flex;align-items:center;gap:.4rem">
        üè• 3 Nearest Hospitals to Your Location
      </div>
      ${ranked.map((h, i) => `
        <div class="reg-nearby-card" style="${i===0?'border-color:#bfdbfe;background:#f0f9ff;':''}">
          <div class="reg-nearby-icon">${h.icon}</div>
          <div class="reg-nearby-info">
            <strong>${i===0?'<span style="color:#0066cc">‚≠ê Nearest ‚Äî </span>':''}${h.name}</strong>
            <span>${h.type} ¬∑ ${h.city}${h.emergency?' ¬∑ üö® 24/7 Emergency':''}</span>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div class="reg-nearby-dist">${h.dist < 1 ? Math.round(h.dist*1000)+' m' : h.dist.toFixed(1)+' km'}</div>
            <div style="font-size:.7rem;color:var(--text-muted)">away</div>
          </div>
        </div>`).join('')}
      <p style="font-size:.75rem;color:var(--text-muted);margin-top:.6rem;border-top:1px solid #e2e8f0;padding-top:.5rem">
        ‚úÖ After signing up, <strong>Nearby Hospitals</strong> will be sorted by distance from your location.
      </p>
    </div>`;
}

async function register() {
  const name  = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const pass  = document.getElementById('regPass').value;
  const age   = parseInt(document.getElementById('regAge').value) || null;
  const dob   = document.getElementById('regDobFull').value;
  const ageGroup = document.getElementById('regAgeGroup').value || 'adult';
  const gender   = document.getElementById('regGender').value;
  const location = document.getElementById('regLocation').value.trim();
  const lat      = parseFloat(document.getElementById('regLat').value) || null;
  const lng      = parseFloat(document.getElementById('regLng').value) || null;
  const city     = document.getElementById('regCity').value.trim() || location.split(',')[0].trim() || '';

  if(!name || !email || !pass) { showToast('Please fill all required fields', 'error'); return; }
  if(pass.length < 8) { showToast('Password must be at least 8 characters', 'error'); return; }

  showToast('Creating account‚Ä¶', 'info');

  // 1. Sign up with Supabase Auth
  const { data: authData, error: authError } = await _sb.auth.signUp({ email, password: pass });
  if(authError) { showToast('Registration failed: ' + authError.message, 'error'); return; }

  const sbUser = authData.user;
  if(!sbUser) { showToast('Signup succeeded but no user returned. Check email for verification link.', 'info'); return; }

  // 2. Create profile row
  const profile = {
    id: sbUser.id, name, phone, age,
    dob: dob || null,
    age_group: ageGroup, gender,
    location, lat, lng, city,
    allergies:  document.getElementById('regAllergies').value,
    conditions: document.getElementById('regConditions').value,
    role: 'user',
  };
  await sbUpsertProfile(profile);

  // Store coords for nearby page
  if(lat && lng) {
    userCoords = { lat, lng };
    localStorage.setItem('medi_user_coords', JSON.stringify({ lat, lng, city }));
  }

  const user = profileToUser(sbUser, profile);
  await _loginUserFinalize(user);
  showToast(`Welcome to MediScan AI, ${name}! üéâ`, 'success');
  if(lat && lng) setTimeout(() => showToast(`üìç Showing hospitals near ${city || location} ‚Üí`, 'success'), 1200);
}

async function loginWithPass() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!email || !pass) { showToast('Please enter email and password', 'error'); return; }

  showToast('Signing in‚Ä¶', 'info');

  const { data, error } = await _sb.auth.signInWithPassword({ email, password: pass });
  if(error) {
    // Fall back to demo accounts for convenience
    if(email === 'admin@mediscan.ai' && pass === 'admin123') {
      await _loginUserFinalize({ id:'admin', name:'Admin User', email, role:'admin', age:30, allergies:'', conditions:'' });
      navigate('admin'); return;
    }
    if(email === 'demo@mediscan.ai' && pass === 'demo123') {
      await _loginUserFinalize({ id:'demo', name:'Demo User', email, role:'user', age:28, allergies:'Penicillin', conditions:'Diabetes' });
      return;
    }
    showToast('Invalid credentials: ' + error.message, 'error'); return;
  }

  const sbUser = data.user;
  const profile = await sbGetProfile(sbUser.id);
  const user = profileToUser(sbUser, profile);
  await _loginUserFinalize(user);
}

function requestOTP() {
  const email = document.getElementById('loginEmail').value.trim();
  if(!email) { showToast('Please enter your email first', 'error'); return; }
  document.getElementById('loginStep1').style.display = 'none';
  document.getElementById('loginStep2').style.display = 'block';
  showToast(`OTP sent to ${email} (Demo: 123456)`, 'success');
}

function showLoginStep1() {
  document.getElementById('loginStep1').style.display = 'block';
  document.getElementById('loginStep2').style.display = 'none';
}

function verifyOTP() {
  const boxes = document.querySelectorAll('.otp-box');
  const otp = Array.from(boxes).map(b => b.value).join('');
  if(otp === '123456') {
    const email = document.getElementById('loginEmail').value.trim() || 'user@mediscan.ai';
    let users = JSON.parse(localStorage.getItem('medi_users') || '[]');
    let user = users.find(u => u.email === email);
    if(!user) user = { id:Date.now(), name:'OTP User', email, role:'user', age:25, allergies:'', conditions:'' };
    loginUser(user);
    showToast('OTP verified! Welcome back üëã', 'success');
  } else {
    showToast('Invalid OTP. Demo OTP is 123456', 'error');
  }
}

function otpNext(el, idx) {
  if(el.value.length === 1) {
    const boxes = document.querySelectorAll('.otp-box');
    if(idx < 5) boxes[idx+1].focus();
  }
}

/** Internal: finalize login ‚Äî load scans/saved from Supabase, update UI */
async function _loginUserFinalize(user) {
  if(user.age && !user.ageGroup) user.ageGroup = deriveAgeGroup(user.age);
  state.user = user;

  // Load user's data from Supabase (skip for demo/admin shortcut users)
  if(user.id !== 'demo' && user.id !== 'admin') {
    const [scans, saved] = await Promise.all([
      sbLoadScans(user.id),
      sbLoadSaved(user.id),
    ]);
    state.scans = scans.map(s => ({
      id:        s.id,
      medicine:  s.medicine,
      timestamp: new Date(s.created_at).toLocaleString('en-IN'),
      source:    s.source || 'manual_search',
    }));
    state.saved = saved.map(s => ({
      name:    s.name,
      savedAt: new Date(s.created_at).toLocaleString('en-IN'),
    }));
  } else {
    // Demo data
    state.scans = [
      { id:1, medicine:'Paracetamol', timestamp:'25/02/2025, 10:30 AM', source:'image_upload' },
      { id:2, medicine:'Ibuprofen',   timestamp:'24/02/2025, 3:15 PM',  source:'manual_search' },
      { id:3, medicine:'Amoxicillin', timestamp:'20/02/2025, 8:00 AM',  source:'camera_capture' },
    ];
    state.saved = [
      { name:'Paracetamol', savedAt:'25/02/2025, 10:35 AM' },
      { name:'Omeprazole',  savedAt:'22/02/2025, 9:00 PM'  },
    ];
  }

  updateNavForUser(user);
  navigate(user.role === 'admin' ? 'admin' : 'dashboard');
  showToast(`Welcome, ${user.name}! üéâ`, 'success');
}

// Keep original loginUser as thin wrapper for backward compat
async function loginUser(user) {
  await _loginUserFinalize(user);
}

async function logout() {
  await _sb.auth.signOut();
  state.user = null;
  localStorage.removeItem('medi_token');
  localStorage.removeItem('medi_current_user');
  document.getElementById('navGuest').style.display = 'flex';
  document.getElementById('navUser').style.display = 'none';
  navigate('home');
  showToast('Logged out successfully', 'success');
}

function updateNavForUser(user) {
  document.getElementById('navGuest').style.display = 'none';
  document.getElementById('navUser').style.display = 'flex';
  const initials = user.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('userAvatar').textContent = initials;
}

function socialAuth(provider) {
  const user = { id:Date.now(), name:`${provider} User`, email:`user@${provider.toLowerCase()}.com`, role:'user', age:25, allergies:'', conditions:'' };
  loginUser(user);
}

// ‚îÄ‚îÄ‚îÄ SCAN TAB SWITCHER ‚îÄ‚îÄ‚îÄ
function switchScanTab(tab) {
  ['image','name','desc','disease'].forEach(t => {
    const tabEl   = document.getElementById('tab-'+t);
    const panelEl = document.getElementById('panel-'+t);
    if(tabEl)   tabEl.classList.toggle('active', t === tab);
    if(panelEl) panelEl.classList.toggle('active', t === tab);
  });
  if(tab !== 'desc') {
    document.getElementById('descResults').classList.remove('active');
    document.getElementById('descLoading').classList.remove('active');
  }
  if(tab === 'disease') initDiseaseTab();
}

function quickSearch(name) {
  document.getElementById('medSearchInput').value = name;
  searchMedicineByName();
}

function fillDesc(text) {
  document.getElementById('descInput').value = text;
  document.getElementById('descInput').focus();
}

function clearDescSearch() {
  document.getElementById('descInput').value = '';
  document.getElementById('descResults').classList.remove('active');
  document.getElementById('descLoading').classList.remove('active');
  document.getElementById('descMatchList').innerHTML = '';
  document.getElementById('descNoResults').style.display = 'none';
  document.getElementById('descAgeGroup').value = '';
  document.getElementById('descCondition').value = '';
  document.getElementById('descCategory').value = '';
}

// ‚îÄ‚îÄ‚îÄ DESCRIPTION-BASED MEDICINE MATCHER ‚îÄ‚îÄ‚îÄ

// Keyword ‚Üí medicine scoring weights
const DESC_KEYWORDS = {
  paracetamol: {
    keywords: ['fever','headache','body pain','temperature','cold','flu','mild pain','safe for children','child fever','paracetamol','acetaminophen','crocin','tylenol','dolo','antipyretic','analgesic','white tablet','500mg','650mg','pain relief','mild','not nsaid'],
    boosts: { child:15, adult:5, elderly:5 },
    penalise: ['diabetes medication','acid','stomach','antibiotic','infection','bacteria','inflammation','joint','arthritis'],
  },
  ibuprofen: {
    keywords: ['inflammation','joint pain','arthritis','menstrual','period pain','muscle pain','sprain','injury','swelling','nsaid','anti-inflammatory','brufen','advil','nurofen','dental','toothache','400mg','200mg','600mg','fever adult','body ache','back pain'],
    boosts: { adult:10, elderly:-5 },
    penalise: ['pregnant','pregnancy','child fever','antibiotic','stomach acid','diabetes'],
  },
  amoxicillin: {
    keywords: ['bacterial infection','throat infection','ear infection','uti','bronchitis','pneumonia','strep','antibiotic','bacteria','amoxicillin','amoxil','not penicillin allergic','chest infection','sinus','sinusitis','250mg','500mg antibiotic'],
    boosts: { adult:5, child:8 },
    penalise: ['penicillin allergy','acid','stomach','diabetes','pain only','fever only'],
  },
  metformin: {
    keywords: ['diabetes','type 2 diabetes','blood sugar','insulin resistance','pcos','glucophage','glycomet','metformin','high blood sugar','glucose','sugar control','antidiabetic','diabetic','hba1c','fasting sugar','taken with food'],
    boosts: { adult:10, elderly:5, diabetes:20 },
    penalise: ['pain','fever','infection','antibiotic','acid','stomach'],
  },
  aspirin: {
    keywords: ['heart','cardiac','blood clot','stroke','antiplatelet','aspirin','ecosprin','disprin','blood thinning','cardiovascular','heart attack prevention','low dose','75mg','325mg','heart disease','artery','platelet'],
    boosts: { adult:10, elderly:12 },
    penalise: ['child','children','under 16','pregnant','pregnancy','stomach ulcer'],
  },
  omeprazole: {
    keywords: ['acid reflux','heartburn','gerd','acidity','stomach acid','peptic ulcer','h pylori','ulcer','omeprazole','omez','prilosec','proton pump','ppi','burning stomach','before food','empty stomach','take before meal','indigestion','gastritis'],
    boosts: { adult:8, elderly:5 },
    penalise: ['antibiotic','diabetes','blood thinning','inflammation','pain only'],
  }
};

// Scoring engine
function scoreDescriptionMatch(description, ageGroup, condition, category) {
  const desc = description.toLowerCase();
  const words = desc.split(/\s+/);
  const results = [];

  // Special flags
  const hasPenicillinAllergy = /penicillin allerg/i.test(desc);
  const isPregnant = /pregnan/i.test(desc) || condition === 'pregnancy';
  const isChild = /child|kid|infant|baby|year.old|paediatric/i.test(desc) || ageGroup === 'child';
  const isDiabetic = /diabet/i.test(desc) || condition === 'diabetes';

  for(const [medKey, cfg] of Object.entries(DESC_KEYWORDS)) {
    const med = MEDICINES[medKey];
    if(!med) continue;

    let score = 0;
    let matchedKeywords = [];
    let reasons = [];

    // Keyword matching
    for(const kw of cfg.keywords) {
      if(desc.includes(kw)) {
        const pts = kw.split(' ').length >= 2 ? 18 : 8; // phrase > single word
        score += pts;
        matchedKeywords.push(kw);
      }
    }

    // Age group boosts
    if(ageGroup && cfg.boosts[ageGroup]) score += cfg.boosts[ageGroup];
    if(isDiabetic && cfg.boosts.diabetes) score += cfg.boosts.diabetes;

    // Penalise if penalise keywords appear
    let penalised = false;
    for(const pk of cfg.penalise) {
      if(desc.includes(pk)) { score -= 20; penalised = true; }
    }

    // Safety logic
    if(hasPenicillinAllergy && medKey === 'amoxicillin') {
      score -= 60;
      reasons.push('‚ö†Ô∏è EXCLUDED: Penicillin allergy detected ‚Äî Amoxicillin is contraindicated');
    }
    if(isPregnant && medKey === 'ibuprofen') {
      score -= 50;
      reasons.push('‚ö†Ô∏è UNSAFE in pregnancy: NSAIDs risk fetal harm');
    }
    if(isChild && medKey === 'aspirin') {
      score -= 60;
      reasons.push('‚ö†Ô∏è UNSAFE for children under 16: Reye syndrome risk');
    }
    if(isPregnant && medKey === 'amoxicillin') {
      score += 10;
      reasons.push('‚úÖ Generally safe in pregnancy (Category B)');
    }

    // Category filter boost
    const catMap = { pain:['paracetamol','ibuprofen','aspirin'], antibiotic:['amoxicillin'], antacid:['omeprazole'], diabetes:['metformin'], cardiac:['aspirin'] };
    if(category && catMap[category]) {
      if(catMap[category].includes(medKey)) score += 25;
      else score -= 10;
    }

    // Build reason string
    if(matchedKeywords.length > 0) {
      const highlighted = matchedKeywords.slice(0,4).join(', ');
      reasons.unshift(`Matched: <strong>${highlighted}</strong>${matchedKeywords.length > 4 ? ` +${matchedKeywords.length-4} more` : ''}`);
    }

    if(score > 0) {
      results.push({ medKey, score, reasons, matchedKeywords, penalised });
    }
  }

  // Sort by score descending
  results.sort((a,b) => b.score - a.score);
  return results;
}

async function searchByDescription() {
  const desc = document.getElementById('descInput').value.trim();
  if(!desc || desc.length < 8) {
    showToast('Please describe your symptoms or medicine in more detail (at least 8 characters)', 'error');
    return;
  }

  const ageGroup   = document.getElementById('descAgeGroup').value;
  const condition  = document.getElementById('descCondition').value;
  const category   = document.getElementById('descCategory').value;

  // Show loading
  document.getElementById('descLoading').classList.add('active');
  document.getElementById('descResults').classList.remove('active');
  document.getElementById('descMatchList').innerHTML = '';
  document.getElementById('descNoResults').style.display = 'none';

  // Simulate AI processing delay
  await sleep(1800);
  document.getElementById('descLoading').classList.remove('active');

  const matches = scoreDescriptionMatch(desc, ageGroup, condition, category);

  if(matches.length === 0) {
    document.getElementById('descResults').classList.add('active');
    document.getElementById('descNoResults').style.display = 'block';
    return;
  }

  // Render results
  renderDescMatches(matches, desc);

  // Save to scan history
  const topMed = MEDICINES[matches[0].medKey];
  if(topMed) {
    const medName = topMed.name + ' (desc)';
    state.scans.unshift({ id: Date.now(), medicine: medName, timestamp: new Date().toLocaleString(), source: 'description' });
    if(state.user && state.user.id !== 'demo' && state.user.id !== 'admin') {
      sbInsertScan(state.user.id, medName, 'description').catch(console.warn);
    }
  }
}

function renderDescMatches(matches, rawDesc) {
  const list = document.getElementById('descMatchList');
  const top = matches.slice(0, 4); // show up to 4 matches

  // Title + badges
  document.getElementById('descResultTitle').textContent = `${top.length} Medicine Match${top.length > 1 ? 'es' : ''} Found`;
  document.getElementById('descResultSubtitle').textContent = `Based on your description ¬∑ Sorted by AI confidence score`;

  const badgeEl = document.getElementById('descResultBadges');
  const ageGroup = document.getElementById('descAgeGroup').value;
  const condition = document.getElementById('descCondition').value;
  badgeEl.innerHTML = (ageGroup ? `<span class="badge badge-rx">${ageGroup}</span>` : '') +
    (condition ? `<span class="badge badge-warning">${condition}</span>` : '');

  list.innerHTML = top.map((match, idx) => {
    const med = MEDICINES[match.medKey];
    if(!med) return '';
    const pct = Math.min(100, Math.round((match.score / 100) * 100));
    const displayPct = Math.max(20, pct);
    const scoreClass = pct >= 60 ? 'score-high' : pct >= 35 ? 'score-med' : 'score-low';
    const scoreLabel = pct >= 60 ? 'Strong' : pct >= 35 ? 'Moderate' : 'Weak';
    const rankLabel = idx === 0 ? 'ü•á Best Match' : idx === 1 ? 'ü•à 2nd Match' : idx === 2 ? 'ü•â 3rd Match' : `#${idx+1}`;
    const isSafe = !match.reasons.some(r => r.includes('UNSAFE') || r.includes('EXCLUDED'));

    const diseaseTags = (med.disease||[]).slice(0,3).map(d => `<span class="tag tag-green" style="font-size:.72rem">${d}</span>`).join('');
    const sePreview = (med.sideEffects?.common||[]).slice(0,3).join(', ');

    return `
    <div class="match-card" onclick="viewMatchedMed('${match.medKey}')">
      <div class="match-card-header">
        <div class="match-info">
          <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;margin-bottom:.3rem">
            <span style="font-size:.72rem;font-weight:700;padding:.2rem .6rem;border-radius:100px;background:var(--primary-light);color:var(--primary)">${rankLabel}</span>
            ${isSafe ? '<span style="font-size:.72rem;font-weight:700;padding:.2rem .6rem;border-radius:100px;background:#f0fdf4;color:#16a34a">‚úÖ Safe Profile</span>' : '<span style="font-size:.72rem;font-weight:700;padding:.2rem .6rem;border-radius:100px;background:#fef2f2;color:#dc2626">‚ö†Ô∏è Alert Exists</span>'}
          </div>
          <div class="match-name">${med.name}</div>
          <div class="match-brand">${med.brand} ¬∑ ${med.category}</div>
          <div class="match-tags" style="margin-top:.6rem">${diseaseTags}</div>
        </div>
        <div class="match-score-wrap">
          <div class="match-score-ring ${scoreClass}">${displayPct}%</div>
          <div class="match-score-lbl">${scoreLabel}</div>
        </div>
      </div>
      <div class="match-card-body">
        <div class="match-why">
          ${match.reasons.slice(0,3).map(r => `<div style="margin-bottom:.3rem">‚Ä¢ ${r}</div>`).join('')}
          ${match.reasons.length === 0 ? `<div>‚Ä¢ Partial keyword overlap with description</div>` : ''}
        </div>
        <div style="display:flex;gap:1rem;margin-top:.8rem;flex-wrap:wrap;font-size:.82rem;color:var(--text-muted)">
          <span>üíä <strong>Dose:</strong> ${med.dosage}</span>
          <span>‚è±Ô∏è <strong>Timing:</strong> ${med.frequency}</span>
          <span>‚ö†Ô∏è <strong>Side effects:</strong> ${sePreview}</span>
        </div>
        <div class="match-actions">
          <button class="btn btn-primary" onclick="event.stopPropagation();viewMatchedMed('${match.medKey}')">üìã Full Details</button>
          <button class="btn btn-accent" onclick="event.stopPropagation();saveMedicine('${med.name}')">üíæ Save</button>
          <button class="btn" style="background:#f1f5f9" onclick="event.stopPropagation();navigate('nearby')">üè• Find Doctor</button>
        </div>
      </div>
    </div>`;
  }).join('');

  document.getElementById('descResults').classList.add('active');
  document.getElementById('descResults').scrollIntoView({ behavior:'smooth', block:'start' });
}

async function viewMatchedMed(medKey) {
  // Show it through the normal medicine result flow with AI check
  const med = MEDICINES[medKey];
  if(!med) return;
  state.currentMed = med;
  state.scans.unshift({ id: Date.now(), medicine: med.name, timestamp: new Date().toLocaleString(), source: 'description' });
  if(state.user && state.user.id !== 'demo' && state.user.id !== 'admin') {
    sbInsertScan(state.user.id, med.name, 'description').catch(console.warn);
  }
  const aiAlert = checkAIAlert(med);
  if(aiAlert) {
    showAIAlert(aiAlert, () => showMedicineResult(med));
  } else {
    showMedicineResult(med);
    document.getElementById('medicineResult').scrollIntoView({ behavior:'smooth' });
  }
}

// ‚îÄ‚îÄ‚îÄ SCANNER ‚îÄ‚îÄ‚îÄ
let cameraStream = null;

function handleFileSelect(e) {
  const file = e.target.files[0];
  if(file) processImageFile(file);
}

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('dropZone').classList.remove('dragging');
  const file = e.dataTransfer.files[0];
  if(file && file.type.startsWith('image/')) processImageFile(file);
}

function processImageFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = document.getElementById('previewImg');
    img.src = e.target.result;
    img.classList.add('active');
    simulateScan('image_upload');
  };
  reader.readAsDataURL(file);
}

async function startCamera() {
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    const video = document.getElementById('cameraFeed');
    video.srcObject = cameraStream;
    video.classList.add('active');
    document.getElementById('startCamBtn').style.display = 'none';
    document.getElementById('captureCamBtn').style.display = 'inline-flex';
    document.getElementById('stopCamBtn').style.display = 'inline-flex';
  } catch(e) {
    showToast('Camera access denied. Please allow camera permissions.', 'error');
  }
}

function capturePhoto() {
  const video = document.getElementById('cameraFeed');
  const canvas = document.getElementById('snapCanvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const img = document.getElementById('previewImg');
  img.src = canvas.toDataURL('image/jpeg');
  img.classList.add('active');
  stopCamera();
  simulateScan('camera_capture');
}

function stopCamera() {
  if(cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
  document.getElementById('cameraFeed').classList.remove('active');
  document.getElementById('startCamBtn').style.display = 'inline-flex';
  document.getElementById('captureCamBtn').style.display = 'none';
  document.getElementById('stopCamBtn').style.display = 'none';
}

function searchMedicineByName() {
  const name = document.getElementById('medSearchInput').value.trim();
  if(!name) { showToast('Please enter a medicine name', 'error'); return; }
  simulateScan('manual_search', name);
}

async function simulateScan(source, searchName = null) {
  const progress = document.getElementById('scanProgress');
  const result = document.getElementById('medicineResult');
  progress.classList.add('active');
  result.classList.remove('active');
  result.innerHTML = '';
  document.getElementById('progressBar').style.width = '0%';

  const steps = [
    { id:'step1', label:'üìÅ Upload', msg:'Uploading image to server...', delay:400, pct:20 },
    { id:'step2', label:'üîç OCR', msg:'Running Tesseract OCR to extract text...', delay:600, pct:40 },
    { id:'step3', label:'üíä Identify', msg:'Matching medicine name from database...', delay:500, pct:60 },
    { id:'step4', label:'üìä Fetch Data', msg:'Fetching data from OpenFDA & MediDB...', delay:600, pct:80 },
    { id:'step5', label:'ü§ñ AI Analysis', msg:'Running AI profile analysis & conflict check...', delay:500, pct:100 },
  ];

  for(let i=0; i<steps.length; i++) {
    const s = steps[i];
    document.getElementById(s.id).className = 'step loading';
    document.getElementById('progressMsg').textContent = s.msg;
    await sleep(s.delay);
    document.getElementById(s.id).className = 'step done';
    document.getElementById('progressBar').style.width = s.pct+'%';
  }

  // Determine which medicine to show
  let medKey = null;
  if(searchName) {
    const q = searchName.toLowerCase().trim();
    // Search by key name, generic name, OR brand names
    medKey = Object.keys(MEDICINES).find(k => {
      const m = MEDICINES[k];
      return k.includes(q) ||
             m.name.toLowerCase().includes(q) ||
             m.brand.toLowerCase().includes(q) ||
             (m.salt && m.salt.toLowerCase().includes(q));
    });
  } else {
    // Simulate OCR detection - randomly pick a medicine
    const keys = Object.keys(MEDICINES);
    medKey = keys[Math.floor(Math.random() * keys.length)];
  }

  if(!medKey) {
    progress.classList.remove('active');
    result.innerHTML = `<div class="alert-box alert-warning" style="margin-top:1rem">‚ö†Ô∏è Medicine "${searchName}" not found in database. Try searching with generic name.</div>`;
    result.classList.add('active');
    return;
  }

  const med = MEDICINES[medKey];
  state.currentMed = med;
  
  // Save to scan history (in-memory + Supabase)
  const scan = { id: Date.now(), medicine: med.name, timestamp: new Date().toLocaleString(), source };
  state.scans.unshift(scan);
  if(state.user && state.user.id !== 'demo' && state.user.id !== 'admin') {
    sbInsertScan(state.user.id, med.name, source).catch(console.warn);
  }

  // AI Profile Check
  await sleep(200);
  progress.classList.remove('active');
  
  const aiAlert = checkAIAlert(med);
  if(aiAlert) {
    showAIAlert(aiAlert, () => showMedicineResult(med));
  } else {
    showMedicineResult(med);
  }
}

function checkAIAlert(med) {
  if(!state.user) return null;
  const alerts = [];
  const conditions = (state.user.conditions || '').toLowerCase();
  const allergies  = (state.user.allergies  || '').toLowerCase();
  const userAge    = state.user.age || null;
  const userGroup  = state.user.ageGroup || deriveAgeGroup(userAge);
  const medNameLow = med.name.toLowerCase();

  // Penicillin allergy ‚Üí any penicillin-class antibiotic
  if(allergies.includes('penicillin') && (medNameLow.includes('amoxicillin') || medNameLow.includes('ampicillin') || (med.category||'').toLowerCase().includes('penicillin'))) {
    alerts.push({ type:'danger', title:'üö® ALLERGY ALERT!',
      msg:`Your profile shows a Penicillin allergy. ${med.name} belongs to the Penicillin class ‚Äî risk of severe anaphylaxis.`,
      detail:'Do NOT take this medicine. Consult your doctor for a safe alternative (e.g. Azithromycin, Clarithromycin).'
    });
  }
  // Sulfa allergy
  if(allergies.includes('sulfa') && (medNameLow.includes('sulfamethoxazole') || medNameLow.includes('trimethoprim'))) {
    alerts.push({ type:'danger', title:'üö® Sulfa Allergy Alert!',
      msg:`Sulfa allergy detected. ${med.name} may cause a severe reaction.`,
      detail:'Seek alternative antibiotics. Consult doctor immediately.'
    });
  }
  // Aspirin / NSAIDs age check
  if(userAge && userAge < 16 && (medNameLow.includes('aspirin') || medNameLow.includes('ecosprin') || medNameLow.includes('disprin'))) {
    alerts.push({ type:'danger', title:'üö® Age Warning ‚Äî Reye Syndrome Risk!',
      msg:`Aspirin is contraindicated for patients under 16 years. Patient age: ${userAge}.`,
      detail:'Use Paracetamol as the safer alternative for fever/pain in children.'
    });
  }
  // Diabetes + unsafe medicine
  if(conditions.includes('diabetes') && med.who && med.who.diabetes && !med.who.diabetes.ok) {
    alerts.push({ type:'warning', title:'‚ö†Ô∏è Diabetes Caution',
      msg:`You have Diabetes in your profile. ${med.name} requires special monitoring.`,
      detail: med.who.diabetes.note || 'Monitor blood glucose closely. Consult your doctor.'
    });
  }
  // Pregnancy check
  if(conditions.includes('pregnan') && med.who && med.who.pregnant && !med.who.pregnant.ok) {
    alerts.push({ type:'danger', title:'üö® Pregnancy Warning!',
      msg:`${med.name} is flagged unsafe or requires caution during pregnancy.`,
      detail: med.who.pregnant.note || 'Consult your OB-GYN before taking this medicine.'
    });
  }
  // Age group unsafe check from ageDoses
  if(userGroup && med.ageDoses && med.ageDoses[userGroup] && !med.ageDoses[userGroup].safe) {
    const already = alerts.find(a => a.title.includes('Age') || a.title.includes('Reye'));
    if(!already) {
      alerts.push({ type:'warning', title:`‚ö†Ô∏è Not Recommended for ${userGroup.charAt(0).toUpperCase()+userGroup.slice(1)}s`,
        msg:`${med.name} has usage restrictions for your age group (${med.ageDoses[userGroup].icon} ${userGroup}).`,
        detail: med.ageDoses[userGroup].note || 'Consult your doctor for age-appropriate dosing.'
      });
    }
  }

  return alerts.length > 0 ? alerts[0] : null;
}

function showAIAlert(alert, callback) {
  document.getElementById('aiAlertIcon').textContent = alert.type === 'danger' ? 'üö®' : '‚ö†Ô∏è';
  document.getElementById('aiAlertTitle').textContent = alert.title;
  document.getElementById('aiAlertMsg').textContent = alert.msg;
  const detail = document.getElementById('aiAlertDetail');
  detail.textContent = alert.detail;
  detail.className = `alert-box alert-${alert.type}`;
  detail.style.display = 'block';
  document.getElementById('aiAlertOverlay').classList.add('active');
  window._aiAlertCallback = callback;
}

function closeAiAlert(proceed) {
  document.getElementById('aiAlertOverlay').classList.remove('active');
  if(proceed && window._aiAlertCallback) window._aiAlertCallback();
}

function showMedicineResult(med) {
  const result = document.getElementById('medicineResult');

  // ‚îÄ‚îÄ Determine user's age group ‚îÄ‚îÄ
  const userAge   = state.user ? (state.user.age || null) : null;
  const userGroup = state.user ? (state.user.ageGroup || deriveAgeGroup(userAge)) : null;
  const myDoseInfo = (userGroup && med.ageDoses) ? med.ageDoses[userGroup] : null;

  // ‚îÄ‚îÄ Age group labels/icons for all rows ‚îÄ‚îÄ
  const ageGroupOrder = ['infant','child','teen','adult','elderly'];
  const ageGroupMeta  = {
    infant:  { label:'üë∂ Infant (0‚Äì2 yrs)',    short:'Infant' },
    child:   { label:'üßí Child (2‚Äì11 yrs)',    short:'Child' },
    teen:    { label:'üßë Teen (12‚Äì17 yrs)',    short:'Teen' },
    adult:   { label:'üë® Adult (18‚Äì59 yrs)',   short:'Adult' },
    elderly: { label:'üë¥ Elderly (60+ yrs)',   short:'Elderly' },
  };

  // ‚îÄ‚îÄ Build personalised dosage banner ‚îÄ‚îÄ
  let myDoseBanner = '';
  if(myDoseInfo && state.user) {
    const safeBg  = myDoseInfo.safe ? 'linear-gradient(135deg,#0066CC,#0099FF)' : 'linear-gradient(135deg,#dc2626,#ef4444)';
    const safeIco = myDoseInfo.safe ? '' : '‚ö†Ô∏è ';
    myDoseBanner = `
    <div class="my-dose-card" style="background:${safeBg}">
      <div class="my-dose-icon">${myDoseInfo.icon}</div>
      <div class="my-dose-info" style="flex:1">
        <h4>${safeIco}Your Personalised Dosage ‚Äî ${ageGroupMeta[userGroup]?.label || userGroup}</h4>
        <div class="dose-val">${myDoseInfo.dose}</div>
        <div class="dose-sub">üìÖ Frequency: ${myDoseInfo.freq} &nbsp;|&nbsp; üî¢ Max: ${myDoseInfo.max}</div>
        <div class="my-dose-badges">
          <span class="my-dose-badge">üéÇ Age ${userAge || '?'}</span>
          <span class="my-dose-badge">${myDoseInfo.note}</span>
        </div>
      </div>
    </div>`;
  } else if(state.user) {
    myDoseBanner = `<div class="alert-box alert-info" style="margin-bottom:1.2rem">üí° Update your <strong>Date of Birth</strong> in your profile to see your personalised dosage.</div>`;
  } else {
    myDoseBanner = `<div class="alert-box alert-info" style="margin-bottom:1.2rem">üîê <strong><a onclick="navigate('login')" style="color:var(--primary);cursor:pointer">Log in</a></strong> to see personalised dosage for your age group.</div>`;
  }

  // ‚îÄ‚îÄ Age indicator strip ‚îÄ‚îÄ
  let ageStrip = '';
  if(myDoseInfo && state.user) {
    if(!myDoseInfo.safe) {
      ageStrip = `<div class="age-indicator-strip" style="background:#fef2f2;border:1px solid #fca5a5">
        <div class="ais-icon">üö®</div>
        <div><strong style="color:#dc2626">Not Recommended for ${ageGroupMeta[userGroup]?.label || userGroup}</strong>
        <span style="color:#dc2626;font-size:.85rem">${myDoseInfo.note}</span></div></div>`;
    } else {
      ageStrip = `<div class="age-indicator-strip" style="background:#f0fdf4;border:1px solid #86efac">
        <div class="ais-icon">‚úÖ</div>
        <div><strong style="color:#16a34a">Safe for ${ageGroupMeta[userGroup]?.label || userGroup}</strong>
        <span style="color:#16a34a;font-size:.85rem;display:block">${myDoseInfo.note}</span></div></div>`;
    }
  }

  // ‚îÄ‚îÄ All-age dosage table ‚îÄ‚îÄ
  const doseRows = ageGroupOrder.map(grp => {
    const d   = med.ageDoses ? med.ageDoses[grp] : null;
    const isMe = grp === userGroup;
    const rowClass = isMe ? 'dose-row-highlight' : '';
    const meMark = isMe ? ' üëà You' : '';
    if(!d) return `<tr class="${rowClass}"><td>${ageGroupMeta[grp].label}${meMark}</td><td colspan="3" style="color:var(--text-muted)">No data</td></tr>`;
    const safeIcon = d.safe ? '‚úÖ' : '‚õî';
    return `<tr class="${rowClass}">
      <td>${d.icon} ${ageGroupMeta[grp].short}${meMark}</td>
      <td><strong>${d.dose}</strong></td>
      <td>${d.freq}</td>
      <td>${safeIcon} ${d.max}</td>
    </tr>`;
  }).join('');

  const whoCards = Object.entries(med.who).map(([key, val]) => {
    const labels = { adults:'Adults', children:'Children', pregnant:'Pregnant Women', elderly:'Elderly (65+)', diabetes:'Diabetic Patients', liver:'Liver Patients' };
    const icons  = { adults:'üë®', children:'üë∂', pregnant:'ü§∞', elderly:'üë¥', diabetes:'ü©∏', liver:'ü´Ä' };
    const bg = val.ok ? '#f0fdf4' : '#fef2f2';
    const border = val.ok ? '#86efac' : '#fca5a5';
    return `<div class="person-card" style="background:${bg};border-color:${border}">
      <div class="person-icon" style="background:${val.ok ? '#d1fae5' : '#fee2e2'}">${icons[key]}</div>
      <div class="person-info"><h4>${val.ok?'‚úÖ':'‚ö†Ô∏è'} ${labels[key]}</h4><p>${val.note}</p></div>
    </div>`;
  }).join('');

  const seCom  = med.sideEffects.common.map(s  => `<div class="se-item se-common"><div class="se-dot"></div>${s}</div>`).join('');
  const seSer  = med.sideEffects.serious.map(s => `<div class="se-item se-serious"><div class="se-dot"></div><strong>${s}</strong></div>`).join('');
  const seRare = med.sideEffects.rare.map(s    => `<div class="se-item se-rare"><div class="se-dot"></div>${s}</div>`).join('');
  const prec   = med.precautions.map(p => `<div class="alert-box alert-warning" style="margin-bottom:.5rem;padding:.6rem .9rem">‚ö†Ô∏è ${p}</div>`).join('');
  const alts   = med.alternatives.map(a => `<span class="tag tag-blue">üíä ${a}</span>`).join('');
  const diseases = med.disease.map(d => `<span class="tag tag-green">ü©∫ ${d}</span>`).join('');

  result.innerHTML = `
    <div class="med-header">
      <div class="med-header-top">
        <div>
          <div class="med-name">${med.name}</div>
          <div class="med-brand">Brand names: ${med.brand}</div>
          <div class="med-badges">
            <span class="badge badge-rx">${med.type}</span>
            <span class="badge badge-otc">${med.category}</span>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:.5rem;align-items:flex-end">
          <button class="btn btn-white" onclick="saveMedicine('${med.name}')" style="font-size:.8rem;padding:.4rem .9rem">üíæ Save</button>
          <button class="btn btn-outline-white" onclick="navigate('nearby')" style="font-size:.8rem;padding:.4rem .9rem">üè• Find Doctors</button>
        </div>
      </div>
      <div class="med-quick">
        <div class="med-quick-item"><div class="val">${med.dosage}</div><div class="key">General Dosage</div></div>
        <div class="med-quick-item"><div class="val">${med.frequency}</div><div class="key">Frequency</div></div>
        <div class="med-quick-item"><div class="val">${med.duration}</div><div class="key">Duration</div></div>
        <div class="med-quick-item"><div class="val">${med.maxDaily}</div><div class="key">Max Daily</div></div>
      </div>
    </div>

    ${myDoseBanner}
    ${ageStrip}
    <div class="alert-box alert-info" style="margin-bottom:1.5rem">‚è∞ <strong>Timing:</strong> ${med.timing} &nbsp;|&nbsp; üíä <strong>Salt:</strong> ${med.salt}</div>

    <div class="info-grid">
      <div class="info-card">
        <h3><div class="ico" style="background:#d1fae5">ü©∫</div> Diseases Treated</h3>
        <div class="tag-list">${diseases}</div>
        <p style="margin-top:.8rem;font-size:.85rem;color:var(--text-muted);line-height:1.6">${med.description}</p>
      </div>

      <div class="info-card" style="grid-column:1/-1">
        <h3><div class="ico" style="background:#fef3c7">üìä</div> Dosage by Age Group</h3>
        <p style="font-size:.8rem;color:var(--text-muted);margin-bottom:.8rem">
          ${userGroup ? `<span style="background:var(--primary-light);color:var(--primary);padding:.2rem .6rem;border-radius:6px;font-weight:700">üëà Highlighted row = your age group (${ageGroupMeta[userGroup]?.label})</span>` : 'Log in to highlight your age group.'}
        </p>
        <div style="overflow-x:auto">
          <table class="dosage-table">
            <thead><tr><th>Age Group</th><th>Dose</th><th>Frequency</th><th>Max / Status</th></tr></thead>
            <tbody>${doseRows}</tbody>
          </table>
        </div>
      </div>

      <div class="info-card">
        <h3><div class="ico" style="background:#e0e7ff">üë•</div> Who Can Take It</h3>
        ${whoCards}
      </div>

      <div class="info-card">
        <h3><div class="ico" style="background:#fee2e2">‚ö†Ô∏è</div> Side Effects</h3>
        <p style="font-size:.78rem;color:var(--text-muted);margin-bottom:.5rem">üü° Common</p>${seCom}
        <p style="font-size:.78rem;color:var(--text-muted);margin:.7rem 0 .5rem">üî¥ Serious</p>${seSer}
        <p style="font-size:.78rem;color:var(--text-muted);margin:.7rem 0 .5rem">‚ö™ Rare</p>${seRare}
      </div>

      <div class="info-card">
        <h3><div class="ico" style="background:#fef3c7">üõ°Ô∏è</div> Precautions & Warnings</h3>
        ${prec}
      </div>

      <div class="info-card" style="grid-column:1/-1">
        <h3><div class="ico" style="background:#d1fae5">üëçüëé</div> Advantages & Disadvantages</h3>
        <div class="adv-disadv-grid">
          <div class="adv-box pros">
            <h4>‚úÖ Advantages</h4>
            ${(med.advantages||[]).map(a=>`<div class="adv-item"><span style="color:#16a34a;font-size:1rem;flex-shrink:0">‚úì</span>${a}</div>`).join('')}
          </div>
          <div class="adv-box cons">
            <h4>‚ö†Ô∏è Disadvantages / Risks</h4>
            ${(med.disadvantages||[]).map(d=>`<div class="adv-item"><span style="color:#dc2626;font-size:1rem;flex-shrink:0">‚úó</span>${d}</div>`).join('')}
          </div>
        </div>
      </div>

      <div class="info-card">
        <h3><div class="ico" style="background:#ede9fe">üîÑ</div> Alternative Medicines</h3>
        <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:.8rem">AI-suggested alternatives based on your profile:</p>
        <div class="tag-list">${alts}</div>
        <div class="alert-box alert-info" style="margin-top:1rem;font-size:.82rem">ü§ñ Always consult your doctor before switching medicines</div>
      </div>
    </div>

    <div class="info-card" style="margin-top:1.5rem">
      <h3><div class="ico" style="background:#fce7f3">üè•</div> Recommended Specialists</h3>
      <p style="color:var(--text-muted);font-size:.9rem">For this medicine, consult: <strong>${med.speciality}</strong></p>
      <button class="btn btn-primary" style="margin-top:1rem" onclick="navigate('nearby')">üîç Find Nearby Doctors ‚Üí</button>
    </div>
  `;
  result.classList.add('active');
  result.scrollIntoView({ behavior:'smooth', block:'start' });
}

// Helper ‚Äî derive age group from numeric age
function deriveAgeGroup(age) {
  if(!age) return 'adult';
  if(age < 2)  return 'infant';
  if(age < 12) return 'child';
  if(age < 18) return 'teen';
  if(age < 60) return 'adult';
  return 'elderly';
}

async function saveMedicine(name) {
  if(!state.user) { showToast('Please login to save medicines', 'error'); navigate('login'); return; }
  if(!state.saved.find(m => m.name === name)) {
    state.saved.push({ name, savedAt: new Date().toLocaleString() });
    if(state.user.id !== 'demo' && state.user.id !== 'admin') {
      sbSaveMedicine(state.user.id, name).catch(console.warn);
    }
  }
  showToast(`${name} saved to your medicines! üíæ`, 'success');
}

// ‚îÄ‚îÄ‚îÄ NEARBY ‚îÄ‚îÄ‚îÄ
let userCoords         = null;
let activeNearbyFilter = 'all';

// ‚îÄ‚îÄ‚îÄ Entry: called by navigate('nearby') ‚Äî do NOT auto-GPS (browser blocks without user gesture) ‚îÄ‚îÄ‚îÄ
function initNearby() {
  // 1. Restore saved coords (from signup or previous visit)
  try {
    const saved = JSON.parse(localStorage.getItem('medi_user_coords') || 'null');
    if (saved && saved.lat && saved.lng) {
      userCoords = { lat: saved.lat, lng: saved.lng };
      applyLocationAndRender(saved.lat, saved.lng, saved.city || '');
      return;
    }
  } catch(e) {}

  // 2. Logged-in user has location from signup
  if (state.user && state.user.lat && state.user.lng) {
    userCoords = { lat: state.user.lat, lng: state.user.lng };
    applyLocationAndRender(state.user.lat, state.user.lng, state.user.city || state.user.location || '');
    return;
  }

  // 3. No saved location ‚Äî show all hospitals without GPS, prompt user to detect
  setDetectBtn('idle');
  renderHospitals('all');
  renderDoctors('all');
  showSection('hospitals');
  updateBadges(null);
}

// ‚îÄ‚îÄ‚îÄ GPS Detect ‚Äî triggered only by user button tap ‚îÄ‚îÄ‚îÄ
function detectAndRender() {
  setDetectBtn('loading');
  setLocationDisplay('‚è≥ Requesting GPS access...');

  if (!navigator.geolocation) {
    setDetectBtn('idle');
    setLocationDisplay('‚ùå GPS not supported in this browser');
    showToast('GPS not supported. Showing all hospitals.', 'error');
    applyLocationAndRender(null, null, '');
    return;
  }

  navigator.geolocation.getCurrentPosition(
    // ‚îÄ‚îÄ SUCCESS ‚îÄ‚îÄ
    function(pos) {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      userCoords = { lat, lng };
      const city = getNearestCity(lat, lng);
      // Save so next visit remembers
      localStorage.setItem('medi_user_coords', JSON.stringify({ lat, lng, city }));
      setDetectBtn('done', city);
      applyLocationAndRender(lat, lng, city);
    },
    // ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ
    function(err) {
      setDetectBtn('idle');
      let msg = 'üìç Location unavailable';
      if (err.code === 1) msg = '‚ùå Location permission denied ‚Äî please allow in browser settings';
      else if (err.code === 2) msg = '‚ùå Location unavailable ‚Äî check device GPS';
      else if (err.code === 3) msg = '‚ùå Location timed out ‚Äî try again';
      setLocationDisplay(msg);
      showToast('Could not get location. Showing all hospitals sorted by name.', 'error');
      applyLocationAndRender(null, null, '');
    },
    { timeout: 12000, enableHighAccuracy: true, maximumAge: 30000 }
  );
}

// ‚îÄ‚îÄ‚îÄ Refresh ‚Äî re-sort and re-render with current coords ‚îÄ‚îÄ‚îÄ
function refreshNearby() {
  const btn = document.getElementById('mapInfoBar')?.querySelector('button');
  if (userCoords) {
    // Already have coords ‚Äî just re-sort and re-render
    applyLocationAndRender(userCoords.lat, userCoords.lng,
      document.getElementById('mapLocationLabel')?.textContent || '');
    showToast('üîÑ Refreshed hospitals list', 'success');
  } else {
    // No coords yet ‚Äî trigger GPS
    detectAndRender();
  }
}

// ‚îÄ‚îÄ‚îÄ Button state helper ‚îÄ‚îÄ‚îÄ
function setDetectBtn(state, city) {
  const btn = document.getElementById('detectGpsBtn');
  if (!btn) return;
  if (state === 'loading') {
    btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:.4rem"><span class="btn-spinner"></span> Locating...</span>';
    btn.disabled = true;
  } else if (state === 'done') {
    btn.innerHTML = '‚úÖ ' + (city || 'Located');
    btn.disabled = false;
    setTimeout(() => { btn.innerHTML = 'üìç Re-detect Location'; btn.disabled = false; }, 3000);
  } else {
    btn.innerHTML = 'üìç Detect My Location';
    btn.disabled = false;
  }
}

// ‚îÄ‚îÄ‚îÄ Location display helper ‚îÄ‚îÄ‚îÄ
function setLocationDisplay(text) {
  const el = document.getElementById('locationDisplay');
  if (el) el.innerHTML = text;
}

// ‚îÄ‚îÄ‚îÄ Alias ‚îÄ‚îÄ‚îÄ
function startNearbyFlow() { detectAndRender(); }
function detectLocation()  { detectAndRender(); }

// ‚îÄ‚îÄ‚îÄ Given coords, sort hospitals by distance and render everything ‚îÄ‚îÄ‚îÄ
function applyLocationAndRender(lat, lng, city) {
  if (lat && lng) {
    // Calculate real distance for every hospital
    HOSPITALS.forEach(h => {
      const d = calcDistance(lat, lng, h.lat, h.lng);
      h._distKm  = d;
      h.distance = d < 1 ? Math.round(d * 1000) + ' m' : d.toFixed(1) + ' km';
    });
    HOSPITALS.sort((a, b) => a._distKm - b._distKm);

    // Calculate real distance for every doctor too
    DOCTORS.forEach(d => {
      const dist = calcDistance(lat, lng, d.lat, d.lng);
      d._distKm  = dist;
      d.distance = dist < 1 ? Math.round(dist * 1000) + ' m' : dist.toFixed(1) + ' km';
    });
    DOCTORS.sort((a, b) => a._distKm - b._distKm);

    setLocationDisplay('üìç ' + (city || (lat.toFixed(4) + ', ' + lng.toFixed(4))));

    // Show banner
    const banner   = document.getElementById('nearbyLocationBanner');
    const bannerTx = document.getElementById('nearbyBannerText');
    if (banner) {
      banner.style.display = 'flex';
      if (bannerTx) bannerTx.textContent = 'üè• Hospitals sorted nearest to you in ' + (city || 'your location');
    }

    // Show map
    showMapEmbed(lat, lng, city);
  } else {
    setLocationDisplay('üìç All hospitals ‚Äî tap Detect to sort by distance');
    const mc = document.getElementById('googleMapContainer');
    const ph = document.getElementById('nearbyPlaceholder');
    if (mc) mc.style.display = 'none';
    if (ph) ph.style.display = 'flex';
  }

  // Update info bar
  const infoBar  = document.getElementById('mapInfoBar');
  const locLabel = document.getElementById('mapLocationLabel');
  if (infoBar)  infoBar.style.display = 'flex';
  if (locLabel) locLabel.textContent  = city || (lat ? lat.toFixed(4) + ', ' + lng.toFixed(4) : 'All locations');

  // Render cards
  renderHospitals('all');
  renderDoctors('all');
  showSection('hospitals');
  updateBadges(lat);

  if (lat) showToast('üè• ' + HOSPITALS.length + ' hospitals near ' + (city || 'you') + ' ‚Äî sorted by distance', 'success');
}

function updateBadges(lat) {
  const gs = document.getElementById('nearbyGpsStatus');
  const hc = document.getElementById('nearbyHospCount');
  const dc = document.getElementById('nearbyDocCount');
  if (gs) gs.innerHTML = lat ? '‚úÖ GPS Active' : 'üìç All areas';
  if (hc) hc.textContent = 'üè• ' + HOSPITALS.length + ' hospitals';
  if (dc) dc.textContent = 'üë®‚Äç‚öïÔ∏è ' + DOCTORS.length + ' doctors';
}

// ‚îÄ‚îÄ‚îÄ Show OpenStreetMap embed (free, no API key) ‚îÄ‚îÄ‚îÄ
function showMapEmbed(lat, lng, city) {
  const mc = document.getElementById('googleMapContainer');
  const ph = document.getElementById('nearbyPlaceholder');
  const el = document.getElementById('googleMapEl');
  if (!mc || !el) return;
  mc.style.display = 'block';
  if (ph) ph.style.display = 'none';

  const delta = 0.04;
  const bbox  = (lng - delta) + ',' + (lat - delta) + ',' + (lng + delta) + ',' + (lat + delta);
  el.innerHTML =
    '<iframe' +
    ' width="100%" height="380"' +
    ' style="border:0;border-radius:16px"' +
    ' loading="lazy" allowfullscreen' +
    ' title="Map"' +
    ' src="https://www.openstreetmap.org/export/embed.html?bbox=' + bbox + '&layer=mapnik&marker=' + lat + '%2C' + lng + '">' +
    '</iframe>' +
    '<div style="position:absolute;bottom:10px;right:12px;z-index:10">' +
    '<a href="https://maps.google.com/maps?q=hospitals+near+' + lat + ',' + lng + '&z=14" target="_blank"' +
    ' style="background:#fff;color:#0066CC;font-size:.73rem;padding:.35rem .75rem;border-radius:8px;text-decoration:none;font-weight:700;box-shadow:0 2px 10px rgba(0,0,0,.2)">' +
    'üó∫Ô∏è Open Google Maps</a>' +
    '</div>';

  const overlay = document.getElementById('mapLoadingOverlay');
  if (overlay) overlay.style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ Render hospital cards ‚îÄ‚îÄ‚îÄ
function renderHospitals(filter) {
  filter = filter || activeNearbyFilter;
  const el = document.getElementById('sectionHospitals');
  if (!el) return;
  let list = HOSPITALS;
  if (filter !== 'all') list = HOSPITALS.filter(h => h.tags && h.tags.includes(filter));
  if (!list.length) {
    el.innerHTML = '<div class="alert-box alert-info">No hospitals found for this filter.</div>';
    return;
  }
  el.innerHTML = list.map((h, i) => {
    const mapsUrl = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(h.name + ' ' + h.city);
    return `<div class="hospital-card">
      <div class="hosp-icon" style="background:${h.bg}">${h.icon}</div>
      <div class="hosp-info" style="flex:1">
        <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
          <h3>${h.name}</h3>
          ${h.emergency ? '<span class="badge" style="background:#fee2e2;color:#dc2626;font-size:.7rem">üö® Emergency</span>' : ''}
          ${h._distKm != null ? `<span class="badge badge-success" style="font-size:.7rem">üìè ${h.distance}</span>` : ''}
        </div>
        <p style="font-size:.81rem;color:var(--text-muted)">${h.type} ¬∑ ${h.city}</p>
        <p style="font-size:.81rem;margin-top:.2rem">üè• ${h.speciality}</p>
        <div class="hosp-meta">
          <span class="hosp-meta-item">üõèÔ∏è ${h.beds} beds</span>
          <span class="hosp-meta-item">‚è∞ ${h.hours}</span>
          <span class="hosp-meta-item" style="color:var(--primary);font-weight:700">üìû ${h.display_phone}</span>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:.4rem;align-items:flex-end;flex-shrink:0">
        <div class="hosp-rating">‚≠ê ${h.rating}</div>
        <button class="btn btn-primary" style="font-size:.77rem;padding:.38rem .85rem" onclick="showCallModal('hospital','${h.id}')">üìû Call</button>
        <a href="${mapsUrl}" target="_blank" class="btn" style="background:#f1f5f9;font-size:.77rem;padding:.38rem .85rem;text-decoration:none">üó∫Ô∏è Directions</a>
        <button class="btn" style="background:var(--primary-light);color:var(--primary);font-size:.77rem;padding:.38rem .85rem" onclick="showAppointModal('hospital','${h.id}')">üìÖ Book</button>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ Render doctor cards ‚îÄ‚îÄ‚îÄ
function renderDoctors(filter) {
  filter = filter || activeNearbyFilter;
  const el = document.getElementById('sectionDoctors');
  if (!el) return;
  let list = DOCTORS;
  if (filter !== 'all') list = DOCTORS.filter(d => d.tags && d.tags.some(t => t.includes(filter) || filter.includes(t)));
  if (!list.length) {
    el.innerHTML = '<div class="alert-box alert-info">No doctors found for this filter.</div>';
    return;
  }
  el.innerHTML = list.map(d => {
    const mapsUrl = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(d.name + ' ' + d.hospital);
    const initials = d.name.split(' ').filter(n => n).slice(1, 3).map(n => n[0]).join('');
    return `<div class="doctor-card">
      <div class="doctor-avatar" style="background:${d.bg}">${initials}</div>
      <div class="doc-info" style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
          <h3 style="font-size:.95rem;margin:0">${d.name}</h3>
          ${d._distKm != null ? `<span class="badge badge-success" style="font-size:.7rem">üìè ${d.distance}</span>` : ''}
        </div>
        <div class="doc-spec" style="margin-top:.2rem">ü©∫ ${d.spec}</div>
        <p style="font-size:.8rem;color:var(--text-muted);margin-top:.2rem">üè• ${d.hospital} ¬∑ ${d.exp} exp</p>
        <div class="doc-meta" style="margin-top:.4rem;flex-wrap:wrap;gap:.3rem">
          <span class="tag tag-blue" style="font-size:.72rem">‚è∞ ${d.available}</span>
          <span class="tag tag-green" style="font-size:.72rem">üí∞ ${d.fee}</span>
          <span style="font-size:.77rem;font-weight:700;color:var(--primary)">üìû ${d.display_phone}</span>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:.4rem;align-items:flex-end;flex-shrink:0">
        <div class="hosp-rating">‚≠ê ${d.rating}</div>
        <button class="btn btn-primary" style="font-size:.77rem;padding:.38rem .85rem" onclick="showCallModal('doctor','${d.id}')">üìû Call</button>
        <a href="${mapsUrl}" target="_blank" class="btn" style="background:#f1f5f9;font-size:.77rem;padding:.38rem .85rem;text-decoration:none">üó∫Ô∏è Directions</a>
        <button class="btn" style="background:var(--primary-light);color:var(--primary);font-size:.77rem;padding:.38rem .85rem" onclick="showAppointModal('doctor','${d.id}')">üìÖ Book</button>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ Tab switcher ‚îÄ‚îÄ‚îÄ
function showSection(sec) {
  const hs = document.getElementById('sectionHospitals');
  const ds = document.getElementById('sectionDoctors');
  const th = document.getElementById('tabHosp');
  const td = document.getElementById('tabDoc');
  if (hs) hs.style.display = sec === 'hospitals' ? 'block' : 'none';
  if (ds) ds.style.display = sec === 'doctors'   ? 'block' : 'none';
  if (th) { th.className = sec === 'hospitals' ? 'btn btn-primary' : 'btn'; th.style.background = sec === 'hospitals' ? '' : '#f1f5f9'; }
  if (td) { td.className = sec === 'doctors'   ? 'btn btn-primary' : 'btn'; td.style.background = sec === 'doctors'   ? '' : '#f1f5f9'; }
}

// ‚îÄ‚îÄ‚îÄ Filter by speciality ‚îÄ‚îÄ‚îÄ
function filterNearby(filter, btn) {
  activeNearbyFilter = filter;
  document.querySelectorAll('.nearby-filter-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (filter === 'doctor') { renderDoctors('all'); showSection('doctors'); return; }
  renderHospitals(filter === 'hospital' ? 'all' : filter);
  showSection('hospitals');
}

// ‚îÄ‚îÄ‚îÄ Nearest city label from INDIAN_CITIES list ‚îÄ‚îÄ‚îÄ
function getNearestCity(lat, lng) {
  let best = INDIAN_CITIES[0], minD = Infinity;
  INDIAN_CITIES.forEach(c => {
    const d = calcDistance(lat, lng, c.lat, c.lng);
    if (d < minD) { minD = d; best = c; }
  });
  return best.name.split(',')[0].trim();
}

// ‚îÄ‚îÄ‚îÄ Clear saved location ‚îÄ‚îÄ‚îÄ
function clearUserLocation() {
  localStorage.removeItem('medi_user_coords');
  if (state.user) { state.user.lat = null; state.user.lng = null; state.user.city = ''; }
  userCoords = null;
  try { document.getElementById('nearbyLocationBanner').style.display = 'none'; } catch(e){}
  try { document.getElementById('googleMapContainer').style.display   = 'none'; } catch(e){}
  try { document.getElementById('nearbyPlaceholder').style.display    = 'flex'; } catch(e){}
  try { document.getElementById('mapInfoBar').style.display           = 'none'; } catch(e){}
  showToast('Location cleared ‚Äî tap Detect My Location to refresh', 'success');
}

// ‚îÄ‚îÄ‚îÄ Open Google Maps ‚îÄ‚îÄ‚îÄ
function openGoogleMapsNearby(query) {
  const q = query || 'hospitals near me';
  if (userCoords) {
    window.open('https://www.google.com/maps/search/' + encodeURIComponent(q) + '/@' + userCoords.lat + ',' + userCoords.lng + ',14z', '_blank');
  } else {
    window.open('https://www.google.com/maps/search/' + encodeURIComponent(q), '_blank');
  }
}

function callHospital(phone) {
  window.location.href = 'tel:' + phone.replace(/[^+\d]/g, '');
}

// ‚îÄ‚îÄ‚îÄ Haversine distance ‚îÄ‚îÄ‚îÄ
function calcDistance(lat1, lng1, lat2, lng2) {
  const R = 6371, toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1), dLng = toRad(lng2 - lng1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// ‚îÄ‚îÄ‚îÄ applyUserCoordsToNearby (compat alias) ‚îÄ‚îÄ‚îÄ
function applyUserCoordsToNearby(lat, lng, city) {
  userCoords = { lat, lng };
  applyLocationAndRender(lat, lng, city);
}

// ‚îÄ‚îÄ‚îÄ CALL MODAL ‚îÄ‚îÄ‚îÄ
function showCallModal(type, id) {
  const entity = type === 'hospital'
    ? HOSPITALS.find(h => h.id === id)
    : DOCTORS.find(d => d.id === id);
  if(!entity) return;

  const isHosp = type === 'hospital';
  document.getElementById('callModalIcon').textContent  = isHosp ? entity.icon : 'üë®‚Äç‚öïÔ∏è';
  document.getElementById('callModalName').textContent  = entity.name;
  document.getElementById('callModalType').textContent  = isHosp
    ? `${entity.type} ¬∑ ${entity.city}`
    : `${entity.spec} ¬∑ ${entity.hospital}`;

  const rows = isHosp ? [
    { lbl:'üìû Phone',     val: entity.display_phone },
    { lbl:'‚è∞ Hours',     val: entity.hours },
    { lbl:'üìç Distance',  val: entity.distance },
    { lbl:'üõèÔ∏è Beds',      val: entity.beds + ' beds' },
    { lbl:'üö® Emergency', val: entity.emergency ? 'Yes ‚Äî 24/7' : 'No' },
    { lbl:'‚≠ê Rating',    val: entity.rating + ' / 5' },
  ] : [
    { lbl:'üìû Phone',    val: entity.display_phone },
    { lbl:'ü©∫ Spec',     val: entity.spec },
    { lbl:'üè• Hospital', val: entity.hospital },
    { lbl:'‚è∞ Available',val: entity.available },
    { lbl:'üí∞ Fee',      val: entity.fee },
    { lbl:'‚≠ê Rating',   val: entity.rating + ' / 5' },
  ];

  document.getElementById('callModalDetails').innerHTML = rows.map(r =>
    `<div class="call-detail-row">
      <span class="lbl">${r.lbl}</span>
      <span class="val">${r.val}</span>
    </div>`
  ).join('');

  // Wire up the call button with real number
  const callBtn = document.getElementById('callModalBtn');
  callBtn.href = `tel:${entity.phone}`;
  callBtn.textContent = `üìû Call ${entity.display_phone}`;

  document.getElementById('callModal').classList.add('active');
}

function closeCallModal() {
  document.getElementById('callModal').classList.remove('active');
}

// ‚îÄ‚îÄ‚îÄ APPOINTMENT MODAL ‚îÄ‚îÄ‚îÄ
let _apptEntity = null;
let _apptType   = null;
let _selectedSlot = null;

function showAppointModal(type, id) {
  const entity = type === 'hospital'
    ? HOSPITALS.find(h => h.id === id)
    : DOCTORS.find(d => d.id === id);
  if(!entity) return;
  _apptEntity = entity;
  _apptType   = type;
  _selectedSlot = null;

  const isHosp = type === 'hospital';
  document.getElementById('apptAvatar').textContent    = isHosp ? entity.icon : 'üë®‚Äç‚öïÔ∏è';
  document.getElementById('apptAvatar').style.background = entity.bg || '#e0f2fe';
  document.getElementById('apptTitle').textContent     = `Book Appointment ‚Äî ${entity.name}`;
  document.getElementById('apptSubtitle').textContent  = isHosp
    ? `${entity.speciality} ¬∑ ${entity.city}`
    : `${entity.spec} ¬∑ ${entity.hospital} ¬∑ Fee: ${entity.fee}`;

  // Show availability info
  document.getElementById('apptSlots').innerHTML = isHosp
    ? `<div style="background:#f0f6ff;border-radius:10px;padding:.8rem 1rem;font-size:.83rem;margin-bottom:.4rem">
        <span style="font-weight:700;color:var(--primary)">‚è∞ Open Hours:</span> ${entity.hours}
        ${entity.emergency ? ' &nbsp;|&nbsp; üö® 24/7 Emergency available' : ''}
       </div>`
    : `<div style="background:#f0f6ff;border-radius:10px;padding:.8rem 1rem;font-size:.83rem;margin-bottom:.4rem">
        <span style="font-weight:700;color:var(--primary)">‚è∞ Available:</span> ${entity.available}
       </div>`;

  // Generate time slots for next available day
  const slots = ['9:00 AM','9:30 AM','10:00 AM','10:30 AM','11:00 AM','11:30 AM',
                  '2:00 PM','2:30 PM','3:00 PM','3:30 PM','4:00 PM','4:30 PM','5:00 PM'];
  // Randomly mark a few as unavailable for realism
  const unavailable = new Set([slots[2], slots[5], slots[9]]);
  document.getElementById('apptTimeSlots').innerHTML = slots.map(s =>
    `<button class="time-slot ${unavailable.has(s)?'unavailable':''}"
      onclick="${unavailable.has(s)?'':'selectTimeSlot(this)'}"
      data-slot="${s}">${s}</button>`
  ).join('');

  // Pre-fill user info if logged in
  if(state.user) {
    document.getElementById('apptPatientName').value = state.user.name || '';
    document.getElementById('apptPhone').value       = state.user.phone || '';
  }

  // Set min date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('apptDate').min   = today;
  document.getElementById('apptDate').value = today;

  document.getElementById('appointModal').classList.add('active');
}

function selectTimeSlot(el) {
  document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  _selectedSlot = el.dataset.slot;
}

function closeAppointModal() {
  document.getElementById('appointModal').classList.remove('active');
  _apptEntity = null; _apptType = null; _selectedSlot = null;
}

async function confirmAppointment() {
  const name   = document.getElementById('apptPatientName').value.trim();
  const phone  = document.getElementById('apptPhone').value.trim();
  const date   = document.getElementById('apptDate').value;
  const reason = document.getElementById('apptReason').value.trim() || 'General consultation';

  if(!name)         { showToast('Please enter your name', 'error'); return; }
  if(!phone)        { showToast('Please enter your contact number', 'error'); return; }
  if(!date)         { showToast('Please select a date', 'error'); return; }
  if(!_selectedSlot){ showToast('Please select a time slot', 'error'); return; }
  if(!_apptEntity)  return;

  // Format date nicely
  const dateObj  = new Date(date);
  const dateStr  = dateObj.toLocaleDateString('en-IN', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
  const refNo    = 'MED' + Math.random().toString(36).substr(2,7).toUpperCase();
  const isHosp   = _apptType === 'hospital';

  // Save to Supabase (and localStorage as cache)
  const aptRecord = {
    ref: refNo, type: _apptType, name: _apptEntity.name,
    patient: name, phone, date, slot: _selectedSlot, reason,
    bookedAt: new Date().toISOString()
  };
  if(state.user && state.user.id !== 'demo' && state.user.id !== 'admin') {
    await sbInsertAppointment({
      user_id:    state.user.id,
      ref_no:     refNo,
      entity_type: _apptType,
      entity_name: _apptEntity.name,
      patient_name: name,
      phone, date,
      slot: _selectedSlot,
      reason,
    });
  }
  const appts = JSON.parse(localStorage.getItem('medi_appointments') || '[]');
  appts.push(aptRecord);
  localStorage.setItem('medi_appointments', JSON.stringify(appts));

  // Show confirmation
  document.getElementById('appointModal').classList.remove('active');
  document.getElementById('apptConfirmedDetails').innerHTML = `
    <div style="display:flex;flex-direction:column;gap:.4rem">
      <div>üîñ <strong>Ref No:</strong> ${refNo}</div>
      <div>${isHosp?'üè•':'üë®‚Äç‚öïÔ∏è'} <strong>${isHosp?'Hospital':'Doctor'}:</strong> ${_apptEntity.name}</div>
      ${!isHosp ? `<div>ü©∫ <strong>Speciality:</strong> ${_apptEntity.spec}</div>` : ''}
      <div>üë§ <strong>Patient:</strong> ${name}</div>
      <div>üìû <strong>Contact:</strong> ${phone}</div>
      <div>üìÖ <strong>Date:</strong> ${dateStr}</div>
      <div>üïê <strong>Time:</strong> ${_selectedSlot}</div>
      <div>ü©∫ <strong>Reason:</strong> ${reason}</div>
      <div>üìç <strong>Location:</strong> ${isHosp ? _apptEntity.city : _apptEntity.hospital}</div>
    </div>`;

  setTimeout(() => {
    document.getElementById('apptConfirmedModal').classList.add('active');
  }, 200);

  showToast(`Appointment confirmed with ${_apptEntity.name}! Ref: ${refNo} üéâ`, 'success');
  _apptEntity = null; _apptType = null; _selectedSlot = null;
}

// ‚îÄ‚îÄ‚îÄ DISEASE SEARCH (Scanner Tab 4) ‚îÄ‚îÄ‚îÄ
function initDiseaseTab() {
  const container = document.getElementById('diseaseChips');
  if(!container || container.children.length > 0) return;
  container.innerHTML = Object.entries(DISEASES).map(([key, d]) => `
    <span class="disease-chip" id="dchip-${key}"
      style="color:${d.color};border-color:${d.color}20;background:${d.color}10"
      onclick="selectDiseaseChip('${key}')">
      ${d.icon} ${d.label}
    </span>`).join('');
}

function filterDiseaseChips(query) {
  const q = query.toLowerCase();
  document.querySelectorAll('.disease-chip').forEach(chip => {
    chip.style.display = chip.textContent.toLowerCase().includes(q) ? 'inline-flex' : 'none';
  });
}

function selectDiseaseChip(key) {
  // Deselect others
  document.querySelectorAll('.disease-chip').forEach(c => {
    c.classList.remove('selected');
    const d = DISEASES[c.id.replace('dchip-','')];
    if(d) { c.style.background = `${d.color}10`; c.style.color = d.color; }
  });
  // Select this
  const chip = document.getElementById('dchip-'+key);
  const d = DISEASES[key];
  if(chip && d) {
    chip.classList.add('selected');
    chip.style.background = d.color;
    chip.style.color = '#fff';
  }
  document.getElementById('diseaseSearchInput').value = d ? d.label : key;
  showDiseaseResult(key);
}

function searchByDisease() {
  const q = document.getElementById('diseaseSearchInput').value.toLowerCase().trim();
  if(!q) { showToast('Please enter or select a disease', 'error'); return; }
  // Find best match
  let bestKey = null;
  for(const [key, d] of Object.entries(DISEASES)) {
    if(key.includes(q) || d.label.toLowerCase().includes(q) || q.includes(key)) {
      bestKey = key; break;
    }
  }
  if(bestKey) {
    selectDiseaseChip(bestKey);
  } else {
    // Fallback to desc search
    document.getElementById('descInput').value = q;
    switchScanTab('desc');
    searchByDescription();
    showToast(`No exact disease match ‚Äî running AI symptom analysis for "${q}"`, 'info');
  }
}

function showDiseaseResult(diseaseKey) {
  const d = DISEASES[diseaseKey];
  if(!d) return;

  // Get medicines for this disease
  const meds = d.medicines.map(key => MEDICINES[key]).filter(Boolean);
  // Filter relevant hospitals/doctors
  const relDoctors = DOCTORS.filter(doc => doc.tags.some(t => t.includes(diseaseKey) || diseaseKey.includes(t) || d.specialists.some(s => s.toLowerCase().includes(doc.spec.toLowerCase().split(' ')[0].toLowerCase())))).slice(0,3);
  const relHospitals = HOSPITALS.filter(h => h.tags.some(t => t.includes(diseaseKey) || diseaseKey.includes(t))).slice(0,3);

  const medCards = meds.map(m => `
    <div style="background:var(--primary-light);border-radius:12px;padding:.9rem 1rem;border:1px solid #bfdbfe;display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap;cursor:pointer" onclick="viewMatchedMed('${Object.keys(MEDICINES).find(k=>MEDICINES[k]===m)}')">
      <div>
        <div style="font-weight:800;font-size:.95rem;color:var(--primary)">üíä ${m.name}</div>
        <div style="font-size:.78rem;color:var(--text-muted)">${m.brand} ¬∑ ${m.dosage} ¬∑ ${m.frequency}</div>
      </div>
      <div style="display:flex;gap:.4rem;flex-wrap:wrap">
        <span class="badge badge-rx">${m.type}</span>
        <button class="btn btn-primary" style="font-size:.75rem;padding:.3rem .7rem">View Details ‚Üí</button>
      </div>
    </div>`).join('');

  const doctorCards = relDoctors.length ? relDoctors.map(doc => `
    <div style="display:flex;align-items:center;gap:.8rem;padding:.7rem;background:#f8fafc;border-radius:10px;border:1px solid var(--border)">
      <div style="width:40px;height:40px;border-radius:50%;background:${doc.bg};color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;flex-shrink:0">${doc.name.split(' ').slice(1).map(n=>n[0]).join('').slice(0,2)}</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:.88rem">${doc.name}</div>
        <div style="font-size:.75rem;color:var(--text-muted)">${doc.spec} ¬∑ ${doc.hospital}</div>
        <div style="font-size:.75rem;color:var(--primary);font-weight:600">üìû ${doc.display_phone}</div>
      </div>
      <a href="tel:${doc.phone}" class="btn btn-primary" style="font-size:.73rem;padding:.3rem .7rem;text-decoration:none;flex-shrink:0" onclick="event.preventDefault();showCallModal('doctor','${doc.id}')">üìû Call</a>
    </div>`).join('') : '<p style="color:var(--text-muted);font-size:.85rem">Browse all doctors in the Nearby tab.</p>';

  const hospCards = relHospitals.length ? relHospitals.map(h => `
    <div style="display:flex;align-items:center;gap:.8rem;padding:.7rem;background:#f8fafc;border-radius:10px;border:1px solid var(--border)">
      <div style="font-size:1.6rem;flex-shrink:0">${h.icon}</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:.88rem">${h.name}</div>
        <div style="font-size:.75rem;color:var(--text-muted)">${h.type} ¬∑ ${h.distance}</div>
        <div style="font-size:.75rem;color:var(--primary);font-weight:600">üìû ${h.display_phone}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:.3rem;flex-shrink:0">
        <a href="tel:${h.phone}" class="btn btn-primary" style="font-size:.73rem;padding:.3rem .7rem;text-decoration:none" onclick="event.preventDefault();showCallModal('hospital','${h.id}')">üìû Call</a>
        <button class="btn" style="background:#f1f5f9;font-size:.73rem;padding:.3rem .7rem" onclick="openGoogleMapsNearby('${h.name}')">üó∫Ô∏è Directions</button>
        <button class="btn" style="background:var(--primary-light);color:var(--primary);font-size:.73rem;padding:.3rem .7rem" onclick="showAppointModal('hospital','${h.id}')">üìÖ Book</button>
      </div>
    </div>`).join('') : '<p style="color:var(--text-muted);font-size:.85rem">Browse all hospitals in the Nearby tab.</p>';

  const resultEl = document.getElementById('diseaseResult');
  resultEl.style.display = 'block';
  resultEl.innerHTML = `
    <div class="disease-result-card">
      <div class="disease-result-header" style="background:${d.color}12;border-bottom:1px solid ${d.color}30">
        <div class="disease-icon-big">${d.icon}</div>
        <div>
          <h2 style="font-size:1.2rem;font-weight:800;color:${d.color}">${d.label}</h2>
          <p style="font-size:.82rem;color:var(--text-muted)">Hospital Type: ${d.hospitalType}</p>
          <div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.4rem">
            ${d.specialists.map(s=>`<span class="badge" style="background:${d.color}18;color:${d.color};font-size:.72rem">ü©∫ ${s}</span>`).join('')}
          </div>
        </div>
      </div>
      <div class="disease-result-body">
        <!-- Recommended Medicines -->
        <h3 style="font-size:.95rem;font-weight:700;margin-bottom:.7rem">üíä Recommended Medicines</h3>
        <div style="display:flex;flex-direction:column;gap:.5rem;margin-bottom:1.5rem">${medCards}</div>

        <!-- Nearby Doctors for this disease -->
        <h3 style="font-size:.95rem;font-weight:700;margin-bottom:.7rem">üë®‚Äç‚öïÔ∏è Relevant Doctors Near You</h3>
        <div style="display:flex;flex-direction:column;gap:.5rem;margin-bottom:1.5rem">${doctorCards}</div>

        <!-- Nearby Hospitals -->
        <h3 style="font-size:.95rem;font-weight:700;margin-bottom:.7rem">üè• Nearest Hospitals for Treatment</h3>
        <div style="display:flex;flex-direction:column;gap:.5rem;margin-bottom:1.5rem">${hospCards}</div>

        <div style="display:flex;gap:.7rem;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="navigate('nearby')">üè• View All Hospitals & Doctors</button>
          <button class="btn" style="background:#f1f5f9" onclick="openGoogleMapsNearby('${d.hospitalType} hospital near me')">üó∫Ô∏è Open in Google Maps</button>
        </div>
      </div>
    </div>`;
  resultEl.scrollIntoView({ behavior:'smooth', block:'start' });
}

// ‚îÄ‚îÄ‚îÄ WORD SELECTION TOOLTIP ‚îÄ‚îÄ‚îÄ
let _selTimeout = null;
document.addEventListener('mouseup', () => {
  clearTimeout(_selTimeout);
  _selTimeout = setTimeout(() => {
    const sel = window.getSelection();
    const word = sel ? sel.toString().trim() : '';
    const tip = document.getElementById('selectionTooltip');
    if(word.length >= 2 && word.length <= 60 && !/\n/.test(word)) {
      const range = sel.getRangeAt(0).getBoundingClientRect();
      document.getElementById('selTooltipWord').textContent = `"${word}"`;
      tip.style.display = 'block';
      tip.style.left = `${range.left + range.width/2 - tip.offsetWidth/2}px`;
      tip.style.top  = `${range.top + window.scrollY}px`;
      tip._word = word;
    } else {
      tip.style.display = 'none';
    }
  }, 200);
});

document.addEventListener('mousedown', e => {
  if(!e.target.closest('#selectionTooltip')) document.getElementById('selectionTooltip').style.display = 'none';
});

function searchSelectedWord() {
  const word = document.getElementById('selectionTooltip')._word;
  document.getElementById('selectionTooltip').style.display = 'none';
  if(!word) return;
  document.getElementById('medSearchInput').value = word;
  switchScanTab('name');
  navigate('scanner');
  setTimeout(() => searchMedicineByName(), 150);
}

function searchSelectedWordDisease() {
  const word = document.getElementById('selectionTooltip')._word;
  document.getElementById('selectionTooltip').style.display = 'none';
  if(!word) return;
  switchScanTab('disease');
  navigate('scanner');
  setTimeout(() => {
    document.getElementById('diseaseSearchInput').value = word;
    searchByDisease();
  }, 150);
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ
function initDashboard() {
  if(!state.user) { navigate('login'); return; }
  const u = state.user;
  if(u.age && !u.ageGroup) u.ageGroup = deriveAgeGroup(u.age);
  document.getElementById('sidebarAvatar').textContent = u.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('sidebarName').textContent  = u.name;
  document.getElementById('sidebarEmail').textContent = u.email;
  document.getElementById('dashGreetName').textContent = u.name.split(' ')[0];
  document.getElementById('statScans').textContent = state.scans.length;
  document.getElementById('statMeds').textContent  = state.saved.length;
  const recentEl = document.getElementById('recentScans');
  if(state.scans.length === 0) {
    recentEl.innerHTML = `<p style="color:var(--text-muted);font-size:.88rem">No scans yet. <a onclick="navigate('scanner')" style="color:var(--primary);cursor:pointer">Scan your first medicine ‚Üí</a></p>`;
  } else {
    recentEl.innerHTML = state.scans.slice(0,4).map(s => {
      const mName = s.medicine.replace(/ \(desc\)/,'');
      return `
      <div class="scan-history-item">
        <div class="shi-icon">üíä</div>
        <div class="shi-info"><h4>${s.medicine}</h4><p>${s.timestamp}</p></div>
        <div class="shi-action"><button class="btn" style="background:var(--primary-light);color:var(--primary);font-size:.78rem;padding:.3rem .7rem" onclick="loadSavedMed('${mName}')">View</button></div>
      </div>`;
    }).join('');
  }
  const alertsEl = document.getElementById('aiProfileAlerts');
  let alerts = [];
  if((u.conditions||'').toLowerCase().includes('diabetes')) alerts.push({ type:'warning', msg:'‚ö†Ô∏è Diabetes detected. Some medicines require dose adjustment.' });
  if((u.allergies||'').toLowerCase().includes('penicillin')) alerts.push({ type:'danger', msg:'üö® Penicillin allergy on file. Amoxicillin/Ampicillin will be flagged.' });
  if(u.age && u.age < 18) alerts.push({ type:'info', msg:`‚ÑπÔ∏è Age ${u.age} (${u.ageGroup||'minor'}) ‚Äî child doses and age warnings will show on medicines.` });
  if(u.age && u.age >= 60) alerts.push({ type:'warning', msg:`‚ö†Ô∏è Elderly profile (Age ${u.age}) ‚Äî reduced doses recommended.` });
  if(!u.dob && !u.age) alerts.push({ type:'info', msg:'üí° Add your Date of Birth in Profile for personalised dosage recommendations.' });
  if(alerts.length === 0) alerts.push({ type:'success', msg:'‚úÖ No active AI alerts for your current profile.' });
  alertsEl.innerHTML = alerts.map(a => `<div class="alert-box alert-${a.type}" style="font-size:.84rem">${a.msg}</div>`).join('');
  document.getElementById('statAlerts').textContent = alerts.filter(a=>a.type!=='success').length;
  document.getElementById('profName').value  = u.name  || '';
  document.getElementById('profEmail').value = u.email || '';
  document.getElementById('profPhone').value = u.phone || '';
  document.getElementById('profDob').value   = u.dob   || '';
  document.getElementById('profAge').value   = u.age   || '';
  document.getElementById('profAllergies').value  = u.allergies  || '';
  document.getElementById('profConditions').value = u.conditions || '';
  try { document.getElementById('profGender').value = u.gender || ''; } catch(e){}
  try { document.getElementById('profBlood').value  = u.bloodGroup || ''; } catch(e){}
  renderProfileAgeBanner(u);
}

function updateProfileAge() {
  const dobVal = document.getElementById('profDob').value;
  if(!dobVal) return;
  const dob = new Date(dobVal), today = new Date();
  let age = today.getFullYear() - dob.getFullYear();
  const m = today.getMonth() - dob.getMonth();
  if(m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
  document.getElementById('profAge').value = age;
  if(state.user) { state.user.age = age; state.user.dob = dobVal; state.user.ageGroup = deriveAgeGroup(age); renderProfileAgeBanner(state.user); }
}

function renderProfileAgeBanner(u) {
  const banner = document.getElementById('profileAgeBanner');
  if(!banner) return;
  if(!u || !u.age) { banner.innerHTML = `<div class="alert-box alert-info" style="margin-bottom:0">üéÇ Set your Date of Birth to get personalised age-based dosage recommendations.</div>`; return; }
  const group = u.ageGroup || deriveAgeGroup(u.age);
  const gMap = {
    infant:  { emoji:'üë∂', label:'Infant (0‚Äì2 yrs)',    bg:'#dbeafe', color:'#1d4ed8', desc:'Weight-based dosing only. Liquid formulations required.' },
    child:   { emoji:'üßí', label:'Child (2‚Äì11 yrs)',    bg:'#dbeafe', color:'#1d4ed8', desc:'Dose by weight (mg/kg). Syrup or chewable tablet preferred.' },
    teen:    { emoji:'üßë', label:'Teenager (12‚Äì17 yrs)',bg:'#e0e7ff', color:'#3730a3', desc:'Near-adult dosing. Some adult medicines still restricted.' },
    adult:   { emoji:'üë®', label:'Adult (18‚Äì59 yrs)',   bg:'#d1fae5', color:'#065f46', desc:'Standard adult doses. Full medicine range available.' },
    elderly: { emoji:'üë¥', label:'Elderly (60+ yrs)',   bg:'#fef3c7', color:'#92400e', desc:'Reduced doses. Monitor kidneys, liver, and interactions.' },
  };
  const gd = gMap[group] || gMap.adult;
  banner.innerHTML = `<div style="background:${gd.bg};border-radius:14px;padding:1rem 1.2rem;border:1px solid ${gd.color}40;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem">
    <div style="font-size:2rem">${gd.emoji}</div>
    <div style="flex:1"><div style="font-weight:800;color:${gd.color};font-size:.98rem">${gd.emoji} ${gd.label} ¬∑ Age ${u.age}</div>
    <div style="font-size:.82rem;color:var(--text-muted);margin-top:.15rem">${gd.desc}</div>
    ${u.dob ? `<div style="font-size:.75rem;color:var(--text-muted);margin-top:.15rem">üéÇ DOB: ${u.dob}</div>` : ''}</div>
    <span style="font-size:.72rem;font-weight:700;padding:.35rem .9rem;border-radius:100px;background:${gd.color};color:#fff;text-transform:uppercase">${group}</span></div>`;
}

async function saveProfile() {
  if(!state.user) return;
  state.user.name       = document.getElementById('profName').value;
  state.user.email      = document.getElementById('profEmail').value;
  state.user.phone      = document.getElementById('profPhone').value;
  state.user.dob        = document.getElementById('profDob').value;
  state.user.age        = parseInt(document.getElementById('profAge').value) || state.user.age;
  state.user.ageGroup   = deriveAgeGroup(state.user.age);
  state.user.allergies  = document.getElementById('profAllergies').value;
  state.user.conditions = document.getElementById('profConditions').value;
  try { state.user.gender = document.getElementById('profGender').value; } catch(e){}
  try { state.user.bloodGroup = document.getElementById('profBlood').value; } catch(e){}

  // Persist to Supabase (skip for demo users)
  if(state.user.id !== 'demo' && state.user.id !== 'admin') {
    await sbUpsertProfile(userToProfile(state.user));
  }
  // Also keep localStorage as fallback cache
  localStorage.setItem('medi_current_user', JSON.stringify(state.user));
  renderProfileAgeBanner(state.user);
  showToast('Medical profile updated! üíæ', 'success');
}



// ‚îÄ‚îÄ‚îÄ DASHBOARD TAB SWITCHER ‚îÄ‚îÄ‚îÄ
function showDashTab(tab) {
  ['Overview','History','Saved','Profile'].forEach(t => {
    const el = document.getElementById('dash'+t);
    if(el) el.style.display = t.toLowerCase() === tab ? 'block' : 'none';
  });
  document.querySelectorAll('.sidebar-nav li a').forEach((a,i) => {
    a.classList.remove('active');
    if(['overview','history','saved','profile'][i] === tab) a.classList.add('active');
  });

  if(tab === 'history') {
    const el = document.getElementById('historyList');
    if(!el) return;
    if(state.scans.length === 0) {
      el.innerHTML = '<p style="color:var(--text-muted)">No scan history yet. Try scanning a medicine!</p>';
    } else {
      el.innerHTML = state.scans.map(s => {
        const mName = s.medicine.replace(/ \(desc\)/,'');
        return `
        <div class="scan-history-item">
          <div class="shi-icon">üíä</div>
          <div class="shi-info"><h4>${s.medicine}</h4><p>${s.timestamp} ¬∑ ${s.source}</p></div>
          <button class="btn" style="background:var(--primary-light);color:var(--primary);font-size:.78rem;padding:.3rem .7rem;margin-left:auto"
            onclick="loadSavedMed('${mName}')">View</button>
        </div>`;
      }).join('');
    }
  }
  if(tab === 'saved') {
    const el = document.getElementById('savedList');
    if(!el) return;
    if(state.saved.length === 0) {
      el.innerHTML = '<p style="color:var(--text-muted)">No saved medicines yet. Scan a medicine and click Save!</p>';
    } else {
      el.innerHTML = state.saved.map(s => `
        <div class="scan-history-item">
          <div class="shi-icon">‚≠ê</div>
          <div class="shi-info"><h4>${s.name}</h4><p>Saved: ${s.savedAt}</p></div>
          <button class="btn btn-primary" style="font-size:.78rem;padding:.3rem .7rem;margin-left:auto"
            onclick="loadSavedMed('${s.name}')">View Details</button>
        </div>`).join('');
    }
  }
  if(tab === 'profile') {
    renderProfileAgeBanner(state.user);
  }
}

function loadSavedMed(name) {
  const clean = (name || '').replace(/ \(desc\)/, '').trim();
  switchScanTab('name');
  document.getElementById('medSearchInput').value = clean;
  navigate('scanner');
  setTimeout(() => searchMedicineByName(), 150);
}

// ‚îÄ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ
function initAdmin() {
  renderAdminMeds();
  renderAdminUsers();
}

function renderAdminMeds() {
  const meds = Object.values(MEDICINES);
  const table = document.getElementById('adminMedTable');
  table.innerHTML = `<thead><tr><th>#</th><th>Name</th><th>Type</th><th>Category</th><th>Dosage</th><th>Disease</th><th>Actions</th></tr></thead><tbody>` +
    meds.map((m,i) => `<tr><td>${i+1}</td><td><strong>${m.name}</strong><br><small style="color:var(--text-muted)">${m.brand}</small></td><td><span class="badge badge-rx">${m.type}</span></td><td>${m.category}</td><td>${m.dosage}</td><td>${m.disease.slice(0,2).join(', ')}</td><td><button class="btn btn-accent" style="font-size:.75rem;padding:.3rem .6rem" onclick="loadSavedMed('${m.name}')">View</button></td></tr>`).join('') +
    '</tbody>';
}

async function renderAdminUsers() {
  const users = await sbListUsers();
  const table = document.getElementById('adminUserTable');
  table.innerHTML = `<thead><tr><th>#</th><th>Name</th><th>Email</th><th>Age</th><th>Allergies</th><th>Conditions</th><th>Role</th><th>Joined</th></tr></thead><tbody>` +
    (users.length ? users.map((u,i) => `<tr><td>${i+1}</td><td>${u.name||'-'}</td><td>${u.id.slice(0,8)}‚Ä¶</td><td>${u.age||'-'}</td><td>${u.allergies||'-'}</td><td>${u.conditions||'-'}</td><td><span class="badge badge-success">${u.role||'user'}</span></td><td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : 'N/A'}</td></tr>`).join('') : '<tr><td colspan="8" style="text-align:center;color:var(--text-muted)">No users registered yet</td></tr>') +
    '</tbody>';
}

function showAdminTab(tab) {
  const idMap = { medicines:'adminMedicines', users:'adminUsers', add:'adminAdd' };
  Object.values(idMap).forEach(id => {
    const el = document.getElementById(id);
    if(el) el.style.display = 'none';
  });
  const target = document.getElementById(idMap[tab]);
  if(target) target.style.display = 'block';
}

function addMedicineAdmin() {
  const name = document.getElementById('addMedName').value.trim();
  if(!name) { showToast('Medicine name is required', 'error'); return; }
  showToast(`${name} added to database! ‚úÖ`, 'success');
  document.querySelectorAll('#adminAdd input').forEach(i => i.value = '');
  showAdminTab('medicines');
  renderAdminMeds();
}

// ‚îÄ‚îÄ‚îÄ CHATBOT ‚Äî Powered by Claude AI ‚îÄ‚îÄ‚îÄ
let _chatHistory = [];   // Full conversation history for multi-turn context
let _chatBusy    = false; // Prevent double sends

// System prompt for MediBot
const MEDIBOT_SYSTEM = `You are MediBot, an expert AI medicine and health assistant embedded in the MediScan AI app. You help users understand:
- Medicines: dosages, side effects, composition, interactions, precautions
- Health conditions and which medicines are typically used
- Safe medicines for special groups (pregnancy, children, elderly, diabetes, etc.)
- Drug interactions and warnings
- When to see a doctor

The app has these medicines in its database: Paracetamol, Ibuprofen, Amoxicillin, Metformin, Aspirin, Omeprazole.

Rules:
- Be concise but complete. Use bullet points for lists.
- Always add a disclaimer to consult a doctor for serious conditions.
- Never diagnose. Provide information only.
- Format your response cleanly ‚Äî use **bold** for medicine names, bullet points for lists.
- Keep responses under 200 words unless the user asks for detail.
- Be warm and friendly. You're talking to regular patients, not doctors.

User context (if available): ${JSON.stringify({})}`;

function toggleChatbot() {
  const panel = document.getElementById('chatbotPanel');
  const notif = document.getElementById('chatNotif');
  panel.classList.toggle('open');
  if(panel.classList.contains('open')) {
    if(notif) notif.style.display = 'none';
    setTimeout(() => {
      const input = document.getElementById('chatInput');
      if(input) input.focus();
    }, 200);
  }
}

function clearChat() {
  _chatHistory = [];
  const el = document.getElementById('chatbotMessages');
  el.innerHTML = `
    <div class="cb-msg bot" style="background:linear-gradient(135deg,#f0f6ff,#e8f2ff);border:1px solid #bfdbfe">
      üîÑ Chat cleared! How can I help you?
    </div>
    <div class="cb-quick-replies" id="cbQuickReplies">
      <button class="cb-chip" onclick="sendQuick('What are the side effects of Paracetamol?')">üíä Paracetamol side effects</button>
      <button class="cb-chip" onclick="sendQuick('Is Ibuprofen safe during pregnancy?')">ü§∞ Ibuprofen in pregnancy</button>
      <button class="cb-chip" onclick="sendQuick('What medicines are safe for diabetes?')">ü©∏ Diabetes medicines</button>
      <button class="cb-chip" onclick="sendQuick('How does Metformin work?')">üíâ How Metformin works</button>
      <button class="cb-chip" onclick="sendQuick('What is the difference between Paracetamol and Ibuprofen?')">‚öñÔ∏è Compare medicines</button>
      <button class="cb-chip" onclick="sendQuick('What medicines should I avoid with high blood pressure?')">‚ù§Ô∏è BP safe medicines</button>
    </div>`;
}

function sendQuick(text) {
  const input = document.getElementById('chatInput');
  input.value = text;
  updateSendBtn(text);
  // Hide quick reply chips after first use
  const chips = document.getElementById('cbQuickReplies');
  if(chips) chips.style.display = 'none';
  sendChat();
}

function updateSendBtn(val) {
  const btn = document.getElementById('chatSendBtn');
  if(!btn) return;
  const hasText = val.trim().length > 0;
  btn.disabled = !hasText;
  btn.style.opacity = hasText ? '1' : '.4';
}

async function sendChat() {
  if(_chatBusy) return;
  const input = document.getElementById('chatInput');
  const msg   = (input.value || '').trim();
  if(!msg) return;

  input.value = '';
  updateSendBtn('');

  // Hide quick replies once user starts chatting
  const chips = document.getElementById('cbQuickReplies');
  if(chips) chips.style.display = 'none';

  // Add user message
  addChatMsg(msg, 'user');

  // Add to history
  _chatHistory.push({ role: 'user', content: msg });

  // Show typing indicator
  _chatBusy = true;
  setTyping(true);

  try {
    // Build user context string
    const userCtx = state.user ? `Patient: ${state.user.name}, Age: ${state.user.age || 'unknown'}, Allergies: ${state.user.allergies || 'none'}, Conditions: ${state.user.conditions || 'none'}` : 'User not logged in';
    const system = MEDIBOT_SYSTEM.replace(JSON.stringify({}), JSON.stringify({ user: userCtx }));

    // Call Claude API
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 800,
        system: system,
        messages: _chatHistory,
      })
    });

    if(!response.ok) {
      throw new Error('API error: ' + response.status);
    }

    const data = await response.json();
    const reply = data.content?.[0]?.text || 'Sorry, I could not process that.';

    // Add assistant reply to history
    _chatHistory.push({ role: 'assistant', content: reply });

    setTyping(false);
    addChatMsg(reply, 'bot');

    // Keep history manageable (last 20 messages)
    if(_chatHistory.length > 20) _chatHistory = _chatHistory.slice(-20);

    // Show follow-up quick chips based on topic
    showFollowUpChips(msg, reply);

  } catch(err) {
    setTyping(false);
    // Fallback to local medicine database
    const fallback = getLocalFallback(msg);
    _chatHistory.push({ role: 'assistant', content: fallback });
    addChatMsg(fallback, 'bot');
  }

  _chatBusy = false;
}

// ‚îÄ‚îÄ Local fallback when API unavailable ‚îÄ‚îÄ
function getLocalFallback(msg) {
  const q = msg.toLowerCase();

  // Check medicine database
  for(const [key, med] of Object.entries(MEDICINES)) {
    if(q.includes(key) || q.includes(med.name.toLowerCase())) {
      return `üíä **${med.name}** (${med.brand})\n\n` +
        `‚Ä¢ Used for: ${med.disease.slice(0,3).join(', ')}\n` +
        `‚Ä¢ Dosage: ${med.dosage} ‚Äî ${med.frequency}\n` +
        `‚Ä¢ Common side effects: ${med.sideEffects.common.slice(0,3).join(', ')}\n\n` +
        `‚ö†Ô∏è Always consult your doctor before taking any medicine.`;
    }
  }

  if(q.includes('pregnan')) return 'ü§∞ During pregnancy, **Paracetamol** is generally the safest pain reliever. Avoid Ibuprofen, Aspirin, and most NSAIDs especially after 20 weeks. Always consult your OB-GYN first.';
  if(q.includes('diabet')) return 'ü©∏ For Type 2 diabetes, **Metformin** is the first-line medication. NSAIDs should be used cautiously as they can affect kidney function. Always monitor blood sugar regularly.';
  if(q.includes('fever') || q.includes('pain')) return 'üíä For fever and pain, **Paracetamol** (500mg‚Äì1g every 6-8h) is first choice. **Ibuprofen** works better for inflammation. Take ibuprofen with food to protect the stomach.';
  if(q.includes('antibiotic')) return 'üíä Antibiotics require a prescription. **Amoxicillin** is a common broad-spectrum antibiotic. Always complete the full course. Don\'t share antibiotics or take leftover ones.';
  if(q.includes('side effect')) return '‚ö†Ô∏è Side effects vary by medicine. Common ones include nausea, headache, and stomach upset. For specific side effects, search the medicine in the Scanner tab above.';
  if(q.includes('hospital') || q.includes('doctor')) return 'üè• Use the **Nearby** tab to find hospitals and doctors near you. I\'ll sort them by distance from your location!';
  if(q.includes('dose') || q.includes('dosage')) return 'üìä Dosage depends on the medicine, your age, weight, and condition. Use the **Scanner** tab for precise dosage information. Always follow your doctor\'s prescription.';

  return 'ü§ñ I can help with medicine information, side effects, dosages, and health advice!\n\nüí° Try asking:\n‚Ä¢ "What are the side effects of Paracetamol?"\n‚Ä¢ "Is Ibuprofen safe during pregnancy?"\n‚Ä¢ "What is the dose for Amoxicillin?"';
}

// ‚îÄ‚îÄ Show contextual follow-up chips ‚îÄ‚îÄ
function showFollowUpChips(userMsg, botReply) {
  const q = userMsg.toLowerCase();
  let chips = [];

  if(q.includes('paracetamol')) {
    chips = ['How does Paracetamol work?','Paracetamol vs Ibuprofen','Max dose of Paracetamol per day'];
  } else if(q.includes('ibuprofen')) {
    chips = ['Ibuprofen and kidney safety','Ibuprofen with food?','Alternatives to Ibuprofen'];
  } else if(q.includes('diabet') || q.includes('metformin')) {
    chips = ['Metformin side effects','Can diabetics take Ibuprofen?','Blood sugar and medicines'];
  } else if(q.includes('pregnan')) {
    chips = ['Safe antibiotics in pregnancy','Vitamins during pregnancy'];
  } else if(chips.length === 0 && _chatHistory.length > 2) {
    chips = ['Tell me more','Any drug interactions?','When should I see a doctor?'];
  }

  if(chips.length === 0) return;

  const el = document.getElementById('chatbotMessages');
  const wrap = document.createElement('div');
  wrap.className = 'cb-quick-replies';
  wrap.style.cssText = 'margin-top:.2rem';
  wrap.innerHTML = chips.map(c =>
    `<button class="cb-chip" onclick="sendQuick('${c}')">${c}</button>`
  ).join('');
  el.appendChild(wrap);
  el.scrollTop = el.scrollHeight;
}

// ‚îÄ‚îÄ Add a message bubble ‚îÄ‚îÄ
function addChatMsg(text, type) {
  const el   = document.getElementById('chatbotMessages');
  const div  = document.createElement('div');
  div.className = `cb-msg ${type}`;

  // Render markdown-like formatting for bot messages
  if(type === 'bot') {
    div.innerHTML = formatBotText(text);
  } else {
    div.textContent = text;
  }

  // Timestamp
  const ts = document.createElement('div');
  ts.className = 'cb-timestamp';
  ts.textContent = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });

  const wrap = document.createElement('div');
  wrap.style.cssText = type === 'user' ? 'display:flex;flex-direction:column;align-items:flex-end' : 'display:flex;flex-direction:column;align-items:flex-start';
  wrap.appendChild(div);
  wrap.appendChild(ts);

  el.appendChild(wrap);
  el.scrollTop = el.scrollHeight;
}

// ‚îÄ‚îÄ Format bot response: **bold**, bullet lists, line breaks ‚îÄ‚îÄ
function formatBotText(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/\n‚Ä¢\s/g, '\n‚Ä¢ ')
    .replace(/‚Ä¢\s(.+)/g, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/s, (m) => `<ul>${m}</ul>`)
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>');
}

// ‚îÄ‚îÄ Show/hide typing indicator ‚îÄ‚îÄ
function setTyping(show) {
  const typing = document.getElementById('cbTyping');
  const msgs   = document.getElementById('chatbotMessages');
  if(!typing) return;
  typing.style.display = show ? 'flex' : 'none';
  if(show && msgs) msgs.scrollTop = msgs.scrollHeight;
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function showToast(msg, type='info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  const icons = { success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è' };
  toast.innerHTML = `<span>${icons[type]||'‚ÑπÔ∏è'}</span><span>${msg}</span>`;
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add('removing');
    setTimeout(() => toast.remove(), 300);
  }, 3500);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', async () => {
  // ‚îÄ‚îÄ Restore Supabase session ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const { data: { session } } = await _sb.auth.getSession();
  if(session?.user) {
    try {
      const profile = await sbGetProfile(session.user.id);
      const user = profileToUser(session.user, profile);
      // Silently restore (no toast/navigate) ‚Äî just update nav
      if(user.age && !user.ageGroup) user.ageGroup = deriveAgeGroup(user.age);
      state.user = user;
      const [scans, saved] = await Promise.all([sbLoadScans(user.id), sbLoadSaved(user.id)]);
      state.scans = scans.map(s => ({
        id: s.id, medicine: s.medicine,
        timestamp: new Date(s.created_at).toLocaleString('en-IN'),
        source: s.source || 'manual_search',
      }));
      state.saved = saved.map(s => ({
        name: s.name,
        savedAt: new Date(s.created_at).toLocaleString('en-IN'),
      }));
      updateNavForUser(user);
    } catch(e) { console.warn('Session restore error', e); }
  } else {
    // Fallback: check old localStorage token for demo users
    const token    = localStorage.getItem('medi_token');
    const userData = localStorage.getItem('medi_current_user');
    if(token && userData) {
      try {
        const tokenData = JSON.parse(atob(token));
        if(tokenData.exp > Date.now()) {
          state.user = JSON.parse(userData);
          if(state.user.age && !state.user.ageGroup) {
            state.user.ageGroup = deriveAgeGroup(state.user.age);
          }
          updateNavForUser(state.user);
          // Seed demo data
          state.scans = [
            { id:1, medicine:'Paracetamol', timestamp:'25/02/2025, 10:30 AM', source:'image_upload' },
            { id:2, medicine:'Ibuprofen',   timestamp:'24/02/2025, 3:15 PM',  source:'manual_search' },
            { id:3, medicine:'Amoxicillin', timestamp:'20/02/2025, 8:00 AM',  source:'camera_capture' },
          ];
          state.saved = [
            { name:'Paracetamol', savedAt:'25/02/2025, 10:35 AM' },
            { name:'Omeprazole',  savedAt:'22/02/2025, 9:00 PM'  },
          ];
        }
      } catch(e) { localStorage.removeItem('medi_token'); }
    }
  }

  // Pre-populate scanner demo
  document.getElementById('medSearchInput').value = '';

  // Restore saved user location into userCoords for immediate use
  try {
    const savedCoords = localStorage.getItem('medi_user_coords');
    if(savedCoords) {
      const c = JSON.parse(savedCoords);
      if(c.lat && c.lng) userCoords = { lat: c.lat, lng: c.lng };
    }
  } catch(e) {}
});
</script>
</body>
</html>